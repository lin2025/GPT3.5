<!--	:::Support Chinese-Simplified and English. Change Language in the web page: "Settings" > "Language"  -->
<!--	:::You can search for "Editable" in the code to find the most frequently modified code.   -->
<!--	:::Modifying the default language in the code (change to English): Please search for "Default language" in the code for quick location.   -->
<!--	:::How to add a new language in the code: Please search for "settingsLanguage" and "settingsLanguageOptions" in the code, and then modify them. (When searching, please skip the CSS style part first.)  -->

<!--	:::网页显示报错：打开网页/网站后，对话框和部分按钮显示为{{x.msg}}、{{x.msg}}、{{sentext}}... :::	 -->
<!--		1. 4月23日之前的版本不排除CDN挂掉导致无法加载Vue.js的可能，之后的版本备有国内外3条CDN线路（如果Vue加载失败会弹出提醒） -->
<!--		2. 未提示Vue.js加载失败，说明Vue已成功加载，这种情况还出现错误，说明是因为使用淘汰的浏览器/设备老旧/浏览器多年未更新，不支持当前版本的Vue，请换浏览器或更新浏览器版本。淘汰的浏览器：比如IE11(Internet Explorer 11)。设备老旧：如十年前旧款iPad因无法更新浏览器而导致无法支持新协议、新版Vue  -->
<!--	:::小白如何改代码？ :::	 -->
<!--		小白萌新在编辑代码时搜索“可修改”来查看可以修改的部分。-->
<!--	:::Mac复制网页源码后如何粘贴代码？:::	 -->
<!--		1.打开“文本编辑”App，菜单选“文件”>“新建”，然后菜单选“格式”>“制作纯文本”。  -->
<!--		2.粘贴全部HTML代码。 -->
<!--		3.菜单选“文件”>“存储”，文件名为“index.html”，下拉框“纯文本编码”选“Unicode(UTF-8)”，然后点击存储（保存）。 -->
<!--	:::Mac如何修改扩展名为html的文件？:::	 -->
<!--		1.打开“文本编辑”App，菜单选“文件”>“打开”，找到html文件，单击选中，先别打开。 -->
<!--		2.点击对话框底部的“显示选项”/“选项”，然后打勾选中“忽略多信息文本命令”，现在可以点击“打开”，即可编辑html文件。 -->
<!--	:::Mac电脑:::	 -->
<!--		使用[文本编辑APP]修改网页的，保存时有个[纯文本编码]下拉框，选[Unicode(UTF-8)] -->
<!--	:::Windows电脑:::	 -->
<!--		使用[记事本]来修改网页的，保存时在[编码]下拉框中选[UTF-8]。扩展名如果是.txt，需要改为.html  另外，编辑代码时，建议在菜单栏的“格式”里关闭掉“自动换行” -->
<!--	:::关于文件名:::	 -->
<!--		1.电脑上使用，文件名随意，但扩展名必须是.html  2.如需上传至虚拟主机、服务器、GitHub、Gitee，文件名改为英文，默认主页的文件名为：index.html  -->

<!--	:::欢迎来以下评论区留言交流:::	 -->
<!--		抖音：@林同学不姓林	B站：@林同学不姓林  https://space.bilibili.com/3493262545389917    小站 http://lin2025.gitee.io   -->
<!--		当前版本 v6.09 - 基于v6.07版，小更新。 最新更新 https://github.com/lin2025/gpt3.5/  国内线路：https://gitee.com/lin2025/gpt3.5/   -->


<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<!-- 可修改 Editable - 默认不屏蔽搜索引擎机器人，想屏蔽的请去除注释。 Default allow search engine robots. -->
<!-- <meta name="ROBOTS" content="noindex,nofllow"> -->
<!-- 可修改 Editable - 网页标题 -->
<title>LinGPT - GPT3.5</title>
<meta name="description" content="LinGPT - A GPT-3.5 Webpage with Just a Single HTML File." />
<!-- 网页在手机/平板上的显示比例  默认缩放80%（ initial-scale=0.8 ） -->
<meta name="viewport" content="width=device-width,initial-scale=0.8,minimum-scale=0.5,maximum-scale=2,user-scalable=no,viewport-fit=cover">
<link rel="shortcut icon" href="https://openai.com/favicon.ico">
<!-- 可修改 Editable - iPhone/iPad将网页添加到主屏幕后显示的Logo  默认为ChatGPT的Logo  *小白不需要改。需要传网页到Github/Gitee/静态网页托管平台/主机/服务器的同学，才需要设置。  简单点快速设置：任意格式的正方形图片。  推荐参考设置：png格式 180x180  -->
<link rel="apple-touch-icon" href="https://openai.com/favicon.ico">

<!-- Vue首选CDN(线路1) Vue是一款用于构建用户界面的JavaScript框架，网页常用技术  -->
<!-- 20230520 tips: 不要使用3.2.47的prod版本，会偶尔产生错误，影响使用。 Do not use the prod version of 3.2.47, as I have found it to occasionally produce errors with unknown causes. -->
<!-- 20230603 tips: 使用3.3.4的prod版本两周了，非常稳定，没有再报错，很棒的版本。  I've been using the prod version of 3.3.4 for two weeks now and it has been very stable, without any errors. It's a great version.  -->
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<!-- Vue备选CDN(线路2) 首选CDN失效后，自动加载备选CDN，确保vue的正确加载。 unescape()括号里的是一种编码，转义尖括号(<>)，非乱码。在线解码工具 https://tool.ip138.com/escape/   -->
<script> !window.Vue && document.write(unescape('%3Cscript src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"%3E%3C/script%3E') ) </script>



<!-- 以下为css样式 已压缩，可自行使用工具格式化展开  *压缩后位于末尾的属性会省略掉分号';' -->
<!-- CSS格式化工具1: https://tool.ip138.com/css/ -->
<!-- CSS格式化工具2: http://www.ab173.com/gongju/format/css.php  -->
<style> 

#loading-mask{background-color:#ededed;z-index:900999}
#loading-mask div{text-align:center;font-size:12px;color:#b4b4b4}
body::-webkit-scrollbar{width:7px;height:8px}
body::-webkit-scrollbar-thumb{background-color:#e1e1e1;border-radius:10px}
body::-webkit-scrollbar-thumb:hover{background-color:#cdcdcd}
body::-webkit-scrollbar-track{background-color:#ededed}
body::-webkit-scrollbar-track:hover{background-color:#ededed}
body::-webkit-scrollbar-corner{background-color:#ededed}
body{margin-bottom:0px;margin-top:8px;overflow-y:scroll;background-color:#ededed;font-family:Helvetica Neue,Helvetica,Hiragino Sans GB,"SF Pro SC",Microsoft YaHei,"PingFang SC",Arial,sans-serif}
.bottom-position{height:95px}
.newcontext-hr{height:1px;background-color:#cfcfcf;border:none;width:92%;margin-top:16px;margin-bottom:20px}
.wechatstyle-datetime{display:block;font-size:13px;text-align:center;color:#bbbbbb;margin-top:20px;margin-bottom:17px}
.msgdatetimediv{position:relative}
.usermsg-datetime{font-size:12px;color:#bbbbbb;bottom:auto;left:auto;right:54px;top:-14px;position:absolute}
.aimsg-datetime{font-size:12px;color:#bbbbbb;bottom:auto;left:57px;right:auto;top:-14px;position:absolute}
.userinfo{display:flex;flex-direction:row-reverse;align-items:flex-start;padding-right:2px;margin-top:17px;animation:oneshow 0.8s ease 1}
.usermsg{color:#191919;display:flex;flex-direction:column;justify-content:center;padding:9px 13px;border-radius:6px;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin;margin-right:11px;background-color:#95eb6c}
.aiinfo{display:flex;flex-direction:row;align-items:flex-start;margin-left:7px;margin-top:17px;animation:oneshow 0.8s ease 1}
.aimsg{color:#191919;display:flex;flex-direction:column;justify-content:center;padding:9px 13px;border-radius:6px;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin;margin-left:11px;background-color:#ffffff}
.aiinfo .msgdiv::before{content:"";display:block;position:absolute;border:12px solid transparent;border-right-color:rgba(255,255,255,1);left:-7px;top:8px}
.userinfo .msgdiv::before{content:"";display:block;position:absolute;border:12px solid transparent;border-left-color:#95eb6c;right:-7px;top:8px}
.msgcopydiv{width:auto;max-width:76%}
.chat-img{border-radius:6px;height:2.3rem;width:2.3rem;color:rgba(255,255,255);background-color:#f5f5f5;display:flex;flex-direction:row;justify-content:center;align-items:center}
.chat-img img{height:100%;width:100%;object-fit:cover;border-radius:6px}
.chat-green-svg{background-color:rgb(16,163,127)}
.chat-img-border{box-shadow:0 0 2px 1px rgba(56,82,56,0.3);-webkit-box-shadow:0 0 2px 1px rgba(56,82,56,0.3);-moz-box-shadow:0 0 2px 1px rgba(56,82,56,0.3)}
.chat-img-bg{background-image:radial-gradient(#fff,rgb(245,245,245) 40%,#e6e6e6);background-image:-webkit-radial-gradient(#fff,rgb(245,245,245) 40%,#e6e6e6);background-image:-moz-radial-gradient(#fff,rgb(245,245,245) 40%,#e6e6e6)}
.update-img-size{margin-right:4px !important;height:33px;width:33px}
.flex-column-center{display:flex;flex-direction:column;justify-content:center;align-items:flex-start;position:fixed;bottom:0px;width:100%;left:0px;background-color:#f6f6f6;border-top:0.8px solid #dddddd}
.justify-end{display:flex;flex-direction:row;justify-content:flex-start;align-items:right;bottom:0px}
.panelrow{display:flex;flex-direction:row;justify-content:space-between;align-items:flex-end;width:100%;height:30px}
.dh-input{font-size:14px;color:#191919;width:100%;height:25px;border-radius:6px;padding-left:10px;padding-right:10px;margin-left:10px;margin-right:4px;border:1px solid #DDD;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}
.dh-input:disabled{border:1px solid #DDD;color:#cccccc !important}
.dh-input:read-only{border:1px solid #DDD;color:#cccccc !important}
.textareaSPReadOnly:read-only{color:#555555 !important;background-color:#f5f5f5 !important;overflow:scroll}
input[type=text],input[type=password],textarea{outline:none}
input[type=text]:focus,input[type=password]:focus,textarea:focus{border:1px solid #17a316 !important;box-shadow:inset 0 1px 2px rgba(0,0,0,.075),0 0 5px rgba(81,167,232,.5)}
input:focus{z-index:2}
.btn{display:flex;flex-shrink:0;width:auto;height:25px;align-items:center;justify-content:center;padding:0 10px;margin-right:7px;background-color:#1aad19;border-color:#1aad19;color:#FFF;border-radius:6px;border:none;font-weight:400;font-size:12px;text-decoration:none;text-align:center;line-height:25px;cursor:pointer;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;-webkit-transition-property:all;transition-property:all;-webkit-transition-duration:.3s;transition-duration:.3s}
.btn *,.copybtn *{align-items:center;justify-content:center;display:flex}
.btn:visited,.dropdown:visited{color:#FFF}
.btn:hover,.btn:focus,.dropdown:hover,.dropdown:focus{background-color:#25c524;border-color:#25c524;color:#FFF}
.btn:active,.dropdown:active{background-color:#17a316;border-color:#17a316;color:#8bc220}
.btn:disabled,.dropdown:disabled,.bluebtn:disabled{border:1px solid #DDD !important;background-color:#F5F5F5 !important;color:#1aad19 !important}
.minibtn{width:14px;height:14px;line-height:12px;padding:1px;font-size:12px;flex-shrink:0;display:inline-block;vertical-align:middle;border-radius:50%;margin-bottom:1px !important;transform:scale(0.85);-ms-transform:scale(0.85);-webkit-transform:scale(0.85);-moz-transform:scale(0.85);-o-transform:scale(0.85)}
.minibtn-default{width:auto;height:16px;padding:2px 6px;border-radius:4px}
.bluebtn{background-color:#1ca5c2;border-color:#1ca5c2}
.bluebtn:hover,.bluebtn:focus{background-color:#22b9d9;border-color:#22b9d9;color:#FFF}
.bluebtn:active{background-color:#1ca5c2;border-color:#1ca5c2;color:#7ddbf0}
.redbtn{background-color:#dd3838;border-color:#dd3838;box-shadow:0 0 4px 0 rgba(221,56,56,0.55)}
.redbtn:hover,.redbtn:focus{background-color:#ff4040;border-color:#ff4040;color:#FFF}
.redbtn:active{background-color:#c73737;border-color:#c73737;color:#ffc7ad}
.usermsg *,.aimsg *{margin:0;word-wrap:break-word}
/* white-space:normal去除上下空行（高度）（ blockquote 单独写）+ 列表后排除换行的可能  */
.usermsg ul,.usermsg ol,.aimsg ul,.aimsg ol{white-space:normal;margin:5px 0;padding-left:28px}
.usermsg p,.usermsg span,.aimsg p,.aimsg span{line-height:1.6;margin-top:3px}
/* li: break-all 截断 */
.usermsg li,.aimsg li{word-break:break-all}
/* code 字体 */
.usermsg code,.aimsg code{font-size:12px;font-family:Consolas,Monaco,monospace}
/* 行内代码 除了pre>code之外的代码块 */
.aimsg code:not(pre code){color:#27282c;white-space:pre-wrap;word-break:break-word;margin:0;border-radius:6px;padding:1px 5px;background-color:#efefef}
.usermsg code:not(pre code){color:#27282c;white-space:pre-wrap;word-break:break-word;margin:0;border-radius:6px;padding:1px 5px;background-color:#a9f289}
/* 表格 table code */
.usermsg table code:not(pre code),.aimsg table code:not(pre code){color:#27282c;white-space:pre-wrap;word-break:break-word;margin:0;border-radius:6px;padding:1px 5px;background-color:#e3e3d4}
/* 代码块 */
/* tokyo-night-dark color:#9aa5ce ; */
/* tokyo-night-dark background: #1a1b26; */
/* panda-syntax-dark color:#e6e6e6 ; */
/* panda-syntax-dark background: #2a2c2d; */
.usermsg pre,.aimsg pre{margin:5px 0;width:100%;min-width:100px;white-space:pre;border-radius:6px;box-sizing:border-box;color:#e6e6e6;background:#2a2c2d}
.usermsg pre > code,.aimsg pre > code{display:block;padding:1em;-moz-tab-size:4;tab-size:4;overflow-x:auto;white-space:pre;word-break:normal;scrollbar-width:thin}
.usermsg img:not(.clippy),.aimsg img:not(.clippy){margin:5px 0;max-width:100%}
.usermsg table img,.aimsg table img{max-width:300px}
/* white-space:normal 去除上下空行（高度）*/
.usermsg blockquote{white-space:normal;margin:8px 14px;max-width:100%;color:#373737;border-left:1px solid #6eac4e;padding:0 0 0 8px}
.aimsg blockquote{white-space:normal;margin:8px 14px;max-width:100%;color:#57606a;border-left:1px solid #c8c8c8;padding:0 0 0 8px}
.usermsg blockquote *,.aimsg blockquote *{margin-top:0px;margin-bottom:0px}
.usermsg h1,.usermsg h2,.usermsg h3,.usermsg h4,.usermsg h5,.usermsg h6,.usermsg ul,.usermsg ol,.usermsg blockquote,.usermsg ul p,.usermsg ol p,.usermsg blockquote p,.aimsg h1,.aimsg h2,.aimsg h3,.aimsg h4,.aimsg h5,.aimsg h6,.aimsg ul,.aimsg ol,.aimsg blockquote,.aimsg ul p,.aimsg ol p,.aimsg blockquote p{line-height:1.5}
.usermsg h1,.usermsg h2,.usermsg h3,.usermsg h4,.usermsg h5,.usermsg h6,.aimsg h1,.aimsg h2,.aimsg h3,.aimsg h4,.aimsg h5,.aimsg h6{margin-top:5px}
.usermsg h1,.aimsg h1{font-size:1.4em;margin:0 0 0.5em 0;padding:1em 0 0.5em;border-bottom:1px solid #7dc35a}
.usermsg h2,.aimsg h2{font-size:1.25em;margin:0.5em 0;padding:0.2em 0 0.3em;border-bottom:1px solid #7dc35a}
.aimsg h1{border-bottom:1px solid #b4b4b4}
.aimsg h2{border-bottom:1px solid #b4b4b4}
.usermsg h3,.aimsg h3{font-size:1.125em}
.usermsg h4,.aimsg h4{font-size:1em}
.usermsg h5,.aimsg h5{font-size:.875em}
.usermsg h6{font-size:.85em;color:#373737}
.aimsg h6{font-size:.85em;color:#57606a}
.usermsg hr{height:1px;border:none;background-color:#7dc35a;margin:0.6em 0 0.7em 0}
.aimsg hr{height:1px;border:none;background-color:#b4b4b4;margin:0.6em 0 0.7em 0}
.usermsg table,.aimsg table{margin:5px 0;border-spacing:0;border-collapse:collapse;display:table;max-width:100%;overflow:auto;color:rgb(40,40,40);word-break:break-all}
.usermsg td,.usermsg th,.aimsg td,.aimsg th{padding:0}
.usermsg table th,.aimsg table th{font-weight:600}
.usermsg table th,.usermsg table td,.aimsg table th,.aimsg table td{padding:5px 8px;border:1px solid #e4e6d0}
.usermsg table tr,.aimsg table tr{background-color:#f6f9f1;border-top:1px solid}
.usermsg table tr:nth-child(2n),.aimsg table tr:nth-child(2n){background-color:#edf1e5}
.usermsg table img,.aimsg table img{background-color:transparent}
/* 以下 一键复制相关 pre=snippet, button=copybtn ,svg/img(svg)=clippy */
.clippy{margin:4px;position:relative}
.copybtn[disabled] .clippy{opacity:.3}
.snippet,.msgcopydiv{position:relative;overflow:visible}
.snippet .copybtn,.msgcopydiv .copybtn,.msgcopydiv .copybtn,.panelrow .copybtn,.notification-content .copybtn{-webkit-transition:opacity .3s ease-in-out;-o-transition:opacity .3s ease-in-out;transition:opacity .3s ease-in-out;opacity:0;padding:0;position:absolute;right:4px;top:4px;display:inline-block;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-appearance:none}
.snippet:hover > .copybtn,.snippet > .copybtn:focus,.msgcopydiv:hover > .copybtn,.msgcopydiv > .copybtn:focus{opacity:1}
@media screen and (max-width:768px){
.snippet > .copybtn{opacity:0.4}
.msgcopydiv > .copybtn{}
}
.userinfo > .msgcopydiv{margin-left:30px}
.aiinfo > .msgcopydiv{margin-right:30px}
.userinfo > .msgcopydiv > .copybtn{top:auto;bottom:4px;left:-30px;right:auto}
.aiinfo > .msgcopydiv > .copybtn{top:auto;bottom:4px;left:auto;right:-30px}
/* 以下copybtn (btn) by https://primer.style/css/components/tooltips https://clipboardjs.com/bower_components/primer-css/css/primer.css */
.copybtn:focus{text-decoration:none;border-color:#51a7e8;outline:none;box-shadow:0 0 5px rgba(81,167,232,.5)}
.copybtn:focus:hover,.copybtn.selected:focus{border-color:#51a7e8}
.copybtn:hover,.copybtn:active{text-decoration:none;background-color:#ddd;background-image:linear-gradient(#eee,#ddd);border-color:#ccc}
.copybtn:active,.copybtn.selected{background-color:#dcdcdc;background-image:none;border-color:#b5b5b5;box-shadow:inset 0 2px 4px rgba(0,0,0,.15)}
.copybtn.selected:hover{background-color:#cfcfcf}
.copybtn:disabled,.copybtn:disabled:hover,.copybtn.disabled,.copybtn.disabled:hover{color:rgba(102,102,102,.5);cursor:default;background-color:rgba(229,229,229,.5);background-image:none;border-color:rgba(197,197,197,.5);box-shadow:none}
/* 以上 copybtn (btn)  */
.snippet .tooltipped-w:after{background:#6e7681}
.snippet .tooltipped-w:before{border-left-color:#6e7681}
/* 以下 Tooltips by https://primer.style/css/components/tooltips https://clipboardjs.com/bower_components/primer-css/css/primer.css */
.tooltipped{position:relative}
.tooltipped:after{position:absolute;z-index:1000000;display:none;padding:5px 8px;font:normal normal 11px/1.5 Helvetica,arial,nimbussansl,liberationsans,freesans,clean,sans-serif,"Segoe UI Emoji","Segoe UI Symbol";color:#fff;text-align:center;text-decoration:none;text-shadow:none;text-transform:none;letter-spacing:normal;word-wrap:break-word;white-space:pre;pointer-events:none;content:attr(aria-label);background:rgba(0,0,0,.8);border-radius:3px;-webkit-font-smoothing:subpixel-antialiased}
.tooltipped:before{position:absolute;z-index:1000001;display:none;width:0;height:0;color:rgba(0,0,0,.8);pointer-events:none;content:"";border:5px solid transparent}
.tooltipped:hover:before,.tooltipped:hover:after,.tooltipped:active:before,.tooltipped:active:after,.tooltipped:focus:before,.tooltipped:focus:after{display:inline-block;text-decoration:none}
.tooltipped-n:after,.tooltipped-ne:after,.tooltipped-nw:after{right:50%;bottom:100%;margin-bottom:5px}
.tooltipped-n:before,.tooltipped-ne:before,.tooltipped-nw:before{top:-5px;right:50%;bottom:auto;margin-right:-5px;border-top-color:rgba(0,0,0,.8)}
.tooltipped-ne:after{right:auto;left:50%;margin-left:-15px}
.tooltipped-nw:after{margin-right:-15px}
.tooltipped-n:after{-webkit-transform:translateX(50%);-ms-transform:translateX(50%);transform:translateX(50%)}
.tooltipped-w:after{right:100%;bottom:50%;margin-right:5px;-webkit-transform:translateY(50%);-ms-transform:translateY(50%);transform:translateY(50%)}
.tooltipped-w:before{top:50%;bottom:50%;left:-5px;margin-top:-5px;border-left-color:rgba(0,0,0,.8)}
.tooltipped-e:after{bottom:50%;left:100%;margin-left:5px;-webkit-transform:translateY(50%);-ms-transform:translateY(50%);transform:translateY(50%)}
.tooltipped-e:before{top:50%;right:-5px;bottom:50%;margin-top:-5px;border-right-color:rgba(0,0,0,.8)}
/* 以上 Tooltips */
/* 以上 一键复制相关 */
#app{display:flex;flex-flow:column;margin:1;white-space:pre-wrap}
/* 以下 弹窗 */
.dialog-wrapper{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:900100}
.dialog-wrapper-hide{display:none}
.dialog{width:95%;max-width:800px;height:auto;max-height:82%;overflow:scroll;border-radius:10px;z-index:900101;position:fixed;top:calc(50% - 15px);left:50%;transform:translate(-50%,-50%);background-color:#ededed;box-shadow:0px 0px 10px rgba(0,0,0,0.3)}
.dialog-header{position:relative;height:40px;line-height:40px;padding:0 20px;background-color:#f5f5f5;border-top-left-radius:10px;border-top-right-radius:10px}
.dialog-close{line-height:20px;color:#333333;position:absolute;top:10px;right:10px;width:20px;height:20px;cursor:pointer}
.dialog-title{font-size:14px;line-height:20px;color:#333333;position:absolute;top:10px;align-items:center;justify-content:center;display:flex}
.dialog-content{padding:20px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center}
.dialog-content .btn,.dialog-content .dh-input{margin:0 2px}
.dialog-content .panelrow{height:26px;margin-bottom:4px}
.dialog-content .panelrow >:last-child{margin-right:2px}
.dialog-content .panelgroup{width:100%;box-shadow:0 0 7px 2px rgba(208,208,208,0.6);padding:5px 6px 4px 8px;border-radius:6px;margin-bottom:12px}
.dialog-content .panelgroup-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;padding-bottom:1px;border-bottom:1px solid rgb(220,220,220,0.5)}
.dialog-content .panelgroup-head > span{color:#666666;font-size:12px}
.dialog-content span{font-size:12px;color:#333333;margin-left:4px;line-height:18px}
.dialog-mask{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);z-index:-1}
.control-container{width:auto;margin-right:6px}
.control-bg{padding:2px 5px;width:auto;height:auto;background:#fcfcfc;border-radius:5px;display:flex}
.slider{-webkit-appearance:none !important;-moz-appearance:none;appearance:none;width:100%;height:2px;margin:9px 4px;padding:0px 2px;background:#17a316;border:none;border-radius:2px;outline:none;-webkit-transition:.2s;transition:opacity .2s}
.slider::-webkit-slider-thumb{-webkit-appearance:none !important;appearance:none;width:12px;height:17px;border:none;background:#17a316;border-radius:4px;cursor:pointer}
.slider::-moz-range-thumb{-webkit-appearance:none !important;-moz-appearance:none !important;appearance:none;width:12px;height:17px;border:none;background:#17a316;border-radius:4px;cursor:pointer}
.slider::-ms-thumb{-webkit-appearance:none !important;appearance:none;width:12px;height:17px;border:none;background:#17a316;border-radius:4px;cursor:pointer}
.slider::-webkit-slider-thumb:hover,.slider::-webkit-slider-thumb:focus{background:#19d741;outline:none}
.slider::-moz-range-thumb:hover,.slider::-moz-range-thumb:focus{background:#19d741;outline:none}
.slider::-ms-thumb:hover,.slider::-ms-thumb:focus{background:#19d741;outline:none}
.slider::-webkit-slider-thumb:active{background:#19d741}
.slider::-moz-range-thumb:active{background:#19d741}
.slider::-ms-thumb:active{background:#19d741}
@media only screen and (max-width:768px){.slider::-webkit-slider-thumb{width:25px;height:18px}
.slider::-moz-range-thumb{width:25px;height:18px}
.slider::-ms-thumb{width:25px;height:18px}
}.dropdown{-webkit-appearance:none;-moz-appearance:none;appearance:none;flex-shrink:0;width:auto;height:25px;align-items:center;justify-content:center;margin:0;padding:0 10px;border-radius:6px;border:none;font-weight:400;font-size:12px;overflow:hidden;outline:none;cursor:pointer;color:#FFF;background:#1aad19;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}
#dialog-settings .dh-input,#dialog-promptgenerator .dh-input{font-size:12px;color:#333333;background-color:#fcfcfc}
#dialog-promptgenerator .dh-input{font-size:13px}
#loading-mask button{margin:30px;display:inline-block;padding:8px 16px;font-size:14px;text-align:center;color:#333;background-color:#fdffb4;border:3px solid #555;border-radius:10px;cursor:pointer}
/* 以上 弹窗 */
/* 以下 消息通知 tooltips */
.notification{position:relative;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:900900}
.notification-wrapper{max-width:600px;height:auto;max-height:82%;overflow:scroll;position:fixed;transform:translate(-50%,-50%);background-color:#fdffb4;box-shadow:0 0 8px rgba(191,169,16,0.3);border:1px solid rgba(166,152,27,0.45);z-index:900902}
.notification-content{color:#664909;font-size:13px;line-height:1.6}
.notification-content-center{display:block;text-align:start;padding-left:6px;margin:5px 10px 10px 10px;word-break:break-word}
.notification-content-bottom{display:flex;text-align:center;padding-left:0;margin:5px 11px 5px 11px;word-break:break-word}
.notification-center{width:82%;min-width:160px;bottom:auto;left:50%;top:50%;right:auto;border-radius:10px}
.notification-bottom{width:auto;min-width:45px;bottom:calc(0% + 5px);left:50%;top:auto;right:auto;border-radius:6px;animation:slideIn 0.4s ease-out forwards}
.notification-mask{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.65);z-index:900901}
@keyframes slideIn{from{transform:translate(-50%,-3px);opacity:0}
to{transform:translate(-50%,-18px);opacity:1}
}
/* 以上 消息通知 tooltips */
</style>
<!-- 以上为css样式  -->
</head>


<body>
<!-- #app -->  
<div id="app">

	<!-- 加载网页时的遮罩 Page Loading - Mask -->  
	<div id="loading-mask" class="dialog-wrapper" style="z-index: 999999;">
		<div>加载中<br>Loading</div>
	</div>
	
	<!-- 主界面-聊天对话 Main interface - Chat  -->  
    <div style="width:100%;">
        <div>
            <div v-for="(x,i) in msgList" :key="i">
				<!-- Me / User Message Datetime -->
				<div v-if="x.my" class="msgdatetimediv" :style="{ display: settingsTime_Message == 1 ? 'none' : 'block' }" ><span class="usermsg-datetime">{{x.datetime}}</span></div>
				
				<!-- AI Message Datetime -->
				<div v-if="!x.my" class="msgdatetimediv" :style="{ display: settingsTime_Message == 1 ? 'none' : 'block' }" ><span class="aimsg-datetime">{{x.datetime}}</span></div>
				
                <!-- Me / User Message -->
                <div v-if="x.my" class="userinfo" :style="{ marginTop : settingsTime_Message == 3 ? '27px' : '17px' }" >
					<div class="chat-img">
						<img :src="userAvatarURL">
					</div>	
                    <div class="justify-end msgcopydiv msgdiv">
                        <div class="usermsg" :style="{ fontSize: settingsFontSize + 'px' }">
                        	{{x.msg}} 
                        </div>
                    </div>
                </div>
				
                <!-- AI Message -->
                <div v-if="!x.my" class="aiinfo" :style="{ marginTop : settingsTime_Message == 3 ? '27px' : '17px' }" >
					<div class="chat-img" :style="{ display: isgptAvatarUrlShow ? 'flex' : 'none' }">
						<img :src="gptAvatarURL">
					</div>
                    <div class="chat-img chat-green-svg" :style="{ display: isgptGreenSvgShow ? 'flex' : 'none'}">
						<svg width="27" height="27" viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"  role="img">
							<path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707ZM22.4978 37.8849C20.7443 37.8874 19.0459 37.2733 17.6994 36.1501C17.7601 36.117 17.8666 36.0586 17.936 36.0161L25.9004 31.4156C26.1003 31.3019 26.2663 31.137 26.3813 30.9378C26.4964 30.7386 26.5563 30.5124 26.5549 30.2825V19.0542L29.9213 20.998C29.9389 21.0068 29.9541 21.0198 29.9656 21.0359C29.977 21.052 29.9842 21.0707 29.9867 21.0902V30.3889C29.9842 32.375 29.1946 34.2791 27.7909 35.6841C26.3872 37.0892 24.4838 37.8806 22.4978 37.8849ZM6.39227 31.0064C5.51397 29.4888 5.19742 27.7107 5.49804 25.9832C5.55718 26.0187 5.66048 26.0818 5.73461 26.1244L13.699 30.7248C13.8975 30.8408 14.1233 30.902 14.3532 30.902C14.583 30.902 14.8088 30.8408 15.0073 30.7248L24.731 25.1103V28.9979C24.7321 29.0177 24.7283 29.0376 24.7199 29.0556C24.7115 29.0736 24.6988 29.0893 24.6829 29.1012L16.6317 33.7497C14.9096 34.7416 12.8643 35.0097 10.9447 34.4954C9.02506 33.9811 7.38785 32.7263 6.39227 31.0064ZM4.29707 13.6194C5.17156 12.0998 6.55279 10.9364 8.19885 10.3327C8.19885 10.4013 8.19491 10.5228 8.19491 10.6071V19.808C8.19351 20.0378 8.25334 20.2638 8.36823 20.4629C8.48312 20.6619 8.64893 20.8267 8.84863 20.9404L18.5723 26.5542L15.206 28.4979C15.1894 28.5089 15.1703 28.5155 15.1505 28.5173C15.1307 28.5191 15.1107 28.516 15.0924 28.5082L7.04046 23.8557C5.32135 22.8601 4.06716 21.2235 3.55289 19.3046C3.03862 17.3858 3.30624 15.3413 4.29707 13.6194ZM31.955 20.0556L22.2312 14.4411L25.5976 12.4981C25.6142 12.4872 25.6333 12.4805 25.6531 12.4787C25.6729 12.4769 25.6928 12.4801 25.7111 12.4879L33.7631 17.1364C34.9967 17.849 36.0017 18.8982 36.6606 20.1613C37.3194 21.4244 37.6047 22.849 37.4832 24.2684C37.3617 25.6878 36.8382 27.0432 35.9743 28.1759C35.1103 29.3086 33.9415 30.1717 32.6047 30.6641C32.6047 30.5947 32.6047 30.4733 32.6047 30.3889V21.188C32.6066 20.9586 32.5474 20.7328 32.4332 20.5338C32.319 20.3348 32.154 20.1698 31.955 20.0556ZM35.3055 15.0128C35.2464 14.9765 35.1431 14.9142 35.069 14.8717L27.1045 10.2712C26.906 10.1554 26.6803 10.0943 26.4504 10.0943C26.2206 10.0943 25.9948 10.1554 25.7963 10.2712L16.0726 15.8858V11.9982C16.0715 11.9783 16.0753 11.9585 16.0837 11.9405C16.0921 11.9225 16.1048 11.9068 16.1207 11.8949L24.1719 7.25025C25.4053 6.53903 26.8158 6.19376 28.2383 6.25482C29.6608 6.31589 31.0364 6.78077 32.2044 7.59508C33.3723 8.40939 34.2842 9.53945 34.8334 10.8531C35.3826 12.1667 35.5464 13.6095 35.3055 15.0128ZM14.2424 21.9419L10.8752 19.9981C10.8576 19.9893 10.8423 19.9763 10.8309 19.9602C10.8195 19.9441 10.8122 19.9254 10.8098 19.9058V10.6071C10.8107 9.18295 11.2173 7.78848 11.9819 6.58696C12.7466 5.38544 13.8377 4.42659 15.1275 3.82264C16.4173 3.21869 17.8524 2.99464 19.2649 3.1767C20.6775 3.35876 22.0089 3.93941 23.1034 4.85067C23.0427 4.88379 22.937 4.94215 22.8668 4.98473L14.9024 9.58517C14.7025 9.69878 14.5366 9.86356 14.4215 10.0626C14.3065 10.2616 14.2466 10.4877 14.2479 10.7175L14.2424 21.9419ZM16.071 17.9991L20.4018 15.4978L24.7325 17.9975V22.9985L20.4018 25.4983L16.071 22.9985V17.9991Z" fill="currentColor">
							</path>
						</svg>
					</div>
					<div class="msgcopydiv msgdiv">
                        <div class="aimsg" :style="{ fontSize: settingsFontSize + 'px' }">
                        	{{x.msg}} 
                        </div>
                    </div>
                </div>
            </div>
			
			<!-- 空白块 布局/定位用 For position -->
            <div class="bottom-position"></div>
        </div>
    </div>
	<!-- End: 主界面-聊天对话 Main interface - Chat -->


	<!-- 主界面-底部  Main interface - Bottom  -->
    <div  class="flex-column-center">
		<!-- First row -->
        <div class="panelrow" style="margin-top: 6px;height: 40px;">
			<button @click="isShowDialog_PromptGenerator = true" class="btn bluebtn btnpromptgenerator" style="margin-left:12px;margin-right:-1px;border-radius: 6px 0px 0px 6px;line-height: 38px; width: 27px;height: 38px;padding: 0 8px;z-index: 900001;">
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
						<path clip-rule="evenodd" d="M14.526 6.10576C15.0265 6.33917 15.2667 6.88343 15.0625 7.3214L9.88541 18.4237C9.68118 18.8616 9.10985 19.0275 8.60931 18.7941C8.10877 18.5607 7.86857 18.0164 8.0728 17.5784L13.2499 6.47616C13.4541 6.03819 14.0254 5.87235 14.526 6.10576Z" fill="currentColor" fill-rule="evenodd" /></svg>
					</svg>
				</div>
			</button>
            <textarea @click="scrollToBottomViewClick"  @blur="textareaChatInputBox_blur" @focus="textareaChatInputBox_focus"  @keydown.enter.exact="textareaEnter"  @keydown.ctrl.enter.exact="newLine" @keydown.meta.enter.exact="newLine"  v-model="msg"  type="text"  class="dh-input textareachatinputbox" style="margin-left:0px;height: 38px;min-height: 38px;max-height: 38px;border-radius: 0px 6px 6px 0px; z-index:900000" placeholder="" enterkeyhint="send" ></textarea>
			<button @click="sendMsg();" :disabled="btnDisabledState_Sending" class="btn" style="line-height: 38px; height: 38px;font-size: 14px;padding: 0 15px;" >{{sentext}}</button> 
        </div>
	
		<!-- Second row - Left -->
		<div class="panelrow" style="margin-bottom: 7px;">
		  	<button  @click="clearContext" :disabled="btnDisabledState_Clear"  class="btn" style="margin-left:12px;margin-right: 4px;">
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
						<polyline points="3 6 5 6 21 6"></polyline>
						<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
						<line x1="10" y1="11" x2="10" y2="17"></line>
						<line x1="14" y1="11" x2="14" y2="17"></line>
					</svg>	
				</div>
				<span v-if="settingsLanguage == 'cn' " :style="{ display: isShowQACountLabel ? 'flex' : 'none' }" >&nbsp;记忆</span>
				<span v-else :style="{ display: isShowQACountLabel ? 'flex' : 'none' }" >&nbsp;Context</span>
				<span>:&nbsp;{{succQA_Count}}</span>
			</button>
			<button  disabled class="btn" style="margin-right:-10px;margin-left: 0px;padding-right: 15px;border-radius: 6px 0px 0px 6px;">
				<div :style="{ display: isShowTotaltokensSVG ? 'flex' : 'none' }" >
					<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="25" height="18"  viewBox="0 0 25 19"  fill="currentColor" stroke-width="0.02"  stroke="currentColor"  stroke-linecap="round" stroke-linejoin="round">
						   <path d="m10.62109,1.66441c-1.05095,-0.60518 -2.43437,-0.9385 -3.89526,-0.9385c-1.46093,0 -2.84426,0.33332 -3.89526,0.9385c-1.12359,0.64701 -1.74652,1.53053 -1.75767,2.49024l-0.00051,0l0,10.75701c0,1.91873 2.48327,3.42172 5.65344,3.42172c3.17018,0 5.65349,-1.50299 5.65349,-3.42172l0,-10.74381l-0.00023,0c-0.00557,-0.96482 -0.62926,-1.85344 -1.758,-2.50345zm0.77473,6.82194c0,1.32648 -2.13857,2.44712 -4.66998,2.44712c-2.53136,0 -4.66994,-1.12064 -4.66994,-2.44712l0,-0.18096c1.01002,0.8957 2.70835,1.47278 4.66994,1.47278c1.96163,0 3.65992,-0.57714 4.66998,-1.47278l0,0.18096zm0,2.13876c0,1.32652 -2.13857,2.44716 -4.66998,2.44716c-2.53136,0 -4.66994,-1.12068 -4.66994,-2.44716l0,-0.18092c1.01002,0.89565 2.70835,1.47278 4.66994,1.47278c1.96163,0 3.65992,-0.57713 4.66998,-1.47278l0,0.18092zm-9.33992,1.95788c1.01002,0.8957 2.70835,1.47278 4.66993,1.47278c1.96164,0 3.65992,-0.57713 4.66998,-1.47283l0,0.18102c0,1.32647 -2.13857,2.44711 -4.66998,2.44711c-2.53136,0 -4.66993,-1.12064 -4.66993,-2.44711l0,-0.18097zm9.33992,-6.23549c0,1.32647 -2.13857,2.44711 -4.66998,2.44711c-2.53137,0.00005 -4.66994,-1.12063 -4.66994,-2.44711l0,-0.22269c1.01002,0.88937 2.70835,1.46238 4.66993,1.46238c1.96164,0 3.65992,-0.57306 4.66998,-1.46238l0,0.22269l0,0zm-8.07442,-3.83077c0.90403,-0.52061 2.11309,-0.80727 3.40444,-0.80727c1.29139,0 2.50046,0.28671 3.40449,0.80727c0.80423,0.46309 1.2655,1.06963 1.2655,1.66405c0,1.31336 -2.13857,2.4229 -4.66998,2.4229c-2.53136,0 -4.66994,-1.10954 -4.66994,-2.4229c0,-0.59441 0.46127,-1.20095 1.26549,-1.66405zm3.40444,14.83319c-2.53136,0 -4.66993,-1.11656 -4.66993,-2.43826l0,-0.18982c1.01002,0.89566 2.70835,1.47279 4.66993,1.47279c1.96164,0 3.65992,-0.57713 4.66998,-1.47279l0,0.18987c0,1.32166 -2.13862,2.43822 -4.66998,2.43822z"/>
							<path d="m24.01826,10.37334c-0.00347,-0.9667 -0.62739,-1.85725 -1.75804,-2.50833c-1.05095,-0.60519 -2.43437,-0.9385 -3.89531,-0.9385c-1.46088,0 -2.84426,0.33332 -3.89526,0.9385c-1.1338,0.65286 -1.75818,1.54655 -1.75818,2.51633c0,0.00023 0,0.00047 0,0.00075l0,0l0,4.32772c0,1.91086 2.48326,3.40772 5.65344,3.40772c3.17018,0 5.65349,-1.49686 5.65349,-3.40772l0,-4.33653l-0.00014,0l0,0.00005zm-0.98337,2.17477c0,1.32648 -2.13857,2.44717 -4.66999,2.44717c-2.53137,0 -4.66993,-1.12065 -4.66993,-2.44717l0,-0.22269c1.01002,0.88937 2.7083,1.46238 4.66993,1.46238s3.65992,-0.57301 4.66999,-1.46238l0,0.22269zm-8.07442,-3.83077c0.90403,-0.52061 2.11309,-0.80727 3.40444,-0.80727c1.29135,0 2.50046,0.28672 3.40449,0.80727c0.80423,0.46309 1.2655,1.06964 1.2655,1.66405c0,1.31336 -2.13857,2.4229 -4.66999,2.4229c-2.53137,0 -4.66993,-1.10954 -4.66993,-2.4229c0.00005,-0.59441 0.46127,-1.20096 1.2655,-1.66405zm3.40444,8.41673c-2.53137,0 -4.66993,-1.11014 -4.66993,-2.42421l0,-0.20386c1.01002,0.89565 2.7083,1.47277 4.66993,1.47277s3.65992,-0.57708 4.66998,-1.47277l0,0.20386c0,1.31407 -2.13857,2.42421 -4.66998,2.42421z" />
					</svg>
				</div>
				<span v-if="settingsLanguage == 'cn' " :style="{ display: isShowTotaltokensLabel ? 'flex' : 'none' }" >&nbsp;Token用量</span>
				<span v-else :style="{ display: isShowTotaltokensLabel ? 'flex' : 'none' }" >&nbsp;Tokens</span>
				<span>:&nbsp;{{totaltokens}}</span>
			</button>
			<!-- 简化聊天记录 1111111111 Chat Simplifier Shortcut  --> 
			<button disabled title="压缩上下文。待开发 Under development" class="btn" style="margin-right:auto;padding-left:9px;border-radius: 0px 6px 6px 0px;">
				<div>
					<svg  xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="19" height="19" fill="currentColor" stroke="currentColor" stroke-width="0.1" stroke-linecap="round" stroke-linejoin="round">
					  <path d="m9.58259,6.35354c0.15086,0 0.26579,-0.05745 0.41661,-0.19392l2.39193,-2.22672c0.12211,-0.10776 0.18678,-0.23705 0.18678,-0.40226c0,-0.2945 -0.22266,-0.50999 -0.52437,-0.50999c-0.14364,0 -0.28011,0.06463 -0.39505,0.17239l-0.93378,0.93378l-0.61774,0.64649l0.05027,-1.20675l0,-2.3704c0,-0.30168 -0.26576,-0.55308 -0.57465,-0.55308c-0.30886,0 -0.56744,0.2514 -0.56744,0.55308l0,2.3704l0.0431,1.20675l-0.61774,-0.64649l-0.93378,-0.93378c-0.10776,-0.10776 -0.2514,-0.17239 -0.39508,-0.17239c-0.30886,0 -0.52434,0.21548 -0.52434,0.50999c0,0.16521 0.06463,0.2945 0.19392,0.40226l2.38478,2.22672c0.15082,0.13647 0.27294,0.19392 0.41658,0.19392zm-6.04805,5.46626l12.09611,0c1.19951,0 2.03274,-0.8117 2.03274,-1.91786l0,-0.73268c0,-1.10617 -0.83323,-1.91783 -2.03274,-1.91783l-12.09611,0c-1.19236,0 -2.03277,0.81167 -2.03277,1.91783l0,0.73268c0,1.10617 0.84041,1.91786 2.03277,1.91786zm0.15086,-1.08463c-0.64649,0 -1.04154,-0.431 -1.04154,-1.01283l0,-0.37349c0,-0.58182 0.39505,-1.01283 1.04154,-1.01283l11.79446,0c0.64639,0 1.04154,0.431 1.04154,1.01283l0,0.37349c0,0.58183 -0.39514,1.01283 -1.04154,1.01283l-11.79446,0zm5.8972,7.69295c0.30889,0 0.57465,-0.2514 0.57465,-0.55308l0,-2.37039l-0.05027,-1.20671l0.61774,0.64645l0.93378,0.93378c0.11493,0.10776 0.2514,0.17239 0.39505,0.17239c0.30171,0 0.52437,-0.20831 0.52437,-0.50998c0,-0.16521 -0.06466,-0.28732 -0.18678,-0.40223l-2.39193,-2.22675c-0.15082,-0.13647 -0.26576,-0.18674 -0.41661,-0.18674c-0.14365,0 -0.26576,0.05027 -0.41658,0.18674l-2.38478,2.22675c-0.12929,0.1149 -0.19392,0.23702 -0.19392,0.40223c0,0.30168 0.21549,0.50998 0.52434,0.50998c0.14368,0 0.28732,-0.06463 0.39508,-0.17239l0.93378,-0.93378l0.61774,-0.64645l-0.0431,1.20671l0,2.37039c0,0.30168 0.25858,0.55308 0.56744,0.55308z" />
					</svg>
				</div>
			</button>
			
			<!-- Second row - Right -->
		 	<button @click="undo" :disabled="btnDisabledState_Undo" class="btn" style="margin-left:auto;margin-right:4px;width:45px;"  >
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="23px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" >
						<path d="M5 9.5C8.5 9.5 11.5 9.5 15 9.5C15.1615 9.5 19 9.5 19 13.5C19 18 15.2976 18 15 18C12 18 10 18 7 18"/>
						<path d="M8.5 13C7.13317 11.6332 6.36683 10.8668 5 9.5C6.36683 8.13317 7.13317 7.36683 8.5 6" />
					</svg>
				</div>
			</button>
			<button @click="retry" :disabled="btnDisabledState_Undo"  class="btn"  style="margin-right:4px;width:45px;"   >
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
						<path d="M17 2.1l4 4-4 4"/>
						<path d="M3 12.2v-2a4 4 0 0 1 4-4h12.8M7 21.9l-4-4 4-4"/>
						<path d="M21 11.8v2a4 4 0 0 1-4 4H4.2"/>
					</svg>
				</div>
			</button>
			<button @click="openDialogTodo_Settings" class="btn" :class="{ 'redbtn': !btnDisabledState_CheckAPI }" style="margin-right:4px;width:45px;" >
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="12" cy="12" r="3"></circle>
						<path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
					</svg>
				</div>
			</button>
			<button @click="openDialog_Help" class="btn" style="width:45px;" >
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="12" cy="12" r="10"></circle>
						<path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
						<line x1="12" y1="17" x2="12.01" y2="17"></line>
					</svg>
				</div>
			</button>
		</div>
    </div>
	<!-- End: 主界面-底部  Main interface - Bottom  -->



	<!-- dialog-wrapper A: 设置 Settings -->  
	<div id="dialog-settings" class="dialog-wrapper" v-show="isShowDialog_Settings">
		<!-- A: dialog -->  
		<div class="dialog">
	
			<!-- A: 标题 header -->  
			<div class="dialog-header">
				<div class="dialog-title" style="justify-content: space-between;width: calc(95% - 27px);" >
					<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle>
					<path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
					</svg>
					{{ settingsLanguage == 'cn' ? '&nbsp;设置' : '&nbsp;Settings' }}
					<span style="margin-left:auto">LinGPT v6.09&nbsp;&nbsp;</span>
					<button  class="btn" style="margin: 0px; padding: 0 3px;background-color: #fff;height: 20px;width: 20px;" >
						<a href="https://github.com/lin2025/gpt3.5/" target="_blank">
							<svg xmlns="http://www.w3.org/2000/svg" width="14" viewBox="0 0 16 16"  fill="#1f2328"> 
							    <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path>
							</svg>
						</a>
					</button>
					<button  class="btn" style="margin-left: 5px; padding: 0 3px;background-color: #fff;height: 20px;width: 20px;" >
						<a href="https://gitee.com/lin2025/gpt3.5/" target="_blank">
							<svg xmlns="http://www.w3.org/2000/svg" width="14" viewBox="0 0 24 24" fill="#c61d22">
								<path d="m11.984,0a12,12 0 0 0 -11.984,12a12,12 0 0 0 12,12a12,12 0 0 0 12,-12a12,12 0 0 0 -12,-12a12,12 0 0 0 -0.016,0zm6.09,5.333c0.328,0 0.593,0.266 0.592,0.593l0,1.482a0.594,0.594 0 0 1 -0.593,0.592l-8.296,0c-0.982,0 -1.778,0.796 -1.778,1.778l0,5.63c0,0.327 0.266,0.592 0.593,0.592l5.63,0c0.982,0 1.778,-0.796 1.778,-1.778l0,-0.296a0.593,0.593 0 0 0 -0.592,-0.593l-4.15,0a0.592,0.592 0 0 1 -0.592,-0.592l0,-1.482a0.593,0.593 0 0 1 0.593,-0.592l6.815,0c0.327,0 0.593,0.265 0.593,0.592l0,3.408a4,4 0 0 1 -4,4l-8.741,0a0.593,0.593 0 0 1 -0.593,-0.593l0,-8.296a4.444,4.444 0 0 1 4.445,-4.444l8.296,0l0,-0.001z"/>
							</svg>
						</a>
					</button> 
				</div>
			
				<div class="dialog-close" @click="isShowDialog_Settings = false">
					<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: none; stroke: #333; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
						<path d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</div>
			</div>
		  
			<!-- A: 主体内容 content -->  
			<div class="dialog-content">
 
				<!-- panelgroup: 接口密钥 API-Key --> 
				<div class="panelgroup">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? 'OpenAI 接口密钥 / API-Key ' : 'OpenAI API-Key ' }}</span>
						<button  @click="showMiniHelp('A-CheckAPIKey')"  class="btn minibtn bluebtn" :style="{ marginRight: btnDisabledState_CheckAPI ? 'auto' : '2px' }"  >?</button>
						<span :style="{ display: btnDisabledState_CheckAPI ? 'none' : 'block' }"  style="margin-right: auto;color: #dd3838;font-size: 11px;">{{ settingsLanguage == 'cn' ? '*必填' : '*Required' }}</span>
						<!-- 待开发。。。。。11111111111 display:none; --> 
						<button  class="btn minibtn minibtn-default bluebtn" style="display:none;">{{ settingsLanguage == 'cn' ? '点击我: 获取免费的体验密钥' : 'Click me: Free trial key' }}</button>
					</div>
				
					<div class="panelrow"> 
						<!-- 一键复制api-key  Cpoy api-key --> 
						<button class="copybtn btncopyapikey" data-clipboard-nextelementsibling="" style="opacity:1;position:relative;flex-shrink: 0;height: 25px;top:0;right:0;margin-right:-4px;border-radius: 6px 0px 0px 6px;border: 1px solid #DDD;width: 25px" >
							<div>
								<svg width="14" height="17" class="clippy" fill="currentColor">
									<path d="m2.36373,12.61912l4.12233,0l0,1.03058l-4.12233,0l0,-1.03058zm5.15291,-6.18349l-5.15291,0l0,1.03058l5.15291,0l0,-1.03058zm2.06116,3.09174l0,-2.06116l-3.09174,3.09174l3.09174,3.09174l0,-2.06116l5.15291,0l0,-2.06116l-5.15291,0zm-4.63761,-1.03058l-2.57645,0l0,1.03058l2.57645,0l0,-1.03058zm-2.57645,3.09174l2.57645,0l0,-1.03058l-2.57645,0l0,1.03058zm9.27523,1.03058l1.03058,0l0,2.06116c-0.0161,0.28985 -0.11272,0.53139 -0.30595,0.72463s-0.43478,0.28985 -0.72463,0.30595l-10.30581,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058l0,-11.33639c0,-0.5636 0.46698,-1.03058 1.03058,-1.03058l3.09175,0c0,-1.1433 0.91786,-2.06116 2.06116,-2.06116s2.06116,0.91786 2.06116,2.06116l3.09174,0c0.5636,0 1.03058,0.46698 1.03058,1.03058l0,5.15291l-1.03058,0l0,-3.09174l-10.30581,0l0,9.27523l10.30581,0l0,-2.06116zm-9.27523,-8.24465l8.24465,0c0,-0.5636 -0.46698,-1.03058 -1.03058,-1.03058l-1.03058,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058s-0.46698,-1.03058 -1.03058,-1.03058s-1.03058,0.46698 -1.03058,1.03058s-0.46698,1.03058 -1.03058,1.03058l-1.03058,0c-0.5636,0 -1.03058,0.46698 -1.03058,1.03058z">
									</path>
								</svg>
							</div>
						</button>
						<!-- 隐藏的API-key，这个可被复制内容   hide : Function: Data can be read by "Copy Btn" --> 
						<input class="inputghostforcopyapikey" type="text" v-model="api" style="opacity:0;height:1px;width:1px;overflow:hidden;margin:0;padding:0;border:none;" />
						<!-- API-key输入框。 因为type="password" ，不可被复制。 Because type="password", it cannot be copied by "Copy Btn". --> 	
						<input @blur="inputapiblur" @focus="inputapifocus"  @input="inputapichange" :style="{ color: btnDisabledState_CheckAPI ? '#cccccc' : '#191919' }" v-model="api" type="password"  class="dh-input inputapikey"  style="border-radius: 0px;"  :placeholder="settingsLanguage == 'cn' ? 'API-key粘贴到这里' : 'Paste your API-Key here.' " />
						<!-- 验证API-key Check API-key --> 	
						<button @click="checkAPIbtn" :disabled="btnDisabledState_CheckAPI" class="btn" :class="{ 'redbtn': !btnDisabledState_CheckAPI }" style="border-radius: 0px 6px 6px 0px;margin-left:-3px;"  >{{apibtntext}}</button>
						<!-- 查询OpenAI API余额 Check OpenAI API balances --> 	
						<button  onclick="sendRequest()" :disabled="!btnDisabledState_CheckAPI" class="btn" style="padding: 0 8px;">
							<div>
								<svg xmlns="http://www.w3.org/2000/svg" width="21px" height="20px" viewBox="0 0 24 24" fill="none"  stroke="currentColor" stroke-width="1.75" stroke-miterlimit="10">  
									<circle cx="9.5106" cy="9.42613" r="7.64"/>
									<path d="m6.6506,12.28613l3.34,0a1.43,1.43 0 0 0 1.43,-1.43l0,0a1.43,1.43 0 0 0 -1.43,-1.43l-0.95,0a1.44,1.44 0 0 1 -1.39,-1.44l0,0a1.44,1.44 0 0 1 1.44,-1.43l3.34,0"/>
									<line x1="9.5106" x2="9.5106" y1="4.64613" y2="6.55613"/><line x1="9.5106" x2="9.5106" y1="12.28613" y2="14.19613"/><line transform="rotate(90 18.2202 18.6877)" x1="14.70164" x2="21.73886" y1="22.20633" y2="15.16912"/>  
								</svg>
							</div>
						</button>
					</div>
				</div>


				<!-- panelgroup: API设置  API Settings --> 
				<div class="panelgroup">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? 'API设置' : 'API Settings' }}</span>
						<button  @click="showMiniHelp('A-APISettings')"  class="btn minibtn bluebtn"  style="margin-right: auto;">?</button>
						<button  @click="restoreDefault_APISettings"  class="btn minibtn minibtn-default bluebtn">{{ settingsLanguage == 'cn' ? '恢复默认' : 'Restore Default' }}</button>
					</div>

					<div class="panelrow" style="align-items: start; height:auto;">
						<!--温度/随机性/创造力 temperature --> 
						<div class="control-container" style="width:108px;flex-shrink: 0;">
							<div>
								<span>temperature: {{apitemperature}}</span>
							</div>
							<div class="control-bg" >
								<input @change="changeTemperature" type="range" class="slider" v-model.number="apitemperature"  min="0.0" max="2.0" step="0.1" value="0.7" >
							</div>
						</div>
						<!-- 单次最大令牌数量 max_tokens --> 
						<div class="control-container" style="flex: 1 1 0%;">
							<div>
								<span>max_tokens(1~4096): {{apiMaxTokens}}</span>
							</div>
							<div class="control-bg">
								<input @change="changeMaxTokens" type="range" class="slider" v-model.number="apiMaxTokens"  min="1" max="4096" step="1" value="2048" >
							</div>
						</div>
					</div>	
	
					<div class="panelrow" style="align-items: start; height:auto;">
						<!-- GPT模型 GPT Model --> 
						<div class="control-container" style="width:156px;flex-shrink: 0;">
							<div>
								<span>model: {{apiGPTModel}}</span>
							</div>
							<select class="dropdown" v-model="apiGPTModel" style="width: 100%;height: 24px;">
								<option v-for="option in gptModelOptions" :value="option.model">{{ option.label }}</option>
								<option v-if="settingsLanguage == 'cn' "  disabled value="">暂时只支持GPT3.5</option>
								<option v-else disabled value="">Only supports GPT3.5 for now</option>
							</select>
						</div>
	
						<!-- 单次最大令牌数量（精细调节 1～300） max_tokens（Fine 1～300）  --> 
						<div class="control-container" style="flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? 'max_tokens(微调)' : 'max_tokens(Fine)' }}</span>
							</div>
							<div class="control-bg">
								<input @change="changeMaxTokens" type="range" class="slider" v-model.number="apiMaxTokens"  min="1" max="300" step="1" value="2048" >
							</div>
						</div>
	
						<!-- 显示专业设置 Show more settings (Professional API Settings) --> 
						<div class="control-container">
							<div>
								<span>{{ settingsLanguage == 'cn' ? ' 更多' : ' More' }}</span>
							</div>
							<button  @click="showProConfig"  class="btn bluebtn" style="margin: 0;padding: 0 4px;">
								<div>
									PRO
								</div>
							</button>
						</div>
					</div>
				</div>

				<!-- panelgroup: API专业设置  Professional API Settings --> 
				<div id="pro-config" class="panelgroup" style="display:none;">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? 'API专业设置' : 'Professional API Settings' }}</span>
						<button  @click="showMiniHelp('A-ProfessionalAPISettings')"  class="btn minibtn bluebtn" style="margin-right: auto;">?</button>
						<button  @click="restoreDefault_ProfessionalAPISettings"  class="btn minibtn minibtn-default bluebtn">{{ settingsLanguage == 'cn' ? '恢复默认' : 'Restore Default' }}</button>
					</div>
				
					<!-- 接口网址 API URL / API Endpoint  --> 
					<div class="panelrow" style="align-items: start; height:auto;">
						<span style="line-height: 25px;font-size: 12px;flex-shrink: 0;">
							{{ settingsLanguage == 'cn' ? '接口网址 :' : 'API URL :' }} 
						</span>
						<input type="text" @input="inputApiURLChange" v-model="inputApiURL" class="dh-input" style="border-radius:6px 0px 0px 6px;"  :placeholder="settingsLanguage == 'cn' ? '清空后保存 可重置为OpenAI官方接口' : 'Clear and save, can be reset to OpenAI API endpoint.' "  />
						<button @click="saveApiURL" class="btn btnsaveapiurl" style="border-radius: 0px 6px 6px 0px;margin-left:-3px;"  >
							{{ settingsLanguage == 'cn' ? '保存' : 'Save' }} 
						</button>	
						<select @change="updateInputApiURL" :disabled="btnDisabledState_ApiURL" class="dropdown" v-model="selectedApiURL" style="width:45px;">
							<option disabled value="">&nbsp;&nbsp;▼&nbsp;&nbsp;&nbsp;{{ settingsLanguage == 'cn' ? '官方接口 ｜ 第三方接口' : 'OpenAI API or Third-party API ' }}</option>
							<option v-if="settingsLanguage == 'cn'" v-for="option in apiURLOptions_cn" :value="option.url">{{ option.label }}</option>
							<option v-else v-for="option in apiURLOptions_en" :value="option.url">{{ option.label }}</option>
							<option disabled value="">{{ settingsLanguage == 'cn' ? '第三方接口来源网络，无法保证隐私安全和实效性' : 'Third-party APIs can be unsafe or unreliable.' }}</option>
						</select>		
					</div>
	
					<div class="panelrow" style="align-items: start; height:auto;">
						<!-- top_p --> 
						<div class="control-container" style="flex: 1 1 0%;">
							<div>
								<span style="font-size: 11px;">top_p: {{apiTopP}}</span>
							</div>
							<div class="control-bg" >
								<input type="range" class="slider" v-model.number="apiTopP"  min="0.0" max="1" step="0.1" value="1" >
							</div>
						</div>
	
						<!-- presence_penalty --> 
						<div class="control-container" style="width: 48%;flex: 1 1 15%;">
							<div>
								<span style="font-size: 11px;">presence_penalty: {{apiPresencePenalty}}</span>
							</div>
							<div class="control-bg" >
								<input type="range" class="slider" v-model.number="apiPresencePenalty"  min="-2.0" max="2.0" step="0.1" value="0" >
							</div>
						</div>
	
						<!-- frequency_penalty --> 
						<div class="control-container" style="width: 48%;flex: 1 1 15%;">
							<div>
								<span style="font-size: 11px;">frequency_penalty: {{apiFrequencyPenalty}}</span>
							</div>
							<div class="control-bg" >
								<input type="range" class="slider" v-model.number="apiFrequencyPenalty"  min="-2.0" max="2.0" step="0.1" value="0" >
							</div>
						</div>
					</div>
				</div>

				<!-- panelgroup: 常规设置 General Settings --> 
				<div class="panelgroup">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? '常规设置' : 'General Settings' }}</span>
						<button  @click="showMiniHelp('A-GeneralSettings')"  class="btn minibtn bluebtn" style="margin-right: auto;">?</button>
						<button  @click="restoreDefault_GeneralSettings"  class="btn minibtn minibtn-default bluebtn">{{ settingsLanguage == 'cn' ? '恢复默认' : 'Restore Default' }}</button>
					</div>
				
					<div class="panelrow" style="align-items: start; height:auto;flex-wrap: wrap;justify-content: stretch;">
						<!-- 语言切换 中/英 Language --> 
						<div class="control-container" style="min-width: 80px;max-width: 180px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? 'Language&#127464;&#127475;' : '语言&#x1F1EC;&#x1F1E7;' }}</span>
							</div>
							<select @change="changeLanguage" :disabled="btnDisabledState_Language" class="dropdown" v-model="settingsLanguage" style="width: 100%;height: 24px;">
								<option v-for="option in settingsLanguageOptions" :value="option.lang">{{ option.label }}</option>
							</select>
						</div>
						<!-- 字体大小 Font Size --> 
						<div class="control-container" style="min-width: 65px;max-width: 165px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '字体大小' : 'Font Size' }}</span>
							</div>
							<select @change="changeStyle_FontSize" class="dropdown" v-model="settingsFontSize" style="width: 100%;height: 24px;">
								<option v-for="option in settingsFontSizeOptions" :value="option.fontsize">{{ option.label }}</option>
							</select>
						</div>
						<!-- 显示时间(微信样式)  Display time (WeChat style) --> 
						<div class="control-container" style="min-width: 125px;max-width: 225px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '仿微信时间' : 'Time (WeChat style)' }}</span>
							</div>
							<select @change="changeStyle_Time_WechatStyle" class="dropdown" v-model="settingsTime_WechatStyle" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsTimeWechatStyleOptions_cn" :value="option.displaytime">{{ option.label }}</option>
								<option v-else v-for="option in settingsTimeWechatStyleOptions_en" :value="option.displaytime">{{ option.label }}</option> 
							</select>
						</div>
						<!-- 显示消息时间  Display message time.  --> 
						<div class="control-container" style="min-width: 105px;max-width: 205px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '消息时间' : 'Time (Message)' }}</span>
							</div>
							<select @change="changeStyle_Time" class="dropdown" v-model="settingsTime_Message" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsTimeMessageOptions_cn" :value="option.displaytime">{{ option.label }}</option>
								<option v-else v-for="option in settingsTimeMessageOptions_en" :value="option.displaytime">{{ option.label }}</option>
							</select>
						</div>
						<!-- 显示分割线 记忆分割线/上下文分割线 Display divider line --> 
						<div class="control-container" style="min-width: 125px;max-width: 225px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '记忆分割线' : 'Context Divider Line' }}</span>
							</div>
							<select @change="changeStyle_DividerLine" class="dropdown" v-model="settingsDividerLine" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsDividerLineOptions_cn" :value="option.displaydividerline">{{ option.label }}</option>
								<option v-else v-for="option in settingsDividerLineOptions_en" :value="option.displaydividerline">{{ option.label }}</option>
							</select>
						</div>
			
			
						<!-- 记忆模式 / 上下文模式  Contextual Mode --> 
						<div class="control-container" style="min-width: 110px;max-width: 210px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '记忆模式' : 'Contextual Mode' }}</span>
							</div>
							<select @change="changeContextualMode" :disabled="btnDisabledState_ContextualMode" class="dropdown" v-model="settingsContextualMode" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsContextualModeOptions_cn" :value="option.mode">{{ option.label }}</option>
								<option v-else v-for="option in settingsContextualModeOptions_en" :value="option.mode">{{ option.label }}</option>
								<option disabled value="">更多:待开发  More:Under development</option>
							</select>
						</div>
	
						<!-- 验证API-Key 快捷键 Check API-Key Shortcut  --> 
						<div class="control-container" style="min-width: 150px;max-width: 260px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '[验证API-Key]快捷键' : '[Check API-Key] Shortcut' }}</span>
							</div>
							<select class="dropdown" v-model="settingsShortcut_CheckApiKey" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsShortcutCheckApiKeyOptions_cn" :value="option.shortcut">{{ option.label }}</option>
								<option v-else v-for="option in settingsShortcutCheckApiKeyOptions_en" :value="option.shortcut">{{ option.label }}</option>
							</select>
						</div>
		
						<!-- 清空快捷键 Clear Context Shortcut--> 
						<div class="control-container" style="min-width: 140px;max-width: 250px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '[清空]快捷键' : '[Clear Context] Shortcut' }}</span>
							</div>
							<select class="dropdown" v-model="settingsShortcut_Clear" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsShortcutClearOptions_cn" :value="option.shortcut">{{ option.label }}</option>
								<option v-else v-for="option in settingsShortcutClearOptions_en" :value="option.shortcut">{{ option.label }}</option>
							</select>
						</div>
	
						<!-- 撤销快捷键 Undo Shortcut --> 
						<div class="control-container" style="min-width: 95px;max-width: 195px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '[撤销]快捷键' : '[Undo] Shortcut' }}</span>
							</div>
							<select class="dropdown" v-model="settingsShortcut_Undo" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsShortcutUndoOptions_cn" :value="option.shortcut">{{ option.label }}</option>
								<option v-else v-for="option in settingsShortcutUndoOptions_en" :value="option.shortcut">{{ option.label }}</option>
							</select>
						</div>
	
						<!-- 重问快捷键 Retry Shortcut --> 
						<div class="control-container" style="min-width: 95px;max-width: 195px;flex: 1 1 0%;">
							<div>
								<span>{{ settingsLanguage == 'cn' ? '[重问]快捷键' : '[Retry] Shortcut' }}</span>
							</div>
							<select class="dropdown" v-model="settingsShortcut_Retry" style="width: 100%;height: 24px;">
								<option v-if="settingsLanguage == 'cn'" v-for="option in settingsShortcutRetryOptions_cn" :value="option.shortcut">{{ option.label }}</option>
								<option v-else v-for="option in settingsShortcutRetryOptions_en" :value="option.shortcut">{{ option.label }}</option>
							</select>
						</div>
					</div>

					<!-- 用户头像 user Avatar   -->
					<div class="panelrow" style="height:36px;">
						<select class="dropdown" v-model="selectedImageUrl" @change="updateSelectedImage('user')" :style="{ width: settingsLanguage == 'cn' ? '72px' : '87px' }" style="flex-shrink: 0;height: 24px;margin-right: 4px;">
							<option value="">{{ settingsLanguage == 'cn' ? '用户头像' : 'User Avatar' }}</option>
							<option v-for="image in userpresetImages" :value="image.url">{{image.name}}</option>
						</select>
						<span style="line-height: 25px; font-size: 12px; flex-shrink: 0;">{{ settingsLanguage == 'cn' ? '或 URL:' : 'or URL' }}</span>
						<input type="text" v-model="inputUserImageUrl" @input="inputImageUrlChange('user')" class="dh-input" style="flex: 1 1 0%;border-radius:6px 0px 0px 6px;" :placeholder="settingsLanguage == 'cn' ? '输入图片的网址（本地运行.html网页时支持电脑中图片的本地路径）' : 'Image URL. (Local image paths are supported when running *.html from PC/Mac.)' " >
						<button @click="updateAvatar('user')" :disabled="btnDisabledState_updateUserImageUrl" class="btn" :style="{ width: settingsLanguage == 'cn' ? '68px' : '85px' }" style="flex-shrink: 0;border-radius: 0px 6px 6px 0px;margin-left:-3px;margin-right: 4px;"  >{{ settingsLanguage == 'cn' ? '更换 >>' : 'Update >>' }}</button>
						<div class="chat-img chat-img-bg chat-img-border update-img-size">
							<img :src="userAvatarURL">
						</div>
					</div> 
					<!-- GPT头像 gpt Avatar   -->
					<div class="panelrow" style="height:35px;">
						<select class="dropdown" v-model="selectedImageUrl" @change="updateSelectedImage('ai')" :style="{ width: settingsLanguage == 'cn' ? '72px' : '87px' }" style="flex-shrink: 0;height: 24px;margin-right: 4px;">
							<option value="">{{ settingsLanguage == 'cn' ? 'GPT头像' : 'GPT Avatar' }}</option>
							<option v-for="image in gptpresetImages" :value="image.url">{{image.name}}</option>
						</select>
						<span style="line-height: 25px; font-size: 12px; flex-shrink: 0;">{{ settingsLanguage == 'cn' ? '或 URL:' : 'or URL' }}</span>
						<input type="text" v-model="inputGPTImageUrl" @input="inputImageUrlChange('ai')" class="dh-input" style="flex: 1 1 0%;border-radius:6px 0px 0px 6px;" :placeholder="settingsLanguage == 'cn' ? '输入图片的网址（本地运行.html网页时支持电脑中图片的本地路径）' : 'Image URL. (Local image paths are supported when running *.html from PC/Mac.)' ">
						<button @click="updateAvatar('ai')" :disabled="btnDisabledState_updateGPTImageUrl" class="btn" :style="{ width: settingsLanguage == 'cn' ? '68px' : '85px' }" style="flex-shrink: 0;border-radius: 0px 6px 6px 0px;margin-left:-3px;margin-right: 4px;"  >{{ settingsLanguage == 'cn' ? '更换 >>' : 'Update >>' }}</button>
						<div class="chat-img chat-img-bg chat-img-border update-img-size" :style="{ display: isgptAvatarUrlShow ? 'flex' : 'none' }">
							<img :src="gptAvatarURL">
						</div>
						<div class="chat-img chat-img-border chat-green-svg update-img-size" :style="{ display: isgptGreenSvgShow  ? 'flex' : 'none' }">
							<svg width="27" height="27" viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"  role="img">
								<path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707ZM22.4978 37.8849C20.7443 37.8874 19.0459 37.2733 17.6994 36.1501C17.7601 36.117 17.8666 36.0586 17.936 36.0161L25.9004 31.4156C26.1003 31.3019 26.2663 31.137 26.3813 30.9378C26.4964 30.7386 26.5563 30.5124 26.5549 30.2825V19.0542L29.9213 20.998C29.9389 21.0068 29.9541 21.0198 29.9656 21.0359C29.977 21.052 29.9842 21.0707 29.9867 21.0902V30.3889C29.9842 32.375 29.1946 34.2791 27.7909 35.6841C26.3872 37.0892 24.4838 37.8806 22.4978 37.8849ZM6.39227 31.0064C5.51397 29.4888 5.19742 27.7107 5.49804 25.9832C5.55718 26.0187 5.66048 26.0818 5.73461 26.1244L13.699 30.7248C13.8975 30.8408 14.1233 30.902 14.3532 30.902C14.583 30.902 14.8088 30.8408 15.0073 30.7248L24.731 25.1103V28.9979C24.7321 29.0177 24.7283 29.0376 24.7199 29.0556C24.7115 29.0736 24.6988 29.0893 24.6829 29.1012L16.6317 33.7497C14.9096 34.7416 12.8643 35.0097 10.9447 34.4954C9.02506 33.9811 7.38785 32.7263 6.39227 31.0064ZM4.29707 13.6194C5.17156 12.0998 6.55279 10.9364 8.19885 10.3327C8.19885 10.4013 8.19491 10.5228 8.19491 10.6071V19.808C8.19351 20.0378 8.25334 20.2638 8.36823 20.4629C8.48312 20.6619 8.64893 20.8267 8.84863 20.9404L18.5723 26.5542L15.206 28.4979C15.1894 28.5089 15.1703 28.5155 15.1505 28.5173C15.1307 28.5191 15.1107 28.516 15.0924 28.5082L7.04046 23.8557C5.32135 22.8601 4.06716 21.2235 3.55289 19.3046C3.03862 17.3858 3.30624 15.3413 4.29707 13.6194ZM31.955 20.0556L22.2312 14.4411L25.5976 12.4981C25.6142 12.4872 25.6333 12.4805 25.6531 12.4787C25.6729 12.4769 25.6928 12.4801 25.7111 12.4879L33.7631 17.1364C34.9967 17.849 36.0017 18.8982 36.6606 20.1613C37.3194 21.4244 37.6047 22.849 37.4832 24.2684C37.3617 25.6878 36.8382 27.0432 35.9743 28.1759C35.1103 29.3086 33.9415 30.1717 32.6047 30.6641C32.6047 30.5947 32.6047 30.4733 32.6047 30.3889V21.188C32.6066 20.9586 32.5474 20.7328 32.4332 20.5338C32.319 20.3348 32.154 20.1698 31.955 20.0556ZM35.3055 15.0128C35.2464 14.9765 35.1431 14.9142 35.069 14.8717L27.1045 10.2712C26.906 10.1554 26.6803 10.0943 26.4504 10.0943C26.2206 10.0943 25.9948 10.1554 25.7963 10.2712L16.0726 15.8858V11.9982C16.0715 11.9783 16.0753 11.9585 16.0837 11.9405C16.0921 11.9225 16.1048 11.9068 16.1207 11.8949L24.1719 7.25025C25.4053 6.53903 26.8158 6.19376 28.2383 6.25482C29.6608 6.31589 31.0364 6.78077 32.2044 7.59508C33.3723 8.40939 34.2842 9.53945 34.8334 10.8531C35.3826 12.1667 35.5464 13.6095 35.3055 15.0128ZM14.2424 21.9419L10.8752 19.9981C10.8576 19.9893 10.8423 19.9763 10.8309 19.9602C10.8195 19.9441 10.8122 19.9254 10.8098 19.9058V10.6071C10.8107 9.18295 11.2173 7.78848 11.9819 6.58696C12.7466 5.38544 13.8377 4.42659 15.1275 3.82264C16.4173 3.21869 17.8524 2.99464 19.2649 3.1767C20.6775 3.35876 22.0089 3.93941 23.1034 4.85067C23.0427 4.88379 22.937 4.94215 22.8668 4.98473L14.9024 9.58517C14.7025 9.69878 14.5366 9.86356 14.4215 10.0626C14.3065 10.2616 14.2466 10.4877 14.2479 10.7175L14.2424 21.9419ZM16.071 17.9991L20.4018 15.4978L24.7325 17.9975V22.9985L20.4018 25.4983L16.071 22.9985V17.9991Z" fill="currentColor">
							</svg>
						</div>
					</div>
				</div>

				<!-- panelgroup: 待开发功能 Under development ：  11111111111111  聊天数据管理  数据安全 隐私 Chat data management, data security, privacy.--> 
				<div class="panelgroup" style="display:none">
					<div class="panelgroup-head">
					    <span>待开发功能 Under development   聊天数据管理</span>
						<button  class="btn minibtn bluebtn" style="margin-right: auto;">?</button>
						<button  class="btn minibtn minibtn-default bluebtn">恢复默认</button>
					</div>
					<div class="control-container" style="flex: 1 1 0%;">
						<div>
							<span style="font-size: 11px;">待开发功能 Under development   本地浏览器缓存设置</span>
						</div>   
					</div>
					<div class="panelrow" style="align-items: start; height:auto;"> 
						<span style="line-height: 25px;font-size: 12px;flex-shrink: 0;">待开发功能 password :</span>
						<input type="text"  class="dh-input" style="border-radius:6px 0px 0px 6px;"  placeholder="待开发功能"  />
						<button  class="btn" style="border-radius: 0px 6px 6px 0px;margin-left:-3px;" >待开发功能  确认</button>
					</div> 
					<div class="panelrow" style="align-items: start; height:auto;">  
						<button  class="btn" >待开发功能  确认</button>
						<button  class="btn" >待开发功能  确认</button>
						<button  class="btn" >待开发功能  确认</button>
						<button  class="btn" >待开发功能  确认</button>
					</div> 
				</div>


				<!-- panelgroup: 导出聊天记录 Export chat history. --> 
				<div class="panelgroup">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? '导出数据' : 'Export Data' }}</span>
						<button  @click="showMiniHelp('A-ExportChatHistory')"  class="btn minibtn bluebtn" style="margin-right: auto;">?</button>
					</div>

					<div class="panelrow" style="align-items: center; height:auto;flex-wrap: wrap;justify-content: stretch;">
						<button  @click="ExportData_SingleRound(true,true,false,'markdown')" :disabled="btnDisabledState_Export" class="btn" style="margin: 2px 5px 4px 0px;" :style="{ minWidth: settingsLanguage == 'cn' ? '275px' : '320px' }">
							<svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/>
							</svg>&nbsp;&nbsp;{{ settingsLanguage == 'cn' ? '导出聊天记录_单轮对话 (.md)' : 'Export Chat History for a Single Round (.md)' }}
						</button>
						<button  @click="ExportData(chathistory,exportTXTFileName,'markdown')" :disabled="btnDisabledState_Export" class="btn" style="margin: 2px 5px 4px 0px;" :style="{ minWidth: settingsLanguage == 'cn' ? '240px' : '230px' }">
							<svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/>
							</svg>&nbsp;&nbsp;{{ settingsLanguage == 'cn' ? '导出聊天记录_全部 (.md)' : 'Export All Chat History (.md)' }}
						</button>
					
						<button  @click="ExportData_SingleRound(true,true,false,'plain')" :disabled="btnDisabledState_Export" class="btn" style="margin: 2px 5px 4px 0px;" :style="{ minWidth: settingsLanguage == 'cn' ? '275px' : '320px' }">
							<svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/>
							</svg>&nbsp;&nbsp;{{ settingsLanguage == 'cn' ? '导出聊天记录_单轮对话 (.txt)' : 'Export Chat History for a Single Round (.txt)' }}
						</button>
						<button  @click="ExportData(chathistory,exportTXTFileName,'plain')" :disabled="btnDisabledState_Export" class="btn" style="margin: 2px 5px 4px 0px;" :style="{ minWidth: settingsLanguage == 'cn' ? '240px' : '230px' }">
							<svg xmlns="http://www.w3.org/2000/svg" width="19" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/>
							</svg>&nbsp;&nbsp;{{ settingsLanguage == 'cn' ? '导出聊天记录_全部 (.txt)' : 'Export All Chat History (.txt)' }}
						</button>
					</div> 
					<div class="panelrow" style="align-items: center; height:auto;">
						<div class="control-container" style="flex: 1 1 0%;">
							<span style="width:100%;">{{ settingsLanguage == 'cn' ? '关于导出数据：点击[?]了解详情' : 'About Export Data: Click [?] for more information.' }}</span>
						</div>
					</div> 
				</div>
			
  
			<!-- End:  A: 主体内容 content -->  
			</div>
	  	<!-- End:  A: dialog -->  
	    </div>
	
		<!-- dialog-mask -->
	    <div class="dialog-mask" @click="isShowDialog_Settings = false">
		</div>
	
	<!-- End:  dialog-wrapper A: 设置 Settings -->  
	</div>
 
 
 
	<!-- dialog-wrapper B: 提示词 Prompt Generator -->  
	<div id="dialog-promptgenerator" class="dialog-wrapper" v-show="isShowDialog_PromptGenerator">
		<!-- B: dialog -->  
		<div class="dialog" style="max-width: 95%;">
			<!-- B: 标题 header -->  
			<div class="dialog-header">
				<div class="dialog-title" >
					<svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round">
						<path d="M19.7,23.5H4.3c-2.1,0-3.8-1.7-3.8-3.8V4.3c0-2.1,1.7-3.8,3.8-3.8h15.3c2.1,0,3.8,1.7,3.8,3.8v15.3    C23.5,21.8,21.8,23.5,19.7,23.5z M4.3,1.5c-1.6,0-2.8,1.3-2.8,2.8v15.3c0,1.6,1.3,2.8,2.8,2.8h15.3c1.6,0,2.8-1.3,2.8-2.8V4.3    c0-1.6-1.3-2.8-2.8-2.8H4.3z"/>
						<path d="M10.4,19.2H7.3c-0.3,0-0.5-0.2-0.5-0.5V5.3c0-0.3,0.2-0.5,0.5-0.5h9.3c0.3,0,0.5,0.2,0.5,0.5v8.5c0,0.3-0.2,0.5-0.5,0.5    h-5.7v4.4C10.9,19,10.7,19.2,10.4,19.2z M7.8,18.2h2.1v-4.4c0-0.3,0.2-0.5,0.5-0.5h5.7V5.8H7.8V18.2z M13.6,11.2h-3.2    c-0.3,0-0.5-0.2-0.5-0.5V8.4c0-0.3,0.2-0.5,0.5-0.5h3.2c0.3,0,0.5,0.2,0.5,0.5v2.3C14.1,11,13.9,11.2,13.6,11.2z M10.9,10.2h2.2    V8.9h-2.2V10.2z"/>
					</svg>
					{{ settingsLanguage == 'cn' ? '&nbsp;提示词&nbsp;' : '&nbsp;Prompt Generator&nbsp;' }}
					<button @click="changePromptGeneratorLayout"  class="btn bluebtn" style="width: 23px; padding: 0px 1px; height: 20px;" >
						<div>
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
						</div>
					</button>	
				</div>
				<div class="dialog-close" @click="isShowDialog_PromptGenerator = false">
					<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: none; stroke: #333; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
						<path d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</div>
			</div>
		  
			<!-- B: 主体内容 content -->  
			<div class="dialog-content" :style="styleDialogLayout">
		
				<!-- panelgroup: 当前系统提示词  Current System Prompt --> 
				<div class="panelgroup">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? '当前系统提示词 ( system prompt )' : 'Current System Prompt' }} </span>
						<button  @click="showMiniHelp('B-CurrentSystemPrompt')"  class="btn minibtn bluebtn" style="margin-right: auto;">?</button>
					</div>
				
					<div class="panelrow" style="align-items: end; height:auto;flex-wrap: wrap;">
						<!-- 复制到编辑区 --> 
						<button @click="copySystemPromptToEditor" class="btn" style="margin-left: 5px;">
							{{ settingsLanguage == 'cn' ? '复制到编辑框' : 'Copy To Editor' }}
						</button>	
						<!-- 展开 -->
						<button @click="changeElementHeight('textareaSPReadOnly')" class="btn bluebtn" style="width: 25px;padding: 0px 2px;">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10">
								<path d="m28,30l-24,0c-1.1,0 -2,-0.9 -2,-2l0,-24c0,-1.1 0.9,-2 2,-2l24,0c1.1,0 2,0.9 2,2l0,24c0,1.1 -0.9,2 -2,2z" id="svg_1"></path>
								<line id="svg_2" x1="20" x2="20" y1="2" y2="30"></line><polyline points="27,24 25,26 23,24 "></polyline><polyline points="23,8 25,6 27,8 "></polyline><line x1="6" x2="16" y1="9" y2="9"></line><line x1="6" x2="12" y1="13" y2="13"></line><line x1="6" x2="12" y1="17" y2="17"></line>
							</svg>
						</button>
						<!-- 换行视图 -->
						<button @click="changeElementLineBreak('textareaSPReadOnly')" class="btn bluebtn" style="margin-right: auto;width: 25px;padding: 0px 2px;">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10">
								<path d="m2,28l0,-24c0,-1.1 0.9,-2 2,-2l24,0c1.1,0 2,0.9 2,2l0,24c0,1.1 -0.9,2 -2,2l-24,0c-1.1,0 -2,-0.9 -2,-2z" id="svg_1"/></path>
								<line x1="30" x2="2" y1="20" y2="20"/></line><polyline points="8,27 6,25 8,23 "/></polyline><polyline points="24,23 26,25 24,27 "/></polyline><line x1="6" x2="16" y1="9" y2="9"/></line><line x1="6" x2="12" y1="13" y2="13"/></line>
							</svg>
						</button>	
						<!-- 一键复制api-key  Cpoy api-key --> 
						<button class="copybtn" data-clipboard-nextelementsibling="" style="opacity: 1;position: relative;flex-shrink: 0;top: auto;right: auto;margin:0 5px 0 0 ;">
							<div>
								<svg width="14" height="17" class="clippy" fill="currentColor">
									<path d="m2.36373,12.61912l4.12233,0l0,1.03058l-4.12233,0l0,-1.03058zm5.15291,-6.18349l-5.15291,0l0,1.03058l5.15291,0l0,-1.03058zm2.06116,3.09174l0,-2.06116l-3.09174,3.09174l3.09174,3.09174l0,-2.06116l5.15291,0l0,-2.06116l-5.15291,0zm-4.63761,-1.03058l-2.57645,0l0,1.03058l2.57645,0l0,-1.03058zm-2.57645,3.09174l2.57645,0l0,-1.03058l-2.57645,0l0,1.03058zm9.27523,1.03058l1.03058,0l0,2.06116c-0.0161,0.28985 -0.11272,0.53139 -0.30595,0.72463s-0.43478,0.28985 -0.72463,0.30595l-10.30581,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058l0,-11.33639c0,-0.5636 0.46698,-1.03058 1.03058,-1.03058l3.09175,0c0,-1.1433 0.91786,-2.06116 2.06116,-2.06116s2.06116,0.91786 2.06116,2.06116l3.09174,0c0.5636,0 1.03058,0.46698 1.03058,1.03058l0,5.15291l-1.03058,0l0,-3.09174l-10.30581,0l0,9.27523l10.30581,0l0,-2.06116zm-9.27523,-8.24465l8.24465,0c0,-0.5636 -0.46698,-1.03058 -1.03058,-1.03058l-1.03058,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058s-0.46698,-1.03058 -1.03058,-1.03058s-1.03058,0.46698 -1.03058,1.03058s-0.46698,1.03058 -1.03058,1.03058l-1.03058,0c-0.5636,0 -1.03058,0.46698 -1.03058,1.03058z">
									</path>
								</svg>
							</div>
						</button> 
				 
						<!-- 输入框(只读) - 当前系统提示词 --> 
						<textarea readonly v-model="gptSystemPromptReadOnly"  type="text"  class="dh-input textareaSPReadOnly" style="flex: 0 0 100%;margin: 4px 0 0 0;height:100px;min-height:80px;max-height: 1000px;" placeholder=""></textarea>		
					</div>
				</div>			
			
				<!-- panelgroup: 提示词编辑区  Edit Prompts -->
				<div class="panelgroup">
					<div class="panelgroup-head">
					    <span>{{ settingsLanguage == 'cn' ? '提示词编辑区' : 'Prompt Editor' }}</span>
						<button  @click="showMiniHelp('B-PromptEditor')"  class="btn minibtn bluebtn" style="margin-right: auto;">?</button>
					</div>
				
					<div class="panelrow" style="align-items: end; height:auto;flex-wrap: wrap;">
						<!-- 保存为系统提示词 更新系统提示词 --> 
						<button @click="setSystemPrompt" :disabled="btnDisabledState_SetSystemPrompt" class="btn" style="margin-left: 5px;"  >
							{{ settingsLanguage == 'cn' ? '保存为系统提示词' : 'Save as System Prompt' }}
						</button>
					
						<!-- 展开  display:none; 等待修改。。。未完成 111111111111111 --> 
						<button @click="changeElementHeight('textareasystemprompt')" class="btn bluebtn" style="display:none;  width: 25px;padding: 0px 2px;">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10">
								<path d="m28,30l-24,0c-1.1,0 -2,-0.9 -2,-2l0,-24c0,-1.1 0.9,-2 2,-2l24,0c1.1,0 2,0.9 2,2l0,24c0,1.1 -0.9,2 -2,2z" id="svg_1"></path>
								<line id="svg_2" x1="20" x2="20" y1="2" y2="30"></line><polyline points="27,24 25,26 23,24 "></polyline><polyline points="23,8 25,6 27,8 "></polyline><line x1="6" x2="16" y1="9" y2="9"></line><line x1="6" x2="12" y1="13" y2="13"></line><line x1="6" x2="12" y1="17" y2="17"></line>
							</svg>
						</button>	
						<!-- 换行视图 --> 
						<button @click="changeElementLineBreak('textareasystemprompt')" class="btn bluebtn" style="margin-right: auto;width: 25px;padding: 0px 2px;">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10">
								<path d="m2,28l0,-24c0,-1.1 0.9,-2 2,-2l24,0c1.1,0 2,0.9 2,2l0,24c0,1.1 -0.9,2 -2,2l-24,0c-1.1,0 -2,-0.9 -2,-2z" id="svg_1"/></path>
								<line x1="30" x2="2" y1="20" y2="20"/></line><polyline points="8,27 6,25 8,23 "/></polyline><polyline points="24,23 26,25 24,27 "/></polyline><line x1="6" x2="16" y1="9" y2="9"/></line><line x1="6" x2="12" y1="13" y2="13"/></line>
							</svg>
						</button>	
						<!-- 一键复制api-key  Cpoy api-key --> 
						<button class="copybtn" data-clipboard-nextelementsibling="" style="opacity: 1;position: relative;flex-shrink: 0;top: auto;right: auto;margin:0 5px 0 0 ;">
							<div>
								<svg width="14" height="17" class="clippy" fill="currentColor">
									<path d="m2.36373,12.61912l4.12233,0l0,1.03058l-4.12233,0l0,-1.03058zm5.15291,-6.18349l-5.15291,0l0,1.03058l5.15291,0l0,-1.03058zm2.06116,3.09174l0,-2.06116l-3.09174,3.09174l3.09174,3.09174l0,-2.06116l5.15291,0l0,-2.06116l-5.15291,0zm-4.63761,-1.03058l-2.57645,0l0,1.03058l2.57645,0l0,-1.03058zm-2.57645,3.09174l2.57645,0l0,-1.03058l-2.57645,0l0,1.03058zm9.27523,1.03058l1.03058,0l0,2.06116c-0.0161,0.28985 -0.11272,0.53139 -0.30595,0.72463s-0.43478,0.28985 -0.72463,0.30595l-10.30581,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058l0,-11.33639c0,-0.5636 0.46698,-1.03058 1.03058,-1.03058l3.09175,0c0,-1.1433 0.91786,-2.06116 2.06116,-2.06116s2.06116,0.91786 2.06116,2.06116l3.09174,0c0.5636,0 1.03058,0.46698 1.03058,1.03058l0,5.15291l-1.03058,0l0,-3.09174l-10.30581,0l0,9.27523l10.30581,0l0,-2.06116zm-9.27523,-8.24465l8.24465,0c0,-0.5636 -0.46698,-1.03058 -1.03058,-1.03058l-1.03058,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058s-0.46698,-1.03058 -1.03058,-1.03058s-1.03058,0.46698 -1.03058,1.03058s-0.46698,1.03058 -1.03058,1.03058l-1.03058,0c-0.5636,0 -1.03058,0.46698 -1.03058,1.03058z">
									</path>
								</svg>
							</div>
						</button>
					
						<!-- 输入框 - 编辑提示词. new:  style="margin: 0;height:100px;min-height:80px;max-height: 1000px;" --> 
						<textarea @input="btnDisabledState_SetSystemPrompt=false;"  @blur="textareaSystemPrompt_blur" @focus="textareaSystemPrompt_focus"  v-model="gptSystemPrompt"  type="text"  class="dh-input textareasystemprompt" style="flex: 0 0 100%;margin: 4px 0 0 0;height: 108px;min-height: 108px;max-height: 108px;z-index:900003" :placeholder=" settingsLanguage == 'cn' ? '输入提示词，保存后生效。如需取消系统提示词，请清空并保存。' : 'Enter the prompt and save to take effect. Clear and save to cancel the system prompt.' " ></textarea>		
					</div>
				</div>
 
 
   
			<!-- End:  B: 主体内容 content -->  
			</div>
	  	<!-- End:  B: dialog -->  
	    </div>
	
		<!-- dialog-mask -->
	    <div class="dialog-mask" @click="isShowDialog_PromptGenerator = false">
		</div>
	
	<!-- End:  dialog-wrapper B: 设置 Settings -->  
	</div>



	<!-- Notification Z: 消息通知 Notification -->
	<div v-show="isShowNotification" class="notification">
		<div class="notification-wrapper" :class="{'notification-center': isNotificationHasMask, 'notification-bottom': !isNotificationHasMask }">
			<!-- Z: 标题 header :Only center -->  
			<div :style="{ display: isNotificationHasMask ? 'block' : 'none' }" style="position: relative;height: 25px;padding: 2px 16px;">
				<div class="dialog-title" style="color: #664909;font-weight:600;">
					{{setNotificationTitle}}
				</div>
				<div class="dialog-close" @click="isShowNotification = false" style="color: #664909;width: 18px;height: 18px;">
					<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: none; stroke: #333; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
						<path d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</div>
			</div>
		
			<!-- Z: 内容 content-->
			<div class="notification-content" :class="{'notification-content-center': isNotificationHasMask, 'notification-content-bottom': !isNotificationHasMask }">
				<!-- Z: 复制按钮 Copy btn -->  
				<button class="copybtn btncopynotification" :style="{ display: isNotificationHasMask ? 'block' : 'none' }" data-clipboard-nextelementsibling="" style="opacity: 1; position: fixed; flex-shrink: 0; top: 7px; right: 40px; width: 25px; height: 25px;color: #664909; border: 1px solid #cfd450; background-color: #e5e881; background-image: linear-gradient(#fdffb4, #e5e881);">
					<div>
						<svg width="14" height="17" class="clippy" fill="currentColor">
							<path d="m2.36373,12.61912l4.12233,0l0,1.03058l-4.12233,0l0,-1.03058zm5.15291,-6.18349l-5.15291,0l0,1.03058l5.15291,0l0,-1.03058zm2.06116,3.09174l0,-2.06116l-3.09174,3.09174l3.09174,3.09174l0,-2.06116l5.15291,0l0,-2.06116l-5.15291,0zm-4.63761,-1.03058l-2.57645,0l0,1.03058l2.57645,0l0,-1.03058zm-2.57645,3.09174l2.57645,0l0,-1.03058l-2.57645,0l0,1.03058zm9.27523,1.03058l1.03058,0l0,2.06116c-0.0161,0.28985 -0.11272,0.53139 -0.30595,0.72463s-0.43478,0.28985 -0.72463,0.30595l-10.30581,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058l0,-11.33639c0,-0.5636 0.46698,-1.03058 1.03058,-1.03058l3.09175,0c0,-1.1433 0.91786,-2.06116 2.06116,-2.06116s2.06116,0.91786 2.06116,2.06116l3.09174,0c0.5636,0 1.03058,0.46698 1.03058,1.03058l0,5.15291l-1.03058,0l0,-3.09174l-10.30581,0l0,9.27523l10.30581,0l0,-2.06116zm-9.27523,-8.24465l8.24465,0c0,-0.5636 -0.46698,-1.03058 -1.03058,-1.03058l-1.03058,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058s-0.46698,-1.03058 -1.03058,-1.03058s-1.03058,0.46698 -1.03058,1.03058s-0.46698,1.03058 -1.03058,1.03058l-1.03058,0c-0.5636,0 -1.03058,0.46698 -1.03058,1.03058z">
							</path>
						</svg>
					</div>
				</button> 
		
				<!-- Z: 消息内容 提示框内容 Message -->  
				<span>{{setNotificationContent}}</span>
			
				<!-- Z: 小按钮 关闭  :Only bottom -->
				<div @click="isShowNotification = false" :style="{ display: !isNotificationHasMask && isNotificationBottomShowCloseBtn ? 'block' : 'none' } " style="cursor: pointer; margin-left: 5px;margin-right: -3px; font-size: 12px;">×</div>
			</div>
		</div>
  	
		<!-- Z: 遮罩 Mash :Only center -->  
		<div class="notification-mask" v-show="isNotificationHasMask" @click="isShowNotification = false" ></div>
	<!-- End:  Notification Z: 消息通知 Notification --> 
	</div>


<!-- End:  #app -->  
</div>


<script>
	//Vue备选CDN(线路3) 再次检测，确保vue的正确加载。
	!window.Vue && document.write(unescape('%3Cscript src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"%3E%3C/script%3E') );
  
  	//*当用户使用过时的旧版本浏览器访问时，会出现不支持的情况（不支持新的js代码/不支持新版vue.js） When accessing with an old version of browser, it may not be supported (not supporting ES6 |  not supporting new version of Vue.js).
	//定时器：10秒后添加按钮  Add button after 10 seconds.
	var timermask = setTimeout(function() {
		var loadingMask = document.getElementById("loading-mask");
		if (loadingMask) {
			var maskfirstChild = loadingMask.firstChild;
			if (maskfirstChild) {
				loadingMask.removeChild(maskfirstChild);
			}
			var maskbutton = document.createElement("button");
			maskbutton.innerHTML = "页面加载时间较长，您可以尝试刷新页面或检查网络连接是否畅通。<br>[点击我]点击文本可以隐藏遮罩，查看网页。若出现布局错误或乱码，可能是因为浏览器或设备版本过旧，请尝试使用更新的浏览器版本。<br>Page loading is slow. Please refresh the page or check your internet connection.<br>Click [here] to hide the mask and view the webpage. If the layout is incorrect or displays gibberish, try using a newer browser version or device.";
			maskbutton.onclick = displaymaskbtn; 
			loadingMask.appendChild(maskbutton); 
		}
		clearTimeout(timermask);
	}, 10000);
	// 隐藏遮罩
	function displaymaskbtn() {
		var loadingMask = document.getElementById("loading-mask");
		if (loadingMask) {
			loadingMask.classList.add('dialog-wrapper-hide');
		}
	}
</script>

<script>
//一键复制按钮的提示框 Tooltips for Copy Button. by clipboardjs  https://clipboardjs.com/assets/scripts/tooltips.js
//这段js放前面：网页加载过快会导致添加监听事件失败。This JS code should be placed at the beginning: If the webpage loads too quickly, listener events may fail to be added.

	//当前语言 Current Language。 全局变量。 Global variable.
	window.currentlang = 'cn';
	
	function addEventListenerCopyBtnTooltip(btn) {
	   btn.addEventListener('mouseleave', clearCopyBtnTooltip);
	   btn.addEventListener('blur', clearCopyBtnTooltip);
	}
	function clearCopyBtnTooltip(e) {
	    e.currentTarget.setAttribute('class', 'copybtn');
	    e.currentTarget.removeAttribute('aria-label'); 
	}
	//提示框方向的样式 directionClass: https://primer.style/css/components/tooltips
	function showCopyBtnTooltip(elem, msg, directionClass) {
	    elem.setAttribute('class', 'copybtn tooltipped ' + directionClass); 
	    elem.setAttribute('aria-label', msg); 
	}
	function fallbackCopyBtnMessage(action) {
	    let actionMsg = '';
		actionMsg = window.currentlang == 'cn' ? '无数据 ' : 'No data' ; //去除“不支持” Delete “No support”
		//actionMsg = window.currentlang == 'cn' ? '无数据 / 不支持' : 'No data / No support' ; 
	    return actionMsg;
	}
</script>

<script>
	if(!window.Vue){ alert("错误：\r\nVue.js加载失败，将无法使用GPT！请检查网络后刷新页面。\r\n\r\nError:\r\nFailed to load plugin Vue.js. The GPT will be unavailable. Please check your network and refresh the page to try again.") };
	
    const { createApp } = Vue;
    createApp({
        data() {
            return {
			
                api: '',  //可修改 Editable - 单引号内可以留空，或填入默认的API-Key。  You can leave it blank or enter the default API key.
                //!!Reminder: If your project is hosted on GitHub, do not enter the plaintext OpenAI API key here! GitHub will trigger OpenAI to automatically invalidate the API key and generate a new one.
				//api修改提醒：html文件若要上传到GitHub，这里不能填api-key的明文！api-key会自动失效。原因如下：
				//     虚拟主机/服务器/Gitee等都可以填入api-key明文，只有GitHub不行，猜测原因是：GitHub被微软收购，微软亦是OpenAI的大股东，GitHub一旦检测到代码里有GPT的api-key，会联动OpenAI的后台取消这个key，并生成新key 。
                //api修改请注意：HTML代码没有加密。如果只是下载到电脑本地使用，那这里填写的API-Key不存在泄露风险。如果要上传网页到虚拟主机/服务器/Gitee免费托管，未加密的代码存在有泄漏API-Key的风险。

                btnDisabledState_Sending: true,
                btnDisabledState_CheckAPI: false,
                btnDisabledState_SetSystemPrompt: true,
                btnDisabledState_Clear: true,
                btnDisabledState_Undo: true,
                btnDisabledState_Export: true,
				btnDisabledState_ApiURL: false,
				btnDisabledState_Language: false,
				btnDisabledState_ContextualMode: false,
				btnDisabledState_updateUserImageUrl: true,
				btnDisabledState_updateGPTImageUrl: true,
                sentext: '先验证API', // Check API first
                apibtntext:  '<< 验证', // Check API key
				timerId: null,
				hasSystemPromptBeenSaved: false,
				userMsgTokensForRetry: 0, //int 临时记录重问时的tokens数据
				isRetry_RetryMessage: '', //重问时传递重问的内容，避免使用this.msg
				isfirstclickonchatinputbox: true, //是否首次点击聊天输入框，防止重复激活点击事件
				succQA_Count: 0, //int 当前有效的上下文数量，一问一答succQA_Count = 2 。 数量变化对应this.msgContent
                totaltokens: 0, //int
				isShowTotaltokensSVG : true, //Total Tokens 图标
				isShowTotaltokensLabel : true, //Total Tokens 文字
				isShowQACountLabel: true, //Q&A Count  文字
				isSimpleMode: true,  //网页开启简约模式，始终不显示部分文字。 The webpage is in simplified mode and does not display some text content.
				isSendingNow: false, //是否正在发送消息
				isCheckingApiKeyNow:false, //是否正在验证api-key
				
				
				msgList: [{
                    msg: "",   //这里不填内容！ Do not fill in!
                    my: false,
					datetime: "2000-01-01 00:00:00"
                }],
				apitemperature: 0.7, //（0.0～2.0）接口参数 temperature 默认0.7 (官方默认1.0) v-model.number
				apiMaxTokens:2048, //（1～4096）接口参数 max_tokens 默认2048 v-model.number
				apiTopP:1, // （0.0～1.0）接口参数 top_p 官方默认1 v-model.number
				apiPresencePenalty:0, //（-2.0～2.0）接口参数 presence_penalty 官方默认0 v-model.number
				apiFrequencyPenalty:0, //（-2.0～2.0）接口参数 frequency_penalty 官方默认0 v-model.number
				
				apiGPTModel: 'gpt-3.5-turbo', // 接口参数 model 默认'gpt-3.5-turbo'
			    gptModelOptions: [
			      { label: 'ChatGPT', model: 'gpt-3.5-turbo' },
			      { label: 'gpt-3.5-turbo-0301', model: 'gpt-3.5-turbo-0301' }
			    ],
				
				//仅支持/v1/chat/completions类型接口url。 接口与模型的关系 https://platform.openai.com/docs/models/model-endpoint-compatibility
				apiURL: 'https://api.openai.com/v1/chat/completions',  // 接口参数 接口网址 默认官方接口'https://api.openai.com/v1/chat/completions'
				inputApiURL: '',  //Input值
				selectedApiURL: '',  //selected值
				apiURLOptions_cn: [
			      { label: '官方  GPT官方 需魔法 稳定 限制少', url: 'https://api.openai.com/v1/chat/completions' },
			      { label: '国内  A 第三方 免魔法 6月可用', url: 'https://api.openai-proxy.com/v1/chat/completions' }
			    ],
				apiURLOptions_en: [
			      { label: 'GPT  OpenAI API. Official.', url: 'https://api.openai.com/v1/chat/completions' },
			      { label: '中国  A Third-party APIs. 免魔法 6月可用', url: 'https://api.openai-proxy.com/v1/chat/completions' }
			    ],
				

				
				styleDialogLayout: { padding: '20px 20px 20px 20px' },
				gptSystemPromptReadOnly: '', //当前系统提示词 只读
				isShowDialog_Settings: false, //是否显示设置窗口
				isShowDialog_PromptGenerator: false, //是否显示提示词窗口
				
				lastCheckApiTime: 0, // 记录上一次验证api-key的时间，4秒内只能发送一次验证请求
				//记录已验证的api-key、对应的接口url等，目前仅记录前3项，刷新网页后数据清空；未来可尝试：增加快捷切换'自有可用的key'的操作，与url搭配，实现不同组合随时切换；可增加共享key的功能，不会上传key，但可以通过链接追加网络key到本地数组里，owner=网络/共享。
				apiCheckedData: [{ 
                    apikey: '',	
                    apiurl: '',	
					date1: 0,
					date2: 0,
					date3: 0,
					level: 1,
					freq: 0,
					vpn: '',
					owner: 'me'
                }],
				
				
				//**常规设置第一排
				//语言设置 
				settingsLanguage: 'cn', //默认语言为中文 Language,  Chinese-Simplified = cn
			    settingsLanguageOptions: [
					{ label: '中文', lang: 'cn' },
					{ label: 'English', lang: 'en' }
			    ],
				//字体大小设置 默认14px
				settingsFontSize: 14, //数字 数值型
			    settingsFontSizeOptions: [
					{ label: '9', fontsize: 9 },
					{ label: '10', fontsize: 10 },
					{ label: '11', fontsize: 11 },
					{ label: '12', fontsize: 12 },
					{ label: '13', fontsize: 13 },
					{ label: '14', fontsize: 14 },
					{ label: '15', fontsize: 15 },
					{ label: '16', fontsize: 16 },
					{ label: '17', fontsize: 17 },
					{ label: '18', fontsize: 18 },
					{ label: '19', fontsize: 19 },
					{ label: '20', fontsize: 20 },
					{ label: '21', fontsize: 21 },
					{ label: '22', fontsize: 22 },
					{ label: '23', fontsize: 23 },
					{ label: '24', fontsize: 24 },
					{ label: '25', fontsize: 25 },
					{ label: '26', fontsize: 26 },
					{ label: '27', fontsize: 27 },
					{ label: '28', fontsize: 28 },
					{ label: '29', fontsize: 29 }
			    ],
				//是否显示时间(微信样式) 默认显示
				settingsTime_WechatStyle: true,
			    settingsTimeWechatStyleOptions_cn: [
					{ label: '显示', displaytime: true },
					{ label: '不显示', displaytime: false }
				],
				settingsTimeWechatStyleOptions_en: [
					{ label: 'Show', displaytime: true },
					{ label: 'Hide', displaytime: false }
			    ],
				//是否显示时间(消息) 默认不显示
				settingsTime_Message: 1, // 数字，数值型 代表三种状态 state.  1:hide ; 2:show height:0 ; 3:show height:+10
			    settingsTimeMessageOptions_cn: [
					{ label: '不显示', displaytime: 1 },
					{ label: '显示', displaytime: 2 },
					{ label: '显示(增大间距)', displaytime: 3 }
			    ],
			    settingsTimeMessageOptions_en: [
			    	{ label: 'Hide', displaytime: 1 },
					{ label: 'Show', displaytime: 2 },
					{ label: 'Show(Increase Spacing)', displaytime: 3 }
			    ],
				//是否显示分割线 默认显示
				settingsDividerLine: true, 
			    settingsDividerLineOptions_cn: [
					{ label: '显示', displaydividerline: true },
					{ label: '不显示', displaydividerline: false }
				],
				settingsDividerLineOptions_en: [
					{ label: 'Show', displaydividerline: true },
					{ label: 'Hide', displaydividerline: false }
			    ],
				
				//**常规设置第二排 
				//上下文模式 默认连续对话  待开发  目前只有：不限制  1. 0-不限制 ；2. 固定次数后自动清空 ； 3. 永远保留最后几条的记录
				settingsContextualMode: 0, // 数字，数值型 0代表连续对话，其他代表固定次数后会自动清空记忆，即 1 = 1*Q&A ; 2 = 2*Q&A *考虑如果只是次数到了自动清空，这个意义不是很大。最好是永远保留最后几次的上下文，这样的设置会更实用，能结合压缩上下文就更好了。这个功能待开发。。。
			    settingsContextualModeOptions_cn: [
					{ label: '不限制', mode: 0 }
			    ],
			    settingsContextualModeOptions_en: [
					{ label: 'No Limit', mode: 0 }
			    ],
				
				//是否开启验证API-KEY的快捷键 （电脑端使用） 默认开启
				settingsShortcut_CheckApiKey: true, 
			    settingsShortcutCheckApiKeyOptions_cn: [
					{ label: 'F2', shortcut: true },
					{ label: '无', shortcut: false }
				],
				settingsShortcutCheckApiKeyOptions_en: [
					{ label: 'F2', shortcut: true },
					{ label: 'None', shortcut: false }
			    ],
				
				//是否开启 清空 的快捷键 （电脑端使用） 默认关闭
				settingsShortcut_Clear: false, 
			    settingsShortcutClearOptions_cn: [
					{ label: 'F1', shortcut: true },
					{ label: '无', shortcut: false }
				],
				settingsShortcutClearOptions_en: [
					{ label: 'F1', shortcut: true },
					{ label: 'None', shortcut: false }
			    ],
				
				//是否开启 撤销 的快捷键 （电脑端使用） 默认关闭
				settingsShortcut_Undo: false, 
			    settingsShortcutUndoOptions_cn: [
					{ label: 'F3', shortcut: true },
					{ label: '无', shortcut: false }
				],
				settingsShortcutUndoOptions_en: [
					{ label: 'F3', shortcut: true },
					{ label: 'None', shortcut: false }
			    ],
				
				//是否开启 重问 的快捷键 （电脑端使用） 默认开启
				settingsShortcut_Retry: true, 
			    settingsShortcutRetryOptions_cn: [
					{ label: 'F4', shortcut: true },
					{ label: '无', shortcut: false }
				],
				settingsShortcutRetryOptions_en: [
					{ label: 'F4', shortcut: true },
					{ label: 'None', shortcut: false }
			    ],
				
				//**常规设置 头像  “Change-GPT-Green-SVG”是固定的，调用SVG的标识符。
				userAvatarURL: '',  // 当前user头像网址
				gptAvatarURL: '',   // 当前GPT头像网址
				inputUserImageUrl: '', // user input文本
				inputGPTImageUrl: '',  // GPT input文本
				selectedImageUrl: '',  // 预设头像库下拉框值
				userpresetImages: [
					{ name: 'Bilibili', url: 'https://lin2025.github.io/img/me-bili.jpg' },
					{ name: 'GPT:Black', url: 'https://openai.com/favicon.ico' } 
				],
				gptpresetImages: [
					{ name: 'GPT:Green', url: 'Change-GPT-Green-SVG' },
					{ name: 'GPT:Black', url: 'https://openai.com/favicon.ico' } //黑色头像没有将绿色SVG改色，而是选用官网的ico图标
				],
				isgptAvatarUrlShow: false,
				isgptGreenSvgShow: true, 
				GPTGreenSVG_UrlText_cn: 'GPT-Green-SVG *无网址，仅通过[GPT头像]更新', // GPT绿色SVG头像对应的显示的文本 cn
				GPTGreenSVG_UrlText_en: 'GPT-Green-SVG *No URL, only updated through [GPT Avatar].', // GPT绿色SVG头像对应的显示的文本 en
				
				
				//消息通知 tooltips弹窗 Notification tooltips
				isShowNotification: false, //是否显示通知 Show
			    setNotificationContent: '', //通知的内容 Message
			    isNotificationHasMask: false, //是否显示遮罩 Mask 
				isNotificationBottomShowCloseBtn: false,//bottom底部通知时，是否显示关闭按钮
			    setNotificationPosition: 'center', //通知样式 center中心 or bottom底部
				setNotificationTitle: '信息', //标题文字  Title 通知 信息 警告 提醒 错误 ...
				notificationTimeoutId: 0, // 上一个通知的定时器id
				

							
				//可修改 Editable - 网页上的第一条信息/欢迎语，不属于上下文。 这条信息只会在网页中显示，不会回传给服务器，不属于聊天记录。 
				// 示范{ thefirstmessage: "hi~ ", }  提醒：1、不能换行，但可以使用换行符{ \r\n }； 2、支持Markdown语法。
				// The First Message, This message is out of context,
				// Example{ thefirstmessage: "hi~ ", }  Tips：1.No line breaks. You can use the line break characters{ \r\n }.  2.Supports Markdown.
                thefirstmessage: "## **LinGPT** ***v6.09*** \r\n#### 功能升级，全新体验，稳定无报错\r\n各位大佬喜欢的话请赏颗`Star`吧 ～\r\nLinGPT - A GPT-3.5 Webpage with Just a Single HTML File \r\n> Change Language: [Settings] > [Language] \r\n```\r\nIf you like it, please give me a star on my GitHub repository.\r\n```\r\n[![](https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&logo=github&logoColor=white)](https://github.com/lin2025/gpt3.5/) [![](https://img.shields.io/badge/Gitee-C71D23?style=for-the-badge&logo=gitee&logoColor=white)](https://gitee.com/lin2025/gpt3.5/) " ,

				
				//可修改 Editable - 系统提示词。不填的话，gptSystemPrompt后面单引号内留空{ gptSystemPrompt: '', }，填写后，会出现在“提示词编辑器中”，验证key时会自动保存。
				// 下方这行设置gptSystemPrompt 是设置[默认的指令/提示词/人设]的第一种方法，指令写在单引号内。 如果默认指令写在这里，这个指令会显示在聊天界面的指令输入框中。 如果还设置有第二种隐形指令的话，以隐形指令为准，第一种会被忽略。
				// 保存到上下文数组msgContent中才能生效，不保存则不生效。
				// System Prompt(optional): Will be displayed in the "Prompt Editor".  If you fill in here, when checking the AIP-key, it will be automatically saved.
                gptSystemPrompt: '',
				
				
				//可修改 Editable - (一般不改，很少会用到隐形指令) 不填的话，单引号内留空，即： gptSystemPrompt_hidden: '',  
				// 下方这行设置gptSystemPrompt_hidden 是设置[默认的指令/提示词/人设]的第二种方法，指令写在单引号内。 第二种方法是[隐形指令/隐藏指令/隐形提示词/隐藏提示词]的写法。如果默认指令写在这里，这个指令不会显示在聊天界面的指令输入框中，指令是隐形的。 在本代码中搜索“隐形指令”可查看[添加 disabled 来禁止聊天界面上输入新指令]的方法。
				// 如果用第二种方法设置了[隐形指令]，那么GPT指令将以这里的[隐形指令]为准，会自动忽略聊天界面上的其他指令（包括空白的指令），不会叠加。
				// 设置隐形提示词后，提示词弹窗将被禁用，代码写在mounted()里
				// Hidden System Prompt, with the highest priority. Once set, the System Prompt will be based on the Hidden System Prompt, and the Prompt in the System Prompt input box will be invalid. 
				// If "gptSystemPrompt_hidden" is set, the Prompt Generator will be disabled. The judgment code is written in the mounted() method.
				gptSystemPrompt_hidden: '',
				
				
				//msgContent：上下文 context
                msgContent : [{"role": "system", "content": "" }] , 
				
				//msgTokens：对应msgContent记录每条消息的token数量 Synchronize updates with 'msgContent' and record tokens data for each message.  role: AI & user. 
				//completion_tokens：单条消息的tokens数量 Tokens for a single message.
				//total_tokens：截止当前消息的tokens总数 Current total tokens.
				//永远保留第一条记录[0]，对应msgContent[0]
				//role: AI & user. 
				msgTokens : [{"role": "AI", "completion_tokens": 0, "total_tokens": 0 }] , //tokens:int
				
				msg: "", //输入的消息 message  聊天输入框 chat input box
                msgContentForMsgList_SingleRound : [{"role": "system", "content": "", "datetime": "2000-01-01 00:00:00" }] , //与msgContent的不同点：1.会保留未撤销的发送失败的数据；2.数据与msgList的最后一轮对话对应；3.记录时间。 Differences from msgContent: 1. Failed messages that have not been undone will be retained; 2. Data corresponds to msgList (New Chat, Only single round); 3.Add datetime。
                chatHistoryPromptOnlyUseBackticks: false , //导出的聊天记录中，系统提示词的markdown语法处理方式。 true:仅用"代码块"包裹  false:自动判断使用"引用"或者"代码块"包裹
				chathistory: '# GPT聊天记录 / Chat History  \r\n\r\n',
                exportTXTFileName:"GPT_ChatHistory", //导出全部历史记录的文件名
				exportTXTFileName_SingleRound:"GPT_ChatHistory_single", //导出单轮历史记录的文件名
				exportJSONFileName:"GPT_ChatData"
				
            }
        },
        methods: {
			//按钮：导出所有对话 Export chat history  filetype:'markdown'(.md) or 'plain'(.txt)
			ExportData(filecontent, filename, filetype){
				// 创建Blob对象并生成下载链接
				const blob = new Blob([filecontent], { type: 'text/' + filetype });
				const urlObject = window.URL || window.webkitURL || window ;	
				const url = urlObject.createObjectURL(blob);
				// 创建下载链接并自动下载
				const downloadLink = document.createElement('a');
				downloadLink.href = url;
				const now = new Date();
				filename = filename + ' ' +  this.formatDateYYYYMMDDHHmmss(now,'.').slice(5) ; // like “10-14 10.23.45”
				filename = filetype == 'markdown' ? filename + '.md' : filename + '.txt';
				downloadLink.download = filename;
				downloadLink.click();
  			}, 
			//按钮：导出最后一轮  showtime是否导出时间  exportprompt是否导出提示词  onlyusebackticks提示词是否只使用反引号包裹  filetype:'markdown'(.md) or 'plain'(.txt)
			ExportData_SingleRound(showtime, exportprompt, onlyusebackticks, filetype){

				if (this.checkBusyStatus()) {
					// 如果返回 true，正在发送或正在验证
					return;
				} 
				//发送中的状态不允许导出，所以当上下文this.msgContent的长度>=3时，表示存在有效问答（单轮）
				if( this.msgContent.length < 3 ){
					//不存在发送成功的聊天记录
					let notif = this.settingsLanguage == 'cn' ? '不存在有效的聊天记录，无数据可导出。 *仅支持导出本轮上下文记忆' : "No valid context records found. Cannot export data. Only current round's context can be exported." ; //存在单引号
					this.showNotification(notif, 'bottom', '', 5000);
					return;
				}
				let context = this.msgContentForMsgList_SingleRound ;
				let txt = '';
				let time = '';
				txt =  this.settingsLanguage == 'cn' ? '# GPT聊天记录\r\n\r\n' : '# Chat History\r\n\r\n';
	
				//如果需要导出提示词， 对提示词用markdown语法进行包裹， 语法自动选择用"引用"或者"代码块",
				//参数onlyusebackticks可以指定用代码块（导出后，若提示词很复杂导致了排版错乱，那么就可以设置onlyusebackticks为true）
				if ( exportprompt ) {
					const sys_prompt =  context[0]['content'].trim();  //context[0]与this.msgList[0]相同，同步更新。 context[0]['role'] = "system"
		
					//以下代码注释 详见addSystemPromptToChatHistory 
					let hasMultipleLines = /\r?\n\r?\n/.test(sys_prompt); 
					let backticks = this.findMaxBackticks(sys_prompt); 
					hasMultipleLines = backticks != '' ? true : hasMultipleLines ;
					backticks = backticks == '' ? '````' : backticks ; 
					if ( onlyusebackticks ) {
						hasMultipleLines = true;
					}
	
					let addMarkdownSyntaxStart = hasMultipleLines ? ( '\r\n' + backticks + '\r\n' ) : '\r\n> ' ;  // (> 后面有个空格)
					let addMarkdownSyntaxEnd = hasMultipleLines ? ( '\r\n' + backticks + '\r\n\r\n' ) : '\r\n\r\n' ; 
					let nullprompt = '';  //提示词为空的情况
					if( sys_prompt == '' ){
						nullprompt = this.settingsLanguage == 'cn' ? ': 空' : ': None' ; 
						addMarkdownSyntaxStart = '\r\n'; 
						addMarkdownSyntaxEnd = '\r\n' ;
					}
		
					const head = this.settingsLanguage == 'cn' ? '#### 系统提示词 system prompt ' : '#### #System Prompt ' ;
					txt += ( head + nullprompt + addMarkdownSyntaxStart + sys_prompt + addMarkdownSyntaxEnd );
				}
	
				//开始读取对话记录 
				for(let i = 1; i < context.length; i++) {
					if(context[i]['role'] === 'user') {
						if(i === context.length-1) {
							break; //最后一条记录，如果是user，说明是失败的，及没有[i+1],需要跳出循环
						}
						//排除掉发送失败的消息。判断下一条记录的role：发送失败的记录，下一条的role一定还是'user'；发送成功的记录，下一条的role一定是'assistant'。
						let nextRole = context[i+1]['role'];
						while(nextRole === 'user' && i+1 < context.length-1) {
							i++;
							nextRole = context[i+1]['role'];
						}
						if(nextRole === 'assistant') {
							//此时i是发送成功的user的消息 
							time = showtime ? (' _' + context[i]['datetime'] +  '_  \r\n') : ' \r\n';
							txt += this.settingsLanguage == 'cn' ? '**User**' : '**User**' ;
							txt += time;
							txt += context[i]['content'].replace(/\n/g, "\r\n") + '\r\n\r\n';
						}
					}else if(context[i]['role'] === 'assistant') {
						//gpt的回复
						time = showtime ? (' _' + context[i]['datetime'] +  '_  \r\n') : ' \r\n';
						txt += this.settingsLanguage == 'cn' ? '**GPT**' : '**GPT**' ;
						txt += time;
						txt += context[i]['content'].replace(/\n/g, "\r\n") + '\r\n\r\n';
					}
				}
		
				//导出 .md 或者 .txt
				this.ExportData(txt, this.exportTXTFileName_SingleRound, filetype);
			},
			
//按钮：导出所有 JSON  导入写好后，再开发下载。待开发。1111111111
ExportData_JSON(model, filename){
			
	let contentlist ;
	if (model == 'modelA'){
		contentlist = this.msgList;
	}
	// 获取聊天记录并将其转换为JSON格式的文本
	const chatLog = contentlist;
	const jsonText = JSON.stringify(chatLog);

	// 创建Blob对象并生成下载链接
	const blob = new Blob([jsonText], { type: 'application/json' });
	const url = URL.createObjectURL(blob);

	// 创建下载链接并自动下载
	const downloadLink = document.createElement('a');
	downloadLink.href = url;
	const now = new Date();
	filename = filename + ' ' +  this.formatDateYYYYMMDDHHmmss(now,'.').slice(5) + '.json' ; // like “10-14 10.23.45”
	downloadLink.download = filename; 
	downloadLink.click(); 
}, 
				
//按钮：导出最后一轮 JSON	 1111111111		
ExportData_SingleRound_JSON(time, prompt){

},							
			
//json 导入聊天记录 待开发。1111111111
importData_JSON(event) {

	//<!-- 测试 添加导入按钮 -->
	//<input type="file" @change="importData_JSON">
	//<!-- 测试  添加导出按钮 -->
	//<button @click="ExportData_JSON('modelA', exportJSONFileName)">导出导出导出导出 </button>

			
	//v-html 可以绑定实时渲染，试试看
	//gpt 在上面的代码中，我们使用了Vue.js提供的v-html指令将聊天记录中的HTML代码渲染为可显示的内容。具体实现中，我们首先遍历聊天记录中的每一条消息，然后根据消息的发送方显示不同的样式。在消息内容上，我们使用了v-html指令，将消息内容渲染为可显示的HTML代码。
	//需要注意的是，使用v-html指令时需要注意安全问题，确保渲染的代码来自可信的来源，并避免注入恶意代码。
			
	const file = event.target.files[0];
	if (!file) {
	  return;
	}

	const reader = new FileReader();
	reader.onload = () => {
		const chatLog = JSON.parse(reader.result);
		this.msgList = chatLog;
	  
		//渲染 usermsg
	 	this.$nextTick(() => {
			const divs = document.querySelectorAll('div.aimsg'); 
			const aa = this.msgList[2]['msg'] ; // ok ok ok 
	 		const lasttDiv = divs[divs.length-1]; 
			let ad = lasttDiv.innerHTML; // no no no
		    lasttDiv.innerHTML = aa ;  // ok ok ok  测试成功
											
			//读取本地缓存 或 手动导入json聊天记录 进行覆盖  渲染所有
			// 
	 	});
	  
		// 清除input元素的value属性
		event.target.value = '';
	};
				
	reader.readAsText(file);
},
  			
			//格式化时间  date时间 delimiter分隔符  分隔符为":"输出：2021-10-14 10:23:45  分隔符为"."输出：2021-10-14 10.23.45
			formatDateYYYYMMDDHHmmss(date,delimiter) {
				const year = date.getFullYear();
				const month = (date.getMonth() + 1).toString().padStart(2, '0');
				const day = date.getDate().toString().padStart(2, '0');
				const hour = date.getHours().toString().padStart(2, '0');
				const minute = date.getMinutes().toString().padStart(2, '0');
				const second = date.getSeconds().toString().padStart(2, '0');
				//ES6的写法：  return `${year}-${month}-${day} ${hour}${delimiter}${minute}${delimiter}${second}`;
				return year + '-' + month + '-' + day + ' ' + hour + delimiter + minute + delimiter + second; //兼容性更好。 Support more browsers.
			}, 
			//（DOM渲染之后）显示微信样式的时间。 判断时间间隔，跨度超过5分钟，返回当前时间戳，否则返回null。
			displayDatetime_WeChatStyle() {
				// try{ 1111111111111111111111111111111111111
					//需要>=2，至少发过一条信息，无论是否失败。 =2时，代表仅发出一条问题，超过5分钟才发出首条问题，这种情况也需要显示
					if(this.msgList.length < 2){
						return null;  
					}
					//直接获取倒数第2条记录的时间，无论是user还是ai。因为是在DOM渲染之后，所以是倒数第2 （length - 2）。最低为[0]
					//BUG日记：ios/macos, safari浏览器对new Date()存在兼容问题，safari不认"yyyy-MM-dd HH:mm:ss"格式的日期字符串，不识别“-”。
					let lastmsgdatetime = this.msgList[this.msgList.length - 2]["datetime"];
					lastmsgdatetime = lastmsgdatetime.replace(/-/g, "/") ;//转格式为yyyy/MM/dd HH:mm:ss ，兼容apple产品
					let lasttimestamp = new Date(lastmsgdatetime).getTime() / 1000 ; //获取指定时间lastmsgdatetime的时间戳，单位秒(s)
					let nowtimestamp = new Date().getTime() / 1000 ; //获取当前时间戳，单位秒(s)
				
					let min = (nowtimestamp - lasttimestamp) / 60;
					if( min > 5 ){
						return nowtimestamp;
					}else{
						return null;
					}
				// } catch{} 1111111111111111111111111111111111111
			},
			
			// 显示消息通知 通知提示框 tooltips	两种样式：position center or bottom			
			showNotification(content, position, title, bottomshowtime) {
			
				if (this.isShowNotification && this.notificationTimeoutId != -1) {
					clearTimeout(this.notificationTimeoutId);
					this.isShowNotification = false;
					this.notificationTimeoutId = -1;
				}

				//整体延时0.05秒 解决很多问题
				setTimeout(() => {
					this.setNotificationContent = content;
					this.setNotificationPosition = position;//其实可以用isNotificationHasMask直接代替setNotificationPosition
					this.isNotificationHasMask = position == 'center' ? true : false ; 
					this.notificationTimeoutId = position == 'center' ? -1 : this.notificationTimeoutId;
					if(title != null){
						this.setNotificationTitle = title.trim();
					}
					this.isShowNotification = true;
	  
					//Only bottom
					if (bottomshowtime == null){
						bottomshowtime = 1450; // 为空，默认显示1.45秒
					}	  
					this.isNotificationBottomShowCloseBtn = bottomshowtime > 2999 ? true : false ; //3秒或以上 显示关闭按钮
					if (position == 'bottom') {
						// 设置定时器并保存返回值给this.notificationTimeoutId
						this.notificationTimeoutId = setTimeout(() => {
								this.isShowNotification = false;
								this.notificationTimeoutId = -1;
							}, bottomshowtime);
					}
				}, 50);
			},
			//说明 帮助 小问号 mini Help
			showMiniHelp(position){
				let notif =  '';
				let title = '';
				let notifcn = '';
				let notifen = '';
				let text_help = this.settingsLanguage == 'cn' ? '帮助' : 'Help' ;
	
				switch(position) {
				  case 'B-CurrentSystemPrompt':
				  	notifcn = '显示当前的系统提示词。\r\n\r\n此为展示区，不可编辑。\r\n\r\n新建或修改请在编辑区操作，保存后生效。';
					notifen = 'Display the current system prompt.\r\n\r\nThis is a preview area and cannot be edited.\r\n\r\nTo create or modify system prompt, please operate in the [Prompt Editor].';
				  	title = '';
				    break;
				  case 'B-PromptEditor':
				  	notifcn = '可以在这里自由编辑提示词。\r\n\r\n未保存的提示词不会影响到[系统提示词]。';
					notifen = 'You can freely edit the prompt.\r\n\r\nUnsaved changes will not affect the system prompt.';
				  	title = '';
				    break;
				  case 'A-CheckAPIKey':
				  	notifcn = 'OpenAI API Key，即OpenAI的接口密钥，将密钥粘贴到输入框，然后开始验证。\r\n\r\n验证成功后才能开始聊天或查询API余额。\r\n\r\nAPI Key随时可改。\r\n\r\nAPI Key是什么样的？\r\nOpenAI公司的API Key是以“sk-”开头的一串密钥，例如 sk-bkR8V4tjmD7lXq9aZheZVpc6DtR8vw9VTYFJ1iaohMPpT3Bl\r\n\r\n如何获取官方的API Key？\r\n注册成功后，打开官方接口页面免费获取即可，地址 https://platform.openai.com/account/api-keys \r\n但是，国内IP无法直接注册OpenAI账号，网上有很多注册教程，其中最基础的条件是需要优质的魔法（"魔法"是一种可以让您的手机或电脑出趟国的技术，好的魔法会让OpenAI认为您的设备是真的在国外），满足这个条件就有机会免费注册账号并拥有API Key。\r\n\r\n附 常用的官方网址：\r\nOpenAI官网：https://openai.com \r\n查看API余额：https://platform.openai.com/account/usage \r\n官方版ChatGPT / GPT4：https://ai.com 或  https://chat.openai.com/auth/login \r\n';
					notifen = 'Enter OpenAI API Key and check.\r\n\r\nAfter checking, you can chat or check OpenAI API balance.\r\n\r\nAPI Key can be changed at any time.\r\n\r\nQ: What does API Key look like?\r\nA: It starts with "sk-", like this: sk-bkR8V4tjmD7lXq9aZheZVpc6DtR8vw9VTYFJ1iaohMPpT3Bl \r\n\r\nOpenAI: https://openai.com \r\nAPI Key: https://platform.openai.com/account/api-keys \r\nAPI balance: https://platform.openai.com/account/usage \r\nChatGPT / GPT4: https://ai.com or https://chat.openai.com/auth/login \r\n';
				  	title = '';
				    break;
				  case 'A-APISettings':
				  	notifcn = 'temperature：默认0.7，官方默认1.0。"温度"，用于控制GPT生成结果的随机性/多样性/创造力。[过低]会导致生成的文本更加保守和重复。[过高]会导致生成的文本更加随机和具有创造性（约1.2开始，就有几率出现无中生有的词/乱码）。\r\n\r\nmax_tokens: 生成结果时的最大token数，可随时调节。单轮对话上下文“已消耗的token数量”加上“max_tokens数量”不能超过模型的上下文长度（gpt3.5支持最高4096 tokens）。\r\n\r\nmodel: 模型，暂时仅支持gpt3.5模型。\r\n\r\n更多：点击设置更多API参数。 ';
					//含单引号
					notifen = "temperature: The 'temperature' setting controls how creative and diverse the text generated by GPT is. Lower values result in more repetitive and simpler text, while higher values result in more random and creative text. \r\n\r\nmax_tokens: The maximum number of tokens to generate in the chat completion. The total length of input tokens and generated tokens is limited by the model's context length (gpt3.5 support 4096).\r\n\r\nmodel: Only supports GPT3.5 for now.\r\n\r\nMore：Click to display more API parameter settings.\r\n\r\nAPI reference: \r\nhttps://platform.openai.com/docs/api-reference/chat/create ";
				  	title = '';
				    break;
				  case 'A-ProfessionalAPISettings':
				  	notifcn = '接口网址: 本代码仅支持GPT-3.5或更新版本的GPT模型，对应的接口网址应以“/v1/chat/completions”结尾，如OpenAI官方接口网址“ https://api.openai.com/v1/chat/completions ”，但也不排除第三方接口的网址结构有所改动。\r\n官方API接口需要魔法才能连接。第三方API有的需要魔法，有的不需要。\r\n有魔法的情况下，推荐使用官方接口，实际体验更好(连发3条不会报错)。免费gpt账号目前都有每分钟3次的调用限制(单key每分钟最多3次)，但官方接口使用起来明显更流畅，报错几率会低点。\r\n!! 第三方接口无法保证隐私安全，请自辨。\r\n!! "魔法"是一种可以让您的手机或电脑出趟国的技术。\r\n\r\n以下3个参数的说明见官网：\r\ntop_p: https://platform.openai.com/docs/api-reference/chat/create \r\npresence_penalty: https://platform.openai.com/docs/api-reference/chat/create \r\nfrequency_penalty: https://platform.openai.com/docs/api-reference/chat/create ';
					notifen = 'API URL: API Endpoint. The code only supports GPT-3.5 or newer versions of the model, and the API ENDPOINT URL should end in "/v1/chat/completions", like the official one "https://api.openai.com/v1/chat/completions" \r\n\r\ntop_p: https://platform.openai.com/docs/api-reference/chat/create \r\n\r\npresence_penalty: https://platform.openai.com/docs/api-reference/chat/create \r\n\r\nfrequency_penalty: https://platform.openai.com/docs/api-reference/chat/create ';
				  	title = '';
				    break;
				  case 'A-GeneralSettings':
				  	notifcn = '更多功能在开发中\r\n\r\n电脑端支持使用快捷键\r\n\r\n关于头像设置：支持网络图片和本地图片。\r\n\r\n电脑端如何使用本地图片用作头像？\r\n需要把html文件下载到电脑中，在本地打开使用时，才支持本地图片（填入相对路径或绝对路径）。\r\n以下是本地图片路径的示范：\r\nMac/Windows相对路径：123.jpg （头像需要与html文件放在同一文件夹中）\r\nMac绝对路径：/Users/LinTongXue/Downloads/123.jpg \r\nwindows绝对路径：D:\\LinTongXue\\123.jpg \r\n\r\n国内下载： https://gitee.com/lin2025/gpt3.5 \r\n国外下载： https://github.com/lin2025/gpt3.5 \r\nv6.09 暂无本地缓存，所有设置和聊天记录一样，刷新网页后会被清空。 \r\n...过几天尝试增加本地存储设置的功能';
					notifen = 'More features are being developed.\r\n\r\nMac and PC support the use of keyboard shortcuts.\r\n\r\nRegarding avatar settings：both network and local images are supported.\r\n\r\nHow to use a local image as your avatar on Mac/PC?\r\nYou need to download the HTML file to your computer and open it locally to support local images (support relative or absolute paths). \r\nHere are some examples of local image paths:\r\nMac/Windows relative path: 123.jpg (the avatar needs to be placed in the same folder as the HTML file)\r\nMac absolute path: /Users/LinTongXue/Downloads/123.jpg\r\nWindows absolute path: D:\\LinTongXue\\123.jpg\r\n\r\nDownload： https://github.com/lin2025/gpt3.5 \r\n\r\nv6.09 currently does not support local caching. All settings and chat records will be cleared after refreshing the webpage. Local storage settings will be added in a few days.';
				  	title = '';
				    break;
				  case 'A-ExportChatHistory':
				  	notifcn = '导出聊天记录_单轮对话：导出单轮聊天记录，即针对当前的上下文记忆进行导出，包含最新修改的系统提示词，不含发送失败的、撤回的、重问的记录。格式：Markdown。文件类型：.md 或 .txt\r\n\r\n导出聊天记录_全部：将网页上的所有聊天记录（包含发送失败的、撤回的、重问的记录）和所有操作记录（包含系统提示词修改记录）导出并下载。格式：Markdown。文件类型：.md 或 .txt\r\n\r\n附 两个Markdown在线编辑器网站：\r\nhttps://stackedit.cn/app# \r\nhttp://tool.pfan.cn/markdown \r\n\r\n更多功能待开发: 导出导入对话记录、本地浏览器缓存';
					notifen = 'Export Chat History for a Single Round, which includes the current context and the most recent system prompt, but excluding failed messages, undo messages, and retry messages. Exported file format: Markdown. File type: .md | .txt\r\n\r\nExport All Chat History, export and download all chat history (including failed messages, undo messages, retry messages) and all operation records (including system prompt modification records) on the webpage. Exported file format: Markdown. File type: .md | .txt \r\n\r\nWebsites for Markdown online editors:\r\nhttps://dillinger.io \r\nhttps://stackedit.io/app# \r\n\r\nMore features to be developed: exporting and importing chat records, local browser caching.';
				  	title = '';
				    break;
				  default:
				    // 当expression的值都不等于以上值时执行的代码块
				  	notifcn = '';
					notifen = '';
				  	title = '';
				}	

				notif = this.settingsLanguage == 'cn' ? notifcn : notifen ;
				this.showNotification(notif, 'center', title);
			},
	
			// 设置窗口 - 打开设置窗口 弹窗
			openDialogTodo_Settings(){

				//打开弹窗前需要处理的：
				//1. API URL： 将当前api url恢复到input，无论是否有效，即打开弹窗时，默认显示当前使用的URL。 
				this.inputApiURL = this.apiURL;
				
				//2. API URL： 保存按钮不可用。url在修改前保持不可用状态
				let btnsave = document.querySelector('.btnsaveapiurl');
				btnsave.disabled = true;
				
				//3. API URL： 如果当前是官方url，下拉框匹配官方
				if( this.inputApiURL == 'https://api.openai.com/v1/chat/completions' ){
					this.selectedApiURL = 'https://api.openai.com/v1/chat/completions'; //1 下拉框显示为“官方”/“GPT”
				}
				
				//4. img URL： 将当前头像地址img url恢复到输入框input，即打开弹窗时，默认显示当前使用的头像的URL。 
				const svgtips = this.settingsLanguage == 'cn' ? this.GPTGreenSVG_UrlText_cn : this.GPTGreenSVG_UrlText_en;
				this.inputGPTImageUrl = this.isgptGreenSvgShow ? svgtips : this.gptAvatarURL;
				this.inputUserImageUrl = this.userAvatarURL;
				
				//5. img URL： 更新头像按钮不可用。url在修改前保持不可用状态
				this.btnDisabledState_updateUserImageUrl = true;
				this.btnDisabledState_updateGPTImageUrl = true;
				
				//显示设置弹窗
				this.isShowDialog_Settings = true;
			},	
			// 设置窗口 - 显示专业级API设置 Pro 设置控制面板
			showProConfig(){
				let notif = '';
				let proConfigElement = document.getElementById("pro-config");
				if(proConfigElement.style.display != "none"){
					proConfigElement.style.display = "none";
					notif = this.settingsLanguage == 'cn' ? '隐藏 API专业设置' : 'Hide Professional API Settings' ;
				}else{
					proConfigElement.style.display = "block";
					notif = this.settingsLanguage == 'cn' ? '显示 API专业设置' : 'Show Professional API Settings' ;
				}
				this.showNotification(notif, 'bottom');
			},
			
// 设置窗口 - 11111111 待
changeTemperature(){
			
},
// 设置窗口 - 111111 待
changeMaxTokens(){
			
},
			
			// 设置窗口 - 保存接口网址 API URL
			saveApiURL() {
				if (this.checkBusyStatus()) {
					// 如果返回 true，正在发送或正在验证
					return;
				} 

				let btnsave = document.querySelector('.btnsaveapiurl');
				let notif = '' ;
	
				//不填写/保留空白，将恢复默认的官方接口
				if (this.inputApiURL.trim() == '') {
  
					this.inputApiURL = 'https://api.openai.com/v1/chat/completions' ;
					this.apiURL = this.inputApiURL;
	 
					//需要做些处理 改变当前状态 需要重新验证。
					this.selectedApiURL = 'https://api.openai.com/v1/chat/completions'; //1 下拉框显示为“官方”/“GPT”
					btnsave.disabled = true; //2 保存按钮变为不可用
					this.inputapichange(true); // 3 重新验证api-key时 改变按钮等状态
					notif = this.settingsLanguage == 'cn' ? '已重置为OpenAI官方接口' : 'The API ENDPOINT URL has been restored to the OpenAI link.' ;
					this.showNotification(notif, 'bottom','',2500);
				}else{

					// 1. 验证网址 开头只允许http:// 和 https:// 两种。 
					// 允许http：不了解接口规范，不排除私人搭建的某些http也能成功。不提醒，默认通过。
					const urlRegex = /^(https?|http):\/\/[^\s/$.?#]+\.[^\s]*$/;
					if (!urlRegex.test(this.inputApiURL.trim())) {
						notif = this.settingsLanguage == 'cn' ? '非完整网址格式，请输入以 https:// 开头的完整网址后重新保存' : 'Please input a website address that starts with https:// and save again.' ;
						this.showNotification(notif, 'bottom','',3800);
						return;
					}

					// 2. 验证this.inputApiURL这个网址是否以/v1/chat/completions结尾，如果不是，则弹窗由用户确认是继续还是返回
					if (!this.inputApiURL.trim().endsWith('/v1/chat/completions')) {
						const msg = '\r\n\r\n';
						const notif_cn = '本代码仅支持GPT-3.5或更新版本的GPT模型，对应的接口地址应以“/v1/chat/completions”结尾，如官方接口“https://api.openai.com/v1/chat/completions”。\r\n但是不排除第三方接口可能未按规范配置，请确认是否继续保存并使用该接口网址。 ' ;
						const notif_en = 'The code only supports GPT-3.5 or newer versions of the model, and the API ENDPOINT URL should end in "/v1/chat/completions", like the official one "https://api.openai.com/v1/chat/completions". \r\nHowever, it is not ruled out that the current URL can be used, please confirm whether to continue saving?';
						notif = this.settingsLanguage == 'cn' ? notif_cn : notif_en ;
						if (!confirm(notif)) {
							return;
						}
					}

					// 3. 保存
					this.apiURL = this.inputApiURL.trim();
	  
					// 4. 需要做些处理 改变当前状态 需要重新验证
					btnsave.disabled = true; //1 保存按钮变为不可用
					this.inputapichange(true); // 2 重新验证api-key时 改变按钮等状态
	  
					// 5. 提醒用户先验证API-key
					notif = this.settingsLanguage == 'cn' ? '保存成功' : 'Save successful' ;
					this.showNotification(notif, 'bottom');
				}
			},
			// 设置窗口 - API URL下拉框  更新
			updateInputApiURL(){
				this.inputApiURL = this.selectedApiURL;
				this.saveApiURL(); //保存操作
			}, 
			// 设置窗口 - API URL输入框 更新
			inputApiURLChange(){
				this.selectedApiURL = ''; //重置下拉框为空，显示下拉箭头
				let btnsave = document.querySelector('.btnsaveapiurl');
				btnsave.disabled = false; //保存按钮变为可用
			}, 
		
			
			//当前状态为"发送中"或"验证key中"时，需要禁止一些操作 Some operations should be prohibited when the current state is "sending" or "checking api key."
			checkBusyStatus() {
				let tip = '';
				if( this.isSendingNow ){
					tip = this.settingsLanguage == 'cn' ? '正在发送消息，请等发送结束后再修改' : 'Sending message, please wait until finished before making changes.'  ;
					this.showNotification(tip, 'bottom','',2900);
					return true;
				}
				if( this.isCheckingApiKeyNow){
					tip = this.settingsLanguage == 'cn' ? '正在验证API-Key，请等验证结束后再修改' : 'Verifying API-Key, please wait until finished before making changes.'  ;
					this.showNotification(tip, 'bottom','',2900);
					return true;
				}
				return false;
			},
			
			// 设置窗口 - 头像 URL输入框
			inputImageUrlChange(role) {
				if(role == 'user'){
					this.btnDisabledState_updateUserImageUrl = false;
				}else{
					this.btnDisabledState_updateGPTImageUrl = false;
				}
			},
			// 设置窗口 - 头像下拉框
			updateSelectedImage(role) {
				let imageurl = this.selectedImageUrl;
				this.selectedImageUrl = ''; //复原
 
 				//if (!imageurl.trim().startsWith('http://') && !imageurl.trim().startsWith('https://') && !imageurl.trim().startsWith('file://')) 
				//发现以上代码没有排除相对路径，当存在相对路径头像时，会产生无法切换头像的小bug。 目前SVG头像只有一种，也没必要判断。
				
				//当选择的是GPT的绿色SVG图像时
				if( imageurl == 'Change-GPT-Green-SVG' ){
					if(role == 'ai'){ 
						this.inputGPTImageUrl = this.settingsLanguage == 'cn' ? this.GPTGreenSVG_UrlText_cn : this.GPTGreenSVG_UrlText_en;
					}
					
				}else{
				 	if(role == 'user'){
				    	this.inputUserImageUrl = imageurl;
					}else {
						this.inputGPTImageUrl = imageurl;
					}
				}
				this.updateAvatar(role);//保存 更新 save update
			},		
			// 设置窗口 - 更新头像
			updateAvatar(role) {
				let imageUrl = '';
				let notif = '';
				if(role == 'user'){
			    	imageUrl = this.inputUserImageUrl.trim();
				}else {
					imageUrl = this.inputGPTImageUrl.trim();
				} 
	
				if(imageUrl == ''){
					notif = this.settingsLanguage == 'cn' ? '图片的网址为空' : 'Image URL is empty' ;
					this.showNotification(notif, 'bottom');
					return;
				}
	
				//如果是GPT绿色的SVG头像。手动更新
				if ( imageUrl == this.GPTGreenSVG_UrlText_cn || imageUrl == this.GPTGreenSVG_UrlText_en) {
					this.gptAvatarURL = "" ; //imgUrl清空
					this.isgptAvatarUrlShow = false; //隐藏img
				  	this.isgptGreenSvgShow = true; //显示svg
					this.btnDisabledState_updateGPTImageUrl = true;
					
					notif = this.settingsLanguage == 'cn' ? '已更换头像' : 'Avatar has been updated' ;
					this.showNotification(notif, 'bottom');
					return;
				}

				const img = new Image();
				notif = this.settingsLanguage == 'cn' ? '更换中...' : 'Updating...' ;
				this.showNotification(notif, 'bottom','',2900);
				
				img.onload = () => {
					// 图片加载成功，更新头像
					if(role == 'user'){
						this.userAvatarURL = this.inputUserImageUrl; 
						this.btnDisabledState_updateUserImageUrl = true; 
					}else {
						this.gptAvatarURL = this.inputGPTImageUrl;
						this.isgptAvatarUrlShow = true; //显示img
						this.isgptGreenSvgShow = false; //隐藏svg
						this.btnDisabledState_updateGPTImageUrl = true;
					}
					let notif = this.settingsLanguage == 'cn' ? '已更换头像' : 'Avatar has been updated' ;

					//必须延迟，否则当url不变时，瞬间激活onload事件，此时手机(某些设备)上会出现底部通知消息会出现横移/闪跳的情况。
					setTimeout(() => {
						this.showNotification(notif, 'bottom');
						}, 500);
			    	
				};
  
				img.onerror = () => {
					if(role == 'user'){
						this.btnDisabledState_updateUserImageUrl = false; 
					}else {
						this.btnDisabledState_updateGPTImageUrl = false;
					}
					// 图片加载失败，提示用户
					let message  = this.settingsLanguage == 'cn' ? '无法使用该图片作为头像，请选择其他图片' : 'Unable to use this picture as an avatar. Please select another picture.';
				
					//清除定时器 提前隐藏通知
					clearTimeout(this.notificationTimeoutId);
					setTimeout(() => {
						this.isShowNotification = false;
						this.notificationTimeoutId = -1;
						}, 600); // 延迟确保通知顺利弹出，然后再控制关闭。 不延迟的话，此时this.isShowNotification还可能为false（尚未弹出）。
					
					//延迟0.8秒，目的：先确保已弹出通知，然后定时隐藏通知，最后关闭定时弹窗，定时控制顺序
					setTimeout(() => {
							alert(message);
						}, 800);
					
				};
  
				img.src = imageUrl;
			},
  
//选择本地头像（本地地址）   不启用这个功能，可考虑删除
openFileDialog(role) {

/*

 <div class="button-container">
    <button @click="openFileDialog('user')" class="file-button">选择头像(PC)</button>
  </div>
   <div class="button-container">
    <button @click="openFileDialog('ai')" class="file-button">选择头像(PC)</button>
  </div>
 

*/ 
	  if (window.location.protocol !== 'file:') {
    alert('仅在电脑上支持显示本地图片（头像）');
    return;
  }
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = (event) => {
    const file = event.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      // 将文件地址赋值给imageUrl，并执行updateAvatar方法
	  
	  	if(role == 'user'){
    	this.inputUserImageUrl = url;
	}else {
		this.inputGPTImageUrl = url;
	}
      this.updateAvatar(role);
    }
  };
  input.click();
},
	
			// 设置窗口 - 更换语言 中英文切换
			changeLanguage() {

				//更新原生全局变量 window.currentlang  当前语言 Current Language
				window.currentlang = this.settingsLanguage;

				//btn - 发送 Send 
				if ( this.sentext == '先验证API' || this.sentext == 'Check API First' ) {
					this.sentext = this.settingsLanguage == 'cn' ? '先验证API' : 'Check API First';
				}else if ( this.sentext == '发送' || this.sentext == 'Send' ) {
					this.sentext = this.settingsLanguage == 'cn' ? '发送' : 'Send';
				}else if ( this.sentext == 'API-key错误' || this.sentext == 'API-key Error' ) {
					this.sentext = this.settingsLanguage == 'cn' ? 'API-key错误' : 'API-key Error';
				}else if ( this.sentext == '重新验证API' || this.sentext == 'Recheck API' ) {
					this.sentext = this.settingsLanguage == 'cn' ? '重新验证API' : 'Recheck API';
				}else if ( this.sentext == '请重发'|| this.sentext == 'Please Retry'  ) {
					this.sentext = this.settingsLanguage == 'cn' ? '请重发' : 'Please Retry';
				}

				//btn - 验证 Check API-Key 
				if ( this.apibtntext == '已验证' || this.apibtntext == 'Checked' ) {
					this.apibtntext = this.settingsLanguage == 'cn' ? '已验证' : 'Checked';
				}else if ( this.apibtntext == '<< 验证' || this.apibtntext == '<< Check' ) {
					this.apibtntext = this.settingsLanguage == 'cn' ? '<< 验证' : '<< Check';
				}

				//input - GPT头像
				if ( this.inputGPTImageUrl.trim() == this.GPTGreenSVG_UrlText_cn || this.inputGPTImageUrl.trim() == this.GPTGreenSVG_UrlText_en ) {
					this.inputGPTImageUrl = this.settingsLanguage == 'cn' ? this.GPTGreenSVG_UrlText_cn : this.GPTGreenSVG_UrlText_en;
				}
		 
			},
			// 设置窗口 - 上下文模式
			changeContextualMode() {
				//11111111

			},
			// 设置窗口 - 改变字体大小 
			changeStyle_FontSize() {
				//tips：function(element)里面不能用this
				let fontsize = this.settingsFontSize ;
				document.querySelectorAll('.wechatstyle-datetime').forEach(function(element) {
					element.style.fontSize = fontsize  * 0.9 + 'px'; //this.settingsFontSize是数值型
				});
			},
			// 设置窗口 - 显示 隐藏 时间 微信样式 
			changeStyle_Time_WechatStyle() {
				//1、add_span_WeChatStyleDatetime() 手动添加新的微信时间， 添加时判断是否显示 + 判断样式(与消息时间有关联)  +（*与分割线的关联 改样式写在分割线的代码里）
				//2、changeStyle_Time_WechatStyle()  改变之前的微信时间的显示状态 + 分割线的样式  +（*与消息时间的关联 改样式写在消息时间的代码里）
				//应该没问题 。 手动添加，无法绑定变量

				let displayStyle = this.settingsTime_WechatStyle ? 'block' : 'none';
				document.querySelectorAll('.wechatstyle-datetime').forEach(function(element) {
					element.style.display = displayStyle;
				});

				let newcontexthrbottom = this.settingsTime_WechatStyle ? '20px' : '33px';
				document.querySelectorAll('.newcontext-hr').forEach(function(element) {
					element.style.marginBottom = newcontexthrbottom;
				});
			},
			// 设置窗口 - 显示 隐藏 消息时间  
			changeStyle_Time() {
				//1、非手动添加。显示状态写在<div v-if="x.my" class="msgdatetimediv" :style="{ display: settingsTime_Message == 1 ? 'none' : 'block' }" >
				// class可以绑定 style可以绑定 目前使用变量控制新旧消息时间的显示状态
				//2、changeStyle_Time() 仅改变样式。 修改之前的消息时间的样式： 第3种模式增大间距需要改变样式 + 当微信时间显示时，还需要改变微信时间的样式
				//3、漏洞：缺少新消息时间判断样式的代码 
				//   一、userinfo和aiinfo 添加绑定 marginTop : settingsTime_Message == 3 ? '27px' : '17px'  ,绑定后可注释删除changeStyle_Time()里的对应代码。
				//   二、user消息时间 和 微信时间(只会存在user这边) 是同时产生的，新增微信时间的样式判断已经写在add_span_WeChatStyleDatetime()，无需再做处理。
				//   changeStyle_Time() 只需要修改之前的微信时间样式即可。

				//let infotop = '17px';
				let wechattimebottom = '17px';

				if (this.settingsTime_Message == 3 ){
				 //infotop = '27px';
				  wechattimebottom = '27px';
				}

				//document.querySelectorAll('.userinfo').forEach(function(element) {
				//  element.style.marginTop = infotop;
				//});

				//document.querySelectorAll('.aiinfo').forEach(function(element) {
				//  element.style.marginTop = infotop;
				//});


				document.querySelectorAll('.wechatstyle-datetime').forEach(function(element) {
				element.style.marginBottom = wechattimebottom;
				});	 
			},
			// 设置窗口 - 显示 隐藏 分割线
			changeStyle_DividerLine() {
				//1、changeStyle_DividerLine() 修改之前的分割线的显示状态 不改变样式
				//2、add_hr_newRoundContext() 手动添加新分割线时 1判断是否显示新分割线 2判断新分割线的样式（受微信样式时间的影响）*分割线与消息时间 之间无样式关联
				//3、changeStyle_Time_WechatStyle() 只有当微信样式时间的状态发生改变时，才会改变之前分割线的样式
				// 应该没问题 手动添加，无法绑定变量
	
				let displayStyle = this.settingsDividerLine ? 'block' : 'none';
				document.querySelectorAll('.newcontext-hr').forEach(function(element) {
					element.style.display = displayStyle;
				});
			},
			// 设置窗口 - 快捷键 功能键 For PC
			handleShortcut(event) {
			      var key = event.key || event.keyCode || event.which;
			      if (key === 'F1' || key === 112) {
			        event.preventDefault(); // 防止浏览器默认行为
			        // 清空
					if(!this.settingsShortcut_Clear){return;}//未开启快捷键时 返回
					if(this.btnDisabledState_Clear){return;}//清空按钮不可用时 返回
		
					if(this.isShowDialog_Settings){return;}//设置窗口打开时 返回
					if(this.isShowDialog_PromptGenerator){return;}//提示词窗口打开时 返回
					if(this.isShowNotification){return;}//通知消息时 返回 *底部通知时其实可以允许使用快捷键，但时长较短，仅3秒，干脆也禁了
		
					//其他弹窗 1111111。压缩上下文
		
					this.clearContext(); //清空
			      } 
	  
				  if (key === 'F2' || key === 113) {
			        event.preventDefault(); // 防止浏览器默认行为
			        // 验证api-key
					if(!this.settingsShortcut_CheckApiKey){return;}//未开启快捷键时 返回
					if(this.btnDisabledState_CheckAPI){return;}//验证按钮不可用时 返回
		
					this.checkAPIbtn(); //验证
			      } 
	  
				  if (key === 'F3' || key === 114) {
			        event.preventDefault(); // 防止浏览器默认行为
			        // 撤销
					if(!this.settingsShortcut_Undo){return;}//未开启快捷键时 返回
					if(this.btnDisabledState_Undo){return;}//撤销按钮不可用时 返回
		
					if(this.isShowDialog_Settings){return;}//设置窗口打开时 返回
					if(this.isShowDialog_PromptGenerator){return;}//提示词窗口打开时 返回
					if(this.isShowNotification){return;}//通知消息时 返回
					//其他弹窗 1111111。压缩上下文
		
					this.undo();//撤销
			      } 
	  
				  if (key === 'F4' || key === 115) {
			        event.preventDefault(); // 防止浏览器默认行为
			        // 重问
					if(!this.settingsShortcut_Retry){return;}//未开启快捷键时 返回
					if(this.btnDisabledState_Undo){return;}//与撤销相同。 撤销按钮不可用时 返回
		
					if(this.isShowDialog_Settings){return;}//设置窗口打开时 返回
					if(this.isShowDialog_PromptGenerator){return;}//提示词窗口打开时 返回
					if(this.isShowNotification){return;}//通知消息时 返回
					//其他弹窗 1111111。压缩上下文
		
					this.retry();//重问
			      }
			},		
			//判断是否存在代码块的反引号，是否有连续3个或以上的反引号（通常只会遇到3～5个的情况），找存在的最长的，然后返回长度加1的连续反引号。 连续长度多少决定了循环次数，限制100。
			//目的是特殊情况下需要利用代码块来包裹整段提示词内容，如果没有足够长度的反引号，markdown上的排版可能会很乱
			findMaxBackticks(str) {
				let pattern, regex;
				// Check for 5 backticks
				pattern = "`{5}"; 
				regex = new RegExp(pattern);
				if (regex.test(str)) {
					// Check for more than 5 backticks
					for (let i = 6; i <= 100; i++) {
						pattern = "`".repeat(i);
						regex = new RegExp(pattern);
						if (!regex.test(str)) {
							return "`".repeat(i);
						}
					}
				} else {
				// Check for 4, 3 backticks
					for (let i = 4; i >= 3; i--) {
						pattern = "`".repeat(i);
						regex = new RegExp(pattern);
						if (regex.test(str)) {
							return "`".repeat(i + 1);
						}
					}
				}
				return '';
			},	
			// 设置窗口 - 添加提示词到聊天记录中（ChatHistory.txt）	
			addSystemPromptToChatHistory(head_cn,head_en){
				//提示词 使用两种markdown语法：
				//		1、引用。当没有空行、没有```代码块时，使用"> "引用语法。提示词整段显示为引用，与聊天记录区分开。
				//		2、代码块。当提示词中存在空行 、```代码块时，导出聊天记录的markdown视图会显得很乱，此时使用代码块语法来包裹整段提示词，但提示词中本身很能存在“```”甚至更长的反引号，这会导致包裹失败，所以要用更长的反引号。
				//		  ...也可以直接写死，比如直接用10个反引号来包裹。但是若将导出的记录再作为提示词使用的话，下次导出聊天记录时就无法包裹了（反引号长度相同）。
				const regex = /\r?\n\r?\n/;  //正则，匹配连续两个换行符(即匹配是否存在空行，支持Unix、Windows的换行符)
				let hasMultipleLines = regex.test(this.gptSystemPrompt.trim()); //是否存在空行  包含空行时无法支持引用语法"> "
				let backticks = this.findMaxBackticks(this.gptSystemPrompt.trim()); //提示词中可能存在的最长的连续反引号。 返回“长度加1的连续反引号”
				hasMultipleLines = backticks != '' ? true : hasMultipleLines ; //如果含有3个或以上的反引号，同样不能使用"引用"语法
				backticks = backticks == '' ? '````' : backticks ; //更新变量，一种情况会用到：当提示词(不包含代码块&&包含空行)的时候，此时用于包裹提示词的代码块需要3个反引号，3个就够，但还是用4个吧
	
				//v6.01 一个开关，chatHistoryPromptOnlyUseBackticks=true 全部使用反引号，chatHistoryPromptOnlyUseBackticks=false 自动判断使用引用或者反引号
				//v6.01 When chatHistoryPromptOnlyUseBackticks=true, only backtick syntax will be used. When chatHistoryPromptOnlyUseBackticks=false, the system will automatically determine whether to use quote syntax or backtick syntax.
				if ( this.chatHistoryPromptOnlyUseBackticks ) {
					hasMultipleLines = true;
				}
	
				let addMarkdownSyntaxStart = hasMultipleLines ? ( '\r\n' + backticks + '\r\n' ) : '\r\n> ' ;  // (> 后面有个空格)
				let addMarkdownSyntaxEnd = hasMultipleLines ? ( '\r\n' + backticks + '\r\n\r\n' ) : '\r\n\r\n' ; 
				let nullprompt = '';  //提示词为空的情况
				if( this.gptSystemPrompt.trim() == '' ){
					nullprompt = this.settingsLanguage == 'cn' ? ': 空' : ': None' ; 
					addMarkdownSyntaxStart = '\r\n'; 
					addMarkdownSyntaxEnd = '\r\n' ;
				}
				let txt_lang = this.settingsLanguage == 'cn' ? ( head_cn + nullprompt + addMarkdownSyntaxStart ) : ( head_en + nullprompt + addMarkdownSyntaxStart ) ;
				//1.提示词为空。  2.提示词含有空行，但不含有```代码块。  3.提示词含有```代码块（连续3个或以上的反引号为markdown的代码块，3个以下是"行代码，单行"）
				// 也可以直接考虑只使用“代码块”包裹，而不使用“引用”。“引用”出现失败的概率也不小，测试中发现不同的在线markdown编辑器的差异还蛮大。
				this.chathistory  += ( txt_lang + this.gptSystemPrompt.trim() + addMarkdownSyntaxEnd );
			},
			// 设置窗口 - 恢复默认 API设置
			restoreDefault_APISettings(){
				if (this.checkBusyStatus()) {
					// 如果返回 true，正在发送或正在验证
					return;
				} 
		
				// 待开发1111111  
				// 如果存在本地缓存 
		 
				this.apitemperature = 0.7;
				this.apiMaxTokens = 2048;
				this.apiGPTModel = 'gpt-3.5-turbo';

				const notif = this.settingsLanguage == 'cn' ? 'API设置 已恢复默认值' : 'API Settings have been reset to their default values.' ;
				this.showNotification(notif, 'bottom', '', 3500);
			},
			// 设置窗口 - 恢复默认 API设置 专业
			restoreDefault_ProfessionalAPISettings(){
				if (this.checkBusyStatus()) {
					// 如果返回 true，正在发送或正在验证
					return;
				} 
	
				// 待开发1111111  
				// 如果存在本地缓存 

				//同步saveApiURL中关于保存默认url的步骤
				this.inputApiURL = 'https://api.openai.com/v1/chat/completions' ; //输入框显示的api url
				this.apiURL = this.inputApiURL; // 真正的的api url
				this.selectedApiURL = 'https://api.openai.com/v1/chat/completions'; //下拉框显示为“官方”/“GPT”
				this.inputapichange(true); // 重新验证api-key时 改变按钮等状态
				let btnsave = document.querySelector('.btnsaveapiurl');
				btnsave.disabled = true; //保存按钮状态改为不可用  
	     
				this.apiTopP = 1;
				this.apiPresencePenalty = 0;
				this.apiFrequencyPenalty = 0;

				const notif = this.settingsLanguage == 'cn' ? 'API专业设置 已恢复默认值' : 'Professional API Settings have been reset to their default values.' ;
				this.showNotification(notif, 'bottom', '', 3500);
			},
			// 设置窗口 - 恢复默认 常规设置
			restoreDefault_GeneralSettings(){
				if (this.checkBusyStatus()) {
					// 如果返回 true，正在发送或正在验证
					return;
				} 
	  
				// 待开发1111111  
				// 如果存在本地缓存 

				this.settingsFontSize =  14 ;
				this.changeStyle_FontSize();

				this.settingsTime_WechatStyle = true ;
				this.changeStyle_Time_WechatStyle();

				this.settingsTime_Message = 1 ;
				this.changeStyle_Time();

				this.settingsDividerLine = true ;
				this.changeStyle_DividerLine();

				this.settingsContextualMode = 0 ;
				this.changeContextualMode();

				this.settingsShortcut_CheckApiKey = true ;
				this.settingsShortcut_Clear = false ;
				this.settingsShortcut_Undo = false ;
				this.settingsShortcut_Retry = true ;

				const notif = this.settingsLanguage == 'cn' ? '常规设置 已恢复默认设置。 *语言和头像的设置会被保留，需手动修改' : 'General Settings have been reset to their default values. *The settings for language and avatar will be retained and need to be manually modified. ' ;
				const time = this.settingsLanguage == 'cn' ? 5500 : 6500 ;
				this.showNotification(notif, 'bottom', '', time);
			},
		

			// 复制系统提示词到编辑区
			copySystemPromptToEditor(){
				let sys_prompt = this.gptSystemPromptReadOnly.trim();
				let notif = '';
				if(sys_prompt == ''){
					notif = this.settingsLanguage == 'cn' ? '当前的系统提示词为空' : 'The current system prompt is empty' ;
					this.showNotification(notif, 'bottom'); 
					return;
				}
	
				if(this.gptSystemPrompt.trim() != '' && !this.btnDisabledState_SetSystemPrompt ){
					notif = this.settingsLanguage == 'cn' ? '提示词编辑框中已存在内容，确认覆盖吗？' : 'Content exists in Prompt Editor, confirm overwrite?' ;
					if (!confirm(notif)) {
						return; // 用户点击了“取消”按钮
					}
				}
	
				this.gptSystemPrompt = sys_prompt;
				this.btnDisabledState_SetSystemPrompt = true;
				notif = this.settingsLanguage == 'cn' ? '已复制到编辑区' : 'Copied to the Prompt Editor' ;
				this.showNotification(notif, 'bottom');
			},
			//提示词弹窗 改变布局 *移动端可能会需要
			changePromptGeneratorLayout() {
				let notif = this.settingsLanguage == 'cn' ? '布局切换成功' : 'Layout changed' ;
					if (this.styleDialogLayout.padding == '20px 20px 20px 20px') {
					this.styleDialogLayout.padding = '20px 20px 20px 45px';
				} else if (this.styleDialogLayout.padding == '20px 20px 20px 45px') {
					this.styleDialogLayout.padding = '20px 45px 20px 20px';
				} else {
					this.styleDialogLayout.padding = '20px 20px 20px 20px';
				}
	  
				this.showNotification(notif, 'bottom');
			},
			//改变指定元素的高度
			changeElementHeight(classname) {
				let notif = this.settingsLanguage == 'cn' ? '高度已调整' : 'Height adjusted' ;
				let input = document.querySelector('.' + classname);
				if (input == null) { return; }
	  
				let h = input.style.height;
				if (h == '100px') {
				    input.style.height = '250px';
				}else if (h == '250px'){
					input.style.height = '500px';
					notif = this.settingsLanguage == 'cn' ? '高度已调至最大' : 'Height adjusted to maximum' ;
				}else {
					input.style.height = '100px'; 
					notif = this.settingsLanguage == 'cn' ? '高度已恢复' : 'Height restored' ;
				}
	
				this.showNotification(notif, 'bottom'); 
			},
			//改变指定元素视图（是否自动换行）
			changeElementLineBreak(classname) {
				let notif = this.settingsLanguage == 'cn' ? '切换为 不自动换行' : 'Changed to no-wrap' ;
				let input = document.querySelector('.' + classname);
				if (input == null) { return; }
				
				let whiteSpace =  input.style.whiteSpace;
				if (whiteSpace != 'pre' && whiteSpace != 'pre-wrap') {
					input.style.whiteSpace = 'pre';
				} else if (whiteSpace == 'pre') {
					input.style.whiteSpace = 'pre-wrap';
					notif = this.settingsLanguage == 'cn' ? '切换为 自动换行' : 'Changed to auto-wrap' ;
				} else {
					input.style.whiteSpace = 'pre';
				} 
				this.showNotification(notif, 'bottom');
			},
					
			//按钮：保存为系统提示词 更新系统提示词 Save system prompt
			setSystemPrompt(){
			
				let notif = this.settingsLanguage == 'cn' ? '保存成功' : 'Saved successfully' ;
				
				if (this.checkBusyStatus()) {
				  // 如果返回 true，正在发送或正在验证
				  return;
				} 
			
				//隐形提示词 当gptSystemPrompt_hidden隐藏提示词存在时，不允许提交修改。 已禁用提示词弹窗，其实这里可以不写。
				if(this.gptSystemPrompt_hidden.trim() != ''){
					notif = this.settingsLanguage == 'cn' ? '保存失败，代码中存在隐藏提示词' : 'Save failed, there is a hidden "system prompt" in the code.' ;
					this.showNotification(notif, 'bottom');
					return;
				}
								
				//v6.03 增加判断是否为空，应该是需要判断的，之前忘了
				if(this.gptSystemPrompt.trim() == ''){
					notif = this.settingsLanguage == 'cn' ? '保存失败，提示词为空' : 'Save failed, system prompt is empty.' ;
					this.showNotification(notif, 'bottom');
					return;
				}
				
			    //为false，表示新窗口从未写入过指令[是否设置了默认system]
				if(!this.hasSystemPromptBeenSaved){
					this.hasSystemPromptBeenSaved = true;
					this.addSystemPromptToChatHistory('### #默认的系统提示词 system prompt ', '### #Default System Prompt ' ); //this.chathistory
				}
				else {
					this.addSystemPromptToChatHistory('### #新的系统提示词 system prompt ', '### #New System Prompt ' ); //this.chathistory
				}
			
				this.btnDisabledState_SetSystemPrompt = true;
				this.msgContent[0] =  {"role": "system", "content": this.gptSystemPrompt.trim() };
				this.msgContentForMsgList_SingleRound[0] =  {"role": "system", "content": this.gptSystemPrompt.trim() };
				this.gptSystemPromptReadOnly = this.gptSystemPrompt.trim();
				
				//改变"提示词"按钮的颜色 Change the color of the "prompt generator" button
				if(this.gptSystemPrompt.trim() == ''){
					document.querySelector('.btnpromptgenerator').classList.add('bluebtn');
				}else{
					document.querySelector('.btnpromptgenerator').classList.remove('bluebtn');
				}
				
				this.showNotification(notif, 'bottom');
				
			}, 
			//按钮：清空 清空记忆 Clear context *同时清空发送失败的msg
			clearContext(){
				this.btnDisabledState_Clear = true;
				this.btnDisabledState_Undo= true;
				this.totaltokens = 0; //int
				this.msgContent = [this.msgContent[0]];
				this.msgTokens = [this.msgTokens[0]];
				this.succQA_Count = 0; //int
				this.msgContentForMsgList_SingleRound = [this.msgContentForMsgList_SingleRound[0]];//清零，仅记录单轮记忆的原文
				this.userMsgTokensForRetry = 0; //清零
				const txt_lang1 = this.settingsLanguage == 'cn' ? '### #清空上下文记忆\r\n\r\n' : '### #Clear Context\r\n\r\n' ;
				this.chathistory  += (txt_lang1);
				this.add_hr_newRoundContext(false); //添加记忆分割线
			}, 
			//按钮：说明 Help
			openDialog_Help(){
				let notif =  '';
				let title = this.settingsLanguage == 'cn' ? 'LinGPT v6.09 - 帮助' : 'LinGPT v6.09 - Help' ;
				const notifcn = 'LinGPT - A GPT-3.5 Webpage with Just a Single HTML File \r\nChange Language: [Settings] > [Language]\r\n\r\n#介绍\r\nLinGPT，只有一个html文件的GPT-3.5聊天网页，可下载到电脑，打开即用。可上传至任一免费的静态网页托管平台、主机、服务器。 ①关于接口：本代码使用OpenAI官方API(接口)，同时支持第三方API，可实现免魔法使用GPT。 ②关于模型：由于无法测试GPT-4模型，目前仅支持GPT-3.5模型（ChatGPT）。 ③关于密钥：需自备API Key。免费Key目前官方限制每分钟最多调用3次，不要聊太快，一般够用。轮询Key的功能待开发中。 ④关于隐私：截止v6.09版，尚未增加本地缓存功能，刷新页面后将重新开始。本代码未加密，开源透明，安全无风险，只要使用官方接口就不会存在任何隐私被截的可能。\r\n\r\n#开始使用\r\n跟随红色按钮指引，填入API Key并验证，通过后即可开始聊天。\r\n\r\n#聊天\r\n①可使用Markdown语法。方法与官网版ChatGPT(chat.openai.com)相同，当GPT的回复未使用Markdown格式时，可要求其使用Markdown格式回复（MD格式主要应用于代码、表格、文章排版、显示网络图片等，GPT多数情况下会主动使用MD语法）。 ②手机端换行：发现有部分输入法无法换行，如遇到请更换输入法重试，或可以借用 [提示词窗口] 编辑换行内容，然后再复制到聊天框发送。 ③电脑端换行：支持 Shift + Enter 、Ctrl + Enter 换行，Mac还支持 Command(⌘) + Enter 换行。 ④斜杆调用提示词的功能，需要点击斜杆按钮。\r\n\r\n#提示词窗口\r\n截止v6.09版本，暂时只有设置系统提示词的功能，可在提示词窗口中点击蓝色小问号 [?] 了解更多。\r\n\r\n#设置窗口\r\n常规设置、API设置、查询API余额和有效期、API专业设置（点蓝色 [PRO] 按钮）、修改头像、导出聊天记录等，可在设置窗口中点击蓝色小问号 [?] 了解更多。\r\n\r\n#持续更新中\r\n更新日志 https://gitee.com/lin2025/gpt3.5/  或  https://github.com/lin2025/gpt3.5/ \r\n待开发的功能：集成提示词、共享提示词、智能调整max_tokens、压缩上下文(可导出)、多种上下文模式、本地缓存及加密、导出JSON、导入JSON还原对话、轮询Key、免费Key试用...等';
				//有单引号
				const notifen = "LinGPT - A GPT-3.5 Webpage with Just a Single HTML File \r\n\r\n#Introduction \r\nLinGPT is a GPT-3.5 webpage  with just a single HTML file. ①API: This code uses the OpenAI API and supports third-party APIs. ②Model: Currently, only the GPT-3.5 model (ChatGPT) is supported as the GPT-4 model cannot be tested. ③API Key: An OpenAI API key is required. ④Privacy: v6.09, there is no local caching function, and the data will be cleared after refreshing the page. \r\n\r\n#Getting Started \r\nFollow the red button's guidance, enter the API Key and check it, and you can start chatting after passing. \r\n\r\n#Chatting \r\n①Like the official ChatGPT (chat.openai.com), Markdown syntax can be used. Similarly, when GPT's reply does not use Markdown format, it can be asked to reply in Markdown format (GPT usually automatically uses MD syntax). ②Line Breaks on Computer: Supports Shift + Enter, Ctrl + Enter line breaks, and Mac also support Command(⌘) + Enter line breaks. \r\n\r\n#Prompt Generator \r\nv6.09, only the function of setting system prompt is available. Click the blue question mark [?] in the prompt generator window to learn more. \r\n\r\n#Settings \r\nGeneral settings, API settings, checking API balance and validity period, API professional settings (click the blue [PRO] button), changing avatars, exporting chat history, etc., can be learned more about by clicking the blue question mark [?] in the settings window. \r\n\r\n#Updates \r\nhttps://github.com/lin2025/gpt3.5/ \r\nFeatures to be developed: integrated prompt words, shared prompt words, intelligent adjustment of max_tokens, compressed context (exportable), multiple context modes, local caching and encryption, exporting JSON, importing JSON to restore dialogue, key rotation, etc.";
				
				notif = this.settingsLanguage == 'cn' ? notifcn : notifen ;
				this.showNotification(notif, 'center', title);		
			}, 
			//添加记忆分割线 Add <hr> for a new round of context.
			add_hr_newRoundContext(isUndo){
				let lastInfoElem;
				let infoElems; // class = "aiinfo" or "userinfo"

				//界面上至少存在3条记录（即欢迎语 + 一次问答），才可能添加分割线
				if (this.msgList.length > 2 ){
					//判断最后一条记录属于哪边
					if(this.msgList[this.msgList.length - 1]["my"]){
						infoElems = document.querySelectorAll('.userinfo'); // 获取class=userinfo
					}else{
						infoElems = document.querySelectorAll('.aiinfo'); // 获取class=aiinfo
					}
		
					if(isUndo){
						//当前操作是：撤销 Undo
						// 只有单轮记忆为0 ，同时不存在发送失败记录时，才能添加横线<hr>, 否则不添加
						if (this.msgContentForMsgList_SingleRound.length > 1 ){
							return;
						}
					}else{
						//当前操作是：清空记忆 清空上下文 Clear context
						// Do nothing.
					}

					// 获取最后一个info。  ps：如果是撤销，class一定是aiinfo。如果是清空记忆，class有两种可能。
					lastInfoElem = infoElems[infoElems.length - 1];
						
					// 如果当前不存在有<hr>分割线，才允许添加，避免重复添加
					// aiinfo/userinfo是子元素，需要操作的是其父元素<div>。 <div>与<hr>属于同一层级
					if (lastInfoElem.parentElement.nextElementSibling.tagName != 'HR') {
						let newHr = document.createElement('hr');
						newHr.classList.add('newcontext-hr');
						newHr.style.marginBottom = this.settingsTime_WechatStyle ? '20px' : '33px'; //当前是否存在微信样式时间
						newHr.style.display = this.settingsDividerLine ? 'block' : 'none'; //是否显示分割线
						lastInfoElem.parentElement.insertAdjacentElement('afterend', newHr);
						this.scrollToBottomView(); //添加后，滚动到最下方
					}
						
					let txt_lang1 = this.settingsLanguage == 'cn' ? '#### #无记忆状态，新对话开始\r\n***\r\n\r\n' : '#### #The context was emptied. New Chat begins.\r\n***\r\n\r\n' ;
					this.chathistory  += (txt_lang1); 
						
					//隐形提示词 如果在代码中写了gptSystemPrompt_hidden隐藏提示词，则不写入提示词。
					if(this.gptSystemPrompt_hidden.trim() != ''){
						// this.chathistory  += 
					} else {
						this.addSystemPromptToChatHistory('#### #当前系统提示词 system prompt ', '#### #Current System Prompt ' ); //this.chathistory
					}
						
				}
			}, 
			//添加当前时间(微信风格)，格式MMDDHHmm，添加到指定元素的子元素的前面  Add <span> of current time (MMDDHHmm). *WeChat Style
			add_span_WeChatStyleDatetime(divelement,datetime){	
				let newTimeSpan = document.createElement('span');
				newTimeSpan.classList.add('wechatstyle-datetime');
				newTimeSpan.textContent = datetime.slice(5, 16);
				newTimeSpan.style.display = this.settingsTime_WechatStyle ? 'block' : 'none';
				newTimeSpan.style.marginBottom = this.settingsTime_Message == 3 ? '27px' : '17px';
				newTimeSpan.style.fontSize = this.settingsFontSize  * 0.9 + 'px';
				//Tips: beforebegin 当前的前面  afterend 当前的后面  afterbegin 当前的子元素的最前面  beforeend 当前的子元素的最后面 
				divelement.insertAdjacentElement('afterbegin', newTimeSpan); 
			}, 
			//按钮：撤销 Undo
			undo(){
			
				this.scrollToBottomView();
				//v5,11 修复逻辑错误、bug。全新逻辑，涉及：撤销+重问+发送失败+Tokens等。  v5,11 Fix bugs. Fix logic errors. Brand new logic. Regarding: undo, retry, send failed, tokens...
				if (this.msgContentForMsgList_SingleRound.length > 1){
					const txt_lang1 = this.settingsLanguage == 'cn' ? '### #撤销\r\n\r\n' : '### #Undo\r\n\r\n';
					this.chathistory  += (txt_lang1);
					this.userMsgTokensForRetry = 0; //清零
					
					let templastmsgHtml = this.msgList.pop(); //HTML
					this.msgContentForMsgList_SingleRound.pop(); 
					
					// 'my'：最后一条为user，一定是发送失败的msg。msgContent和msgTokens不会包含失败的msg，无需处理。msgList和msgContentForMsgList_SingleRound 刚刚pop()过，同样无需处理。
					//If the last msg is 'my', it must be a failed message. msgContent and msgTokens do not contain failed msg, so there is no need to handle them.  msgList and msgContentForMsgList_SingleRound have already been deleted and do not need to be processed again.
				
					// AI
					if (!templastmsgHtml['my']){
						//处理msgContent和msgTokens中的AI msg
						this.msgContent.pop(); 
						this.msgTokens.pop();
						//处理user msg
						this.msgList.pop();
						this.msgContentForMsgList_SingleRound.pop(); 
						this.msgContent.pop(); 
						this.msgTokens.pop();
						
						this.succQA_Count = this.msgContent.length - 1; //int. 更新
					}
					
					if (this.msgContentForMsgList_SingleRound.length < 2){
						//msgContentForMsgList_SingleRound.length == 1 ( msgList.length== 1)时，撤销&重问按钮-不可用，清空按钮-不可用
					  	this.btnDisabledState_Undo = true;
						this.btnDisabledState_Clear = true;
					}else if (this.msgContent.length < 2){
						//只要本轮记忆界面上还存在有msg(包含失败的msg)，撤销&重问 就保持可用状态
						//但记忆可能提前为空 msgContent.length == 1，此时清空不可用。即，只剩有失败的msg时，清空不可用。
						this.btnDisabledState_Clear = true;
						this.btnDisabledState_Undo = false; //保持可用
					}
					
					// length-1 是最后一条AI回复的数据(无论隔着多少条发送失败的记录)，或是msgTokens[0]的数据(无记忆)
					this.totaltokens = this.msgTokens[this.msgTokens.length - 1]["total_tokens"]; // int
					
					this.$nextTick(() => {
						this.add_hr_newRoundContext(true); //添加记忆分割线
					});
					
					if (this.msgContent.length == 0  || this.msgContentForMsgList_SingleRound.length == 0){
						console.error("undo(). length == 0. [Undo] 意外错误 Error bug");
					}
				}
				else{
					//err  If the code has reached here, it means there is an error.
					console.error("undo(). length <= 1 && Undo is available. [Retry] 意外错误 Error bug");
					this.btnDisabledState_Undo = true;
					this.btnDisabledState_Clear = true;
				}
	  		},   
			//按钮：重问 Retry *Undo and resend
			retry(){
				this.isRetry_RetryMessage = ''; //先重置
				
				//v5,11 修复逻辑错误、bug。全新逻辑，涉及：撤销+重问+发送失败+Tokens等。  v5,11 Fix bugs. Fix logic errors. Brand new logic. Regarding: undo, retry, send failed, tokens...
				if (this.msgContentForMsgList_SingleRound.length > 1){
					const txt_lang1 = this.settingsLanguage == 'cn' ? '### #重问\r\n\r\n' : '### #Retry\r\n\r\n';
					this.chathistory  += (txt_lang1);
					let templastmsgHtml = this.msgList.pop(); //HTML. last msg - AI or ME/my/user
					let templastmsgContent = this.msgContentForMsgList_SingleRound.pop(); 
					let totaltokens_temp = 0;
					
					if (!templastmsgHtml['my']){
						//templastmsgHtml is AI, then...
							this.msgContent.pop(); //Context. del last msg - AI
							this.msgTokens.pop(); //msgTokens. del last msg - AI
							this.msgList.pop(); //HTML. del ME
							this.msgContentForMsgList_SingleRound.pop(); //msgContentForMsgList_SingleRound
							templastmsgContent = this.msgContent.pop(); //Context. del last msg - Me
							this.succQA_Count = this.msgContent.length - 1; //int. 更新
							
							//user. 在msgTokens.pop()前，先获取user的token总数。此时totaltokens一定不等于0
							//已获得AI回复过的重问，tokens总数包含提问的内容（如果指令没有改动的话是准确的，指令改动过就不准）
							totaltokens_temp = this.msgTokens[this.msgTokens.length - 1]["total_tokens"];  // int
							this.userMsgTokensForRetry = totaltokens_temp; //临时记录tokens。本次重问失败后，再次重问时会用到
							this.msgTokens.pop(); //msgTokens. del last msg - Me
							if(this.msgContent.length == 0 || this.msgTokens.length == 0){ alert(" 找到一个bug\r\nA new bug has appeared.\r\n\r\n已回复后的重问，在两次pop()后 this.msgContent.length 和 this.msgTokens.length 都不该为0 ，此时应该至少有1条数据，([0] = System Prompt 系统指令)。 \r\n\r\nthis.msgContent.length: " +  this.msgContent.length  + "\r\n\r\nthis.msgTokens.length: " + this.msgTokens.length  ); }
							
					}else{
						//templastmsgHtml is Me, it must be a failed message. 最后一条为发送失败的msg
						 
							// length-1 是最后一条AI回复的数据(无论隔着多少条发送失败的记录)，或是msgTokens[0]的数据(无记忆)
							totaltokens_temp = this.msgTokens[this.msgTokens.length - 1]["total_tokens"];  // int
							if( this.userMsgTokensForRetry != 0 ){
								// != 0： 说明是曾经AI回复过，且已经重试过，但重试失败了。（重问成功，userMsgTokensForRetry会被清零）
								// != 0： AI replied before and has already been retried, but the retry failed. (If the retry succeeds, userMsgTokensForRetry will be reset to zero.)
								totaltokens_temp = this.userMsgTokensForRetry;
							}
					}
				
				 	this.totaltokens = totaltokens_temp;


					if (this.msgContent.length == 0  || this.msgContentForMsgList_SingleRound.length == 0){
						console.error("retry(). length == 0. [Retry] 意外错误 Error bug");
					}
				  	
					//'templastmsgContent' Last sent question. (Not processed by marked.js + highlight.js.)
					this.isRetry_RetryMessage = templastmsgContent['content']; //新的方法(new version)，作用：[重问]会替换和清空聊天输入框，新版可避免这种潜在的丢失数据的风险。
					
					//必须用$nextTick(()。 Tips：清空记忆后，会产生分割线，此时问题发出后，中间会显示时间，此时点击重问，居中的WeChatStyleDatetime不会随着pop()消失。加上$nextTick后，等待pop()执行/修改DOM/渲染...彻底完成后，居中的时间会被顺利删除，此时再重问。
					this.$nextTick(() => {
						this.sendMsg(); 
					});
				}
				else{
					//err  If the code has reached here, it means there is an error.
					console.error("retry(). length <= 1 && Retry is available. [Retry] 意外错误 Error bug");
					this.btnDisabledState_Undo = true;  
					this.btnDisabledState_Clear = true;
				}
 			}, 
			//按钮：点击验证API-Key  Check API-key
			checkAPIbtn(){
				let notif = '';

				if (this.api.trim() == ""){
					this.sentext = this.settingsLanguage == 'cn' ? '先验证API' : 'Check API First';
					notif =  this.settingsLanguage == 'cn' ?  '请填入API-Key' : 'Please enter the API-Key';
					this.showNotification(notif, 'bottom');
					return;
				}
				
				//是否正在发送
				if(this.isSendingNow) {
					return;
				}
				
				const currentTime = new Date().getTime(); // 获取当前时间
				if (currentTime - this.lastCheckApiTime < 4000) { 
					// 与上一次点击时间比较，小于4秒则返回
					notif =  this.settingsLanguage == 'cn' ?  '请勿频繁发送请求，需间隔4秒' : 'Requests too fast, please wait 4 seconds between each one.';
					this.showNotification(notif, 'bottom','',2600);
					return;
				}
				// 4秒内只能提交一次验证，防止过快重复点击
				this.lastCheckApiTime = currentTime; // 更新上一次点击时间
	  
				this.isCheckingApiKeyNow = true; //正在验证中，之后不能再有"return"代码
				this.btnDisabledState_ApiURL = true;
				this.btnDisabledState_Language = true;
				this.btnDisabledState_ContextualMode = true;
				
				this.beginLoadingAnimation();
				document.querySelector('.inputapikey').readOnly = true; //验证中，apikey禁止改动
				notif =  this.settingsLanguage == 'cn' ?  '验证中...' : 'Checking...';
				this.showNotification(notif, 'bottom','',60000);
			
			    //为false，表示新窗口从未写入过指令[是否在代码中写了默认的system prompt]。  如果代码里设置了默认system，这里做第一次写入system的动作 
				if(!this.hasSystemPromptBeenSaved){
					if(this.gptSystemPrompt.trim() == "" &&  this.btnDisabledState_SetSystemPrompt ){
						this.hasSystemPromptBeenSaved = true;
					}
					else{
						//其余情况强行写入system一次+禁用按钮。需要排除存在隐形提示词的情况
						//隐形提示词 仅当gptSystemPrompt_hidden隐藏提示词不存在时
						if(this.gptSystemPrompt_hidden.trim() == ''){
							this.btnDisabledState_SetSystemPrompt = true;
							this.msgContent[0] =  {"role": "system", "content": this.gptSystemPrompt.trim() };
							this.msgContentForMsgList_SingleRound[0] =  {"role": "system", "content": this.gptSystemPrompt.trim() };
							this.gptSystemPromptReadOnly = this.gptSystemPrompt.trim();
							
							this.addSystemPromptToChatHistory( '### #默认的系统提示词 system prompt ', '### #Default System Prompt ' ); //this.chathistory
						}
						this.hasSystemPromptBeenSaved = true;
				   }
				}
				
				//用随机字符串验证api，考虑: 使用人数多时，重复发单一内容给OpanAI服务器，会受惩罚
				let arrayStr = ["hi~", "Hey ChatGPT", "hi", "hello", "Hi, how are you?", "What's up?", "Hello there!", "How are you", "Hey!", "Sup?", "Yo!", "Howdy!", "Hey?", "Yo~", "Hiya", "Hello GPT, what's up?", "Hey GPT"] ; 
				let randomString = 'hi' ;
				if (arrayStr.length > 0) {
					randomString  = arrayStr[Math.floor(Math.random()*arrayStr.length)];
				}
				if (typeof randomString !== 'string') {
					randomString = 'hi' ;
				}
				
				
				// Check API-key, not chat
				//下面这行是验证API-Key时的参数，不是聊天的参数，一般不需要改动
				axios.post( this.apiURL , {
				    messages: [{"role": "user", "content": randomString }], max_tokens: 30, model: this.apiGPTModel
				}, {
				    headers: { 'content-type': 'application/json', 'Authorization': 'Bearer ' + this.api }
				}).then(res => {
					//console.log('suss',res);
					this.isCheckingApiKeyNow = false; //更新验证的状态
					this.endLoadingAnimation();
					document.querySelector('.inputapikey').readOnly = false; //验证结束，apikey恢复可改
					
					
					this.btnDisabledState_CheckAPI = true;
					this.btnDisabledState_Sending = false;
					//重新验证后，恢复按钮的准确状态
					if (this.msgContent.length > 1){
						//清空-恢复可用 撤销&重问-恢复可用
						this.btnDisabledState_Clear = false;
						this.btnDisabledState_Undo = false; 
					}else if (this.msgContentForMsgList_SingleRound.length > 1){
						//清空-保持不可用 撤销&重问-恢复可用 
						this.btnDisabledState_Clear = true;
						this.btnDisabledState_Undo = false; 
					}
					this.btnDisabledState_ApiURL = false;
					this.btnDisabledState_Language = false;
					this.btnDisabledState_ContextualMode = false;
					
					this.sentext = this.settingsLanguage == 'cn' ? '发送' : 'Send';
					this.apibtntext = this.settingsLanguage == 'cn' ? '已验证' : 'Checked';
					notif =  this.settingsLanguage == 'cn' ?  '验证成功，API-Key可用' : 'Successful, API-Key is valid.';
					this.showNotification(notif, 'bottom', '',1800 );
					
					
					//记录已验证的api-key信息
					//是否存在，对比 key+url
					const matchingItems = this.apiCheckedData.filter(item => item.apikey.trim() == this.api.trim() && item.apiurl.trim() == this.apiURL.trim());
					//不存在则追加，存在则修改更新验证时间
					if (matchingItems.length == 0) {
						this.apiCheckedData.push({
							"apikey": this.api.trim(), //记录通过验证的key
							"apiurl": this.apiURL.trim(), //记录对应的url
							"date1": new Date().getTime()  //记录时间 
						})
					} else {
						matchingItems.forEach(item => {
							item.date1 = new Date().getTime();
						});
					}
					// 删除 apikey 为空的项
					this.apiCheckedData = this.apiCheckedData.filter(item => item.apikey.trim() !== '');
					
					
					//以上：每次验证成功/失败都会改变的状态   修改的话，inputapichange()里也要修改。
					//以下：首次验证成功后就不再改变的状态，相当于初始化
					
					// none
					
				}).catch(error =>{
					console.log('error',error);
					this.isCheckingApiKeyNow = false; //更新验证的状态
					this.endLoadingAnimation();
					document.querySelector('.inputapikey').readOnly = false; //验证结束，apikey恢复可改
					
					//api-key可重复验证，虽限制4秒才能发送一次请求，但仍然会出现这种情况：服务器慢，同时存在多次请求，当1个请求通过验证后，第2次或之后的可能因为“短时间请求过快”而未通过，造成多个控件又变成不可用的状态。
					//通过以下逻辑可以解决这个问题：当报错时，代码执行到此处，this.btnDisabledState_Sending==false  或 this.btnDisabledState_CheckAPI==true 都可以说明刚通过了验证					
					if (!this.btnDisabledState_Sending && this.btnDisabledState_CheckAPI){
						return;//已存在验证通过的Key，忽略报错
					}
					
					//以上是必须执行的
					
					//以下修改的话，inputapichange()里也要修改
						
					this.btnDisabledState_CheckAPI = false;
					this.btnDisabledState_Sending = true;
					this.btnDisabledState_Clear=true;
					this.btnDisabledState_Undo=true; 
					this.btnDisabledState_ApiURL = false;
					this.btnDisabledState_Language = false;
					this.btnDisabledState_ContextualMode = false;
						
					this.apibtntext = this.settingsLanguage == 'cn' ? '<< 验证' : '<< Check';
					
					if( error.message &&  error.message.includes('Type error')){
						//密钥含非法符号、全角符号等 illegal symbols
						this.sentext = this.settingsLanguage == 'cn' ? 'API-key错误' : 'API-key Error';
					}else if( error.message &&  error.message.includes('401')){
						// 401-1 & 401-2 密钥无效 API-key Error
						this.sentext = this.settingsLanguage == 'cn' ? 'API-key错误' : 'API-key Error';
					}else {
						// 其他情况 other
						this.sentext = this.settingsLanguage == 'cn' ? '先验证API' : 'Check API First';
					}
					
					//错误代码 弹窗
					this.catchApiErrorCode(error);

				})
			},
			//验证&发送的错误代码 错误弹窗 Check Send Err
			catchApiErrorCode(error) {
			
				let notif_cn, notif_en, title; //中，英，标题
				let responseObject; //responseText
				let responseMessage = ''; //OpenAI Error Message
				let responseType = ''; //OpenAI Error Type
					
				// OpenAI官网关于错误代码的解释： OpenAI - API Error Codes Explained:
				// https://help.openai.com/en/collections/3808446-api-error-codes-explained

				if (error.request && error.request.responseText) {
					responseObject = JSON.parse(error.request.responseText); // 将 JSON 字符串解析为 JavaScript 对象
					responseMessage = responseObject.error.message ? responseObject.error.message : '' ; // 读取 message 属性的值
					responseType = responseObject.error.type ? responseObject.error.type : '' ; // 读取 type 属性的值
				}
					
				//判断错误类型
				if( error.message &&  error.message.includes('Type error')){
				//密钥含非法符号、全角符号等 illegal symbols
					notif_cn = 'API-Key含有非法符号。OpenAI的所有密钥均以 sk- 开头，不含有汉字、全角符号或其他非法符号。建议复制粘贴API-Key，避免意外输入全角符号或其他非法符号。';
					notif_en = 'All the OpenAI keys begin with sk- as the first three characters, and do not contain any full-width symbols, or other illegal symbols.';
					title = this.settingsLanguage == 'cn' ?  '错误 - API-Key格式非法' : 'Error - API-Key Has Invalid Format';
				}else if( error.message &&  error.message.includes('401')){
				// OpenAI 401-1 & 401-2 密钥无效 API-key Error 
					notif_cn = 'API-Key无效。OpenAI的所有密钥均以 sk- 开头，建议复制粘贴API-Key，避免输错。如果仍然出错，说明是无效密钥，或密钥已被停用、删除，建议登录OpenAI官网查看API-Key是否出现变动。';
					notif_en = 'API-Key is invalid. All the OpenAI keys begin with sk- as the first three characters. It is recommended to copy and paste the API-Key to avoid input errors. If the error persists, it indicates an invalid API key or that the API key has been deactivated or deleted, please log in to OpenAI to check the API-Key.';
					title = this.settingsLanguage == 'cn' ?  '错误 - 401 无效的API-Key' : 'Error - 401 API-Key is invalid';
				}else if( error.message &&  error.message.includes('429')){
				// OpenAI 429 x 4
					if ( responseMessage.includes('Rate limit') && responseType == 'requests' ){
					// 429-1 请求过快 Rate limit 
						notif_cn = '请求过于频繁，API速率限制已达上限，短时间内提交了过多的请求或令牌（tokens），超出允许的请求数量。';
						notif_en = 'The API rate limit has been reached, possibly due to submitting too many requests or tokens in a short period of time, exceeding the allowed number of requests.';
						if ( responseMessage.includes('Limit: 3 / min') ){
							notif_cn = notif_cn + "\r\n官方免费账号限制单个Key每分钟最多3次请求（GPT3.5模型），请20秒后再试。";
						}
						title = this.settingsLanguage == 'cn' ?  '错误 - 429 请求速度过快' : 'Error - 429 Rate limit reached for requests';
					} else if ( responseMessage.includes('You exceeded your current quota') || responseType == 'insufficient_quota' ){
					// 429-2 超出配额 Insufficient quota 
						notif_cn = '超出配额，账号已无额度。例如：免费账号超额或到期、账号达到月度最大支出限制、账号达到设定的周期限制...';
						notif_en = 'Exceeding current quota, such as reaching maximum monthly spend, exceeding free plan limits, or reaching expiration.';
						title = this.settingsLanguage == 'cn' ?  '错误 - 429 配额不足' : 'Error - 429 Insufficient quota';
					} else if ( responseMessage.includes('The engine is currently overloaded') ){
					// 429-3 服务器过载 Servers overloaded 
						notif_cn = '服务器正在面临着高流量访问，或正在维护更新，当前繁忙，无法处理请求。请稍等片刻后重试。';
						notif_en = 'Servers are experiencing high traffic and are unable to process your request at the moment. Please retry your requests after a brief wait.';
						title = this.settingsLanguage == 'cn' ?  '错误 - 429 服务器过载' : 'Error - 429 Servers overloaded';
					} else if ( responseMessage.includes('That model is currently overloaded with other requests') ){
					// 429-4 模型超载  Model overloaded  tips: responseType = server_error
						notif_cn = '该模型当前已经超载，请稍等片刻后重试。';
						notif_en = 'That model is currently overloaded with other requests. Please retry your requests after a brief wait.';
						title = this.settingsLanguage == 'cn' ?  '错误 - 429 模型超载' : 'Error - 429 Model overloaded';
					} else {
					// 429-other 其他未知 
						notif_cn = 'HTTP请求 - 错误代码:  ' + error.code + '\r\nHTTP请求 - 错误信息:  ' + error.message;
						notif_en = 'HTTP Error Code:  ' + error.code + '\r\nHTTP Error Message:  ' + error.message;
						title = this.settingsLanguage == 'cn' ?  '错误 - 429 其他' : 'Error - 429 Other';
					}
				}else if ( error.message &&  error.message.includes('404')){
				// OpenAI 404 非组织成员 Account is not part of an organization
					notif_cn = '必须是组织的成员才能使用API，而当前账号不属于任何组织。OpenAI官方解释：https://help.openai.com/en/articles/6891827-error-code-404-you-must-be-a-member-of-an-organization-to-use-the-api ';
					notif_en = 'To use the API, you must be a member of an organization, and your current account is not part of an organization. OpenAI API Error Codes Explained: https://help.openai.com/en/articles/6891827-error-code-404-you-must-be-a-member-of-an-organization-to-use-the-api ';
					title = this.settingsLanguage == 'cn' ?  '错误 - 404 账号不属于任何组织' : 'Error - 404 Account is not part of an organization';
				}else if( error.message &&  error.message.includes('500')){
				// OpenAI 500 服务器问题 Server error
					notif_cn = '服务器在处理您的请求时出现错误，是服务器的问题，请稍等片刻后重试。';
					notif_en = 'The server had an error while processing your request. Issue on OpenAI servers, please retry your requests after a brief wait.';
					title = this.settingsLanguage == 'cn' ?  '错误 - 500 服务器在处理请求时出错' : 'Error - 500 Server error while processing request';
				}else if ( error.message && error.message == 'timeout exceeded' ){
				// 网络超时 Timeout exceeded
					notif_cn = '连接超时，请先检查您的网络状态。如果网络正常，需要确认您的IP所在地（国家或地区）是否属于OpenAI的服务范围内。如果您在国内使用OpenAI官方接口，必须使用"魔法"才能建立连接。如果您使用第三方接口，需要明确该接口是否支持免"魔法"，以及该接口当前是否为可用状态（第三方稳定性不如官方）。\r\n\r\nOpenAI支持的国家或地区:(需魔法) https://platform.openai.com/docs/supported-countries \r\n什么是"魔法"？一种可以让您的手机或电脑出趟国的技术，优质的魔法会让OpenAI认为您的设备是真的在国外。';
					notif_en = "Connection timed out. Please check your network and confirm whether your IP location is within OpenAI's service scope to decide whether V P N is required. If using third-party interfaces, ensure their validity. \r\n\r\nSupported countries and territories:  https://platform.openai.com/docs/supported-countries ";
					title = this.settingsLanguage == 'cn' ?  '错误 - 网络连接超时' : 'Error - Timeout exceeded';
				}else if ( error.message && error.message == 'Network Error' ){
				// 网络故障 Network Error *第三方接口每分钟超3次也会导致这个错误
					notif_cn = '网络错误，可能只是暂时的，建议先重试一次。\r\n网络错误存在多种可能，请自行排查：\r\n  • 无法与接口网址（API url）建立连接，该服务器不存在或遇故障当前无法访问；\r\n  • 本机当前无网络，网络已断开或网络不稳定，请检查网络状态后重试；\r\n  • IP限制，该IP或其所在地被限制访问。可尝试使用"魔法"，如果正在使用，请检查"魔法"是否不稳定或已经断开；\r\n  • 若使用第三方接口，发送请求太快可能也会出现网络错误的代码（Network Error），请尝试减缓发送频率；\r\n  • 其他原因，请以实际情况为准。';
					notif_en = 'Network error. The error may be temporary, so it is recommended to try again first. \r\nPossible reasons:\r\n  • Unable to connect to the API Endpoint (API url). The server does not exist or is not accessible due to a malfunction.\r\n  • Your device is currently not connected to the network. The network may be disconnected or unstable. Please check the network status and try again.\r\n  • Due to limitations on this IP or its location, access may be restricted. You could try using a V P N. If you are already using a V P N, please check if it is unstable or has been disconnected.\r\n  • When using third-party interfaces, sending requests too quickly may also result in "Network Error". Please avoid sending requests too fast.\r\n  • For any other reasons, please refer to the actual situation.';
					title = this.settingsLanguage == 'cn' ?  '错误 - 网络故障' : 'Error - Network error';
				}else if ( error.message && error.message.includes('400') && responseMessage.includes('Please reduce the length of the messages' )){
				// OpenAI 400 
					//20230606 适配GPT3.5免费计划，其他类似账号的情况未知。 Adapted for the free plan account of GPT3.5, based on the GPT3.5 free plan.
				
					let tips_cn = '';
					let tips_en = '';
					
					const maxLengthRegex = /maximum context length is (\d+) tokens/;
					const maxLengthMatch = responseMessage.match(maxLengthRegex);
					const maxLength = maxLengthMatch ? maxLengthMatch[1] : null;

					const a_messagesRegex = /messages resulted in (\d+) tokens/;
					const a_messagesMatch = responseMessage.match(a_messagesRegex);
					const a_messagesLength = a_messagesMatch ? a_messagesMatch[1] : null;

					const b_requestedRegex = /requested (\d+) tokens \(/;
					const b_requestedMatch = responseMessage.match(b_requestedRegex);
					const b_requestedLength = b_requestedMatch ? b_requestedMatch[1] : null;

					const b_messagesRegex = /\((\d+) in the messages,/;
					const b_messagesMatch = responseMessage.match(b_messagesRegex);
					const b_messagesLength = b_messagesMatch ? b_messagesMatch[1] : null;

					const b_completionRegex = /, (\d+) in the completion/;
					const b_completionMatch = responseMessage.match(b_completionRegex);
					const b_completionLength = b_completionMatch ? b_completionMatch[1] : null;
						
					if ( maxLength != null && a_messagesLength != null ){
					//发送出的上下文超限制
						tips_cn += '\r\n\r\n' ;
						tips_cn += '#A = 当前模型支持的最大上下文长度：' + maxLength + ' tokens\r\n' ;
						tips_cn += '#B = 您当前发送的上下文长度：' + a_messagesLength + ' tokens (GPT的记忆，包含本次发送内容)\r\n' ;
						tips_cn += '#C = GPT尚未回复的单条内容长度：未知 \r\n' ;
						tips_cn += '规则： B + C  < A ( ' + maxLength + ' )\r\n' ;
						tips_cn += '当前：仅 B 就已经超过 ' + maxLength ;
						if ( !this.isSimpleMode ){
							tips_cn += '\r\n *  token：单位，即"令牌"\r\n' ;
							tips_cn += ' *  接口版ChatGPT(GPT3.5)最高只支持 4096/4097 tokens' ;
						}
						notif_cn = '发送失败，GPT记忆（上下文长度）超过上限。关闭通知后，您可以选择：修改发送内容长度、撤销聊天记录等操作来继续之前的对话。';
						notif_cn = notif_cn + tips_cn ;
						
						tips_en += '\r\n\r\n' ;
						tips_en += '"messages" :  The current length of the context (including the last message sent).' ;
						notif_en = "Sending failed. The length of the context exceeds the limit. After closing the notification, you can choose to modify the content, or undo to continue.";
						notif_en = notif_en + tips_en ;
						
						title = this.settingsLanguage == 'cn' ?  '错误 - 400 记忆达到上限' : 'Error - 400 Context length exceeds the limit';
					}else if ( maxLength != null && b_requestedLength != null  && b_messagesLength != null  && b_completionLength != null ) {
					//发送出的上下文  + max_tokens > 超限制
						tips_cn += '\r\n\r\n' ;
						tips_cn += '#A = 当前模型支持的最大上下文长度：' + maxLength + ' tokens\r\n' ;
						tips_cn += '#B = 您当前发送的上下文长度：' + b_messagesLength + ' tokens (GPT的记忆，含本次发送内容)\r\n' ;
						tips_cn += '#C = 当前设置允许GPT回复的最大长度：' + b_completionLength + ' tokens (API设置：max_tokens)\r\n' ;
						tips_cn += '#D = B + C ，当前 D = ' + b_requestedLength + ' tokens\r\n' ;
						tips_cn += '规则：D < ' + maxLength + ' \r\n' ;
						tips_cn += '当前：D > ' + maxLength + ' \r\n' ;
						tips_cn += '解释：总量 A 有限制，当记忆 B 增加到某个程度时， C (max_tokens) 就需要动态下调\r\n';
						const diffC = parseInt(maxLength) - parseInt(b_messagesLength) ;
						tips_cn += '调整：如果不修改发送内容，当前 A - B = ' + diffC + '，所以必须调整API设置中的"max_tokens"，最大为 ' + (diffC - 1) + '，然后重问即可';
						if ( !this.isSimpleMode ){
							tips_cn += '\r\n *  token：单位，即"令牌"\r\n' ;
							tips_cn += ' *  接口版ChatGPT(GPT3.5)最高只支持 4096/4097 tokens' ;
						}
						notif_cn = '发送失败，GPT记忆（上下文长度）即将超限。关闭通知后，您可以选择：调整max_tokens后点击重问、撤销聊天记录、修改发送内容长度等操作来继续之前的对话。';
						notif_cn = notif_cn + tips_cn ;
						
						tips_en += '\r\n\r\n' ;
						tips_en += '"messages" :  The current length of the context (including the last message sent).\r\n' ;
						tips_en += '"completion" :  The API parameter "max_tokens" (adjustable in the API settings).\r\n' ;
						tips_en += "Tips: Here's an example, if you don't want to modify the content being sent: Currently " + maxLength + ' - ' + b_messagesLength + ' = ' + diffC + ', so you need to adjust the "max_tokens" in [API Settings] to be less than ' + diffC + ' (maximum value is ' + (diffC - 1) + '), then click [Retry] to resend the request.' ;
						notif_en = "Sending failed. The length of the context is about to exceed the limit. After closing the notification, you can choose to retry after modifying the max_tokens, undo, or modify the content to continue.";
						notif_en = notif_en + tips_en ;
						
						title = this.settingsLanguage == 'cn' ?  '错误 - 400 记忆即将达到上限' : 'Error - 400 Context length is about to exceed the limit';
					}else{
						notif_cn = '发送失败，GPT记忆（上下文长度）达上限。';
						notif_en = "Sending failed. The length of the context exceeds the limit. ";
						title = this.settingsLanguage == 'cn' ?  '错误 - 404 ? ' : 'Error - 404 ? ';
					}
					
				}else{
				//未知情况  other ？
					notif_cn = 'HTTP请求 - 错误代码:  ' + error.code + '\r\nHTTP请求 - 错误信息:  ' + error.message;
					notif_en = 'HTTP Error Code:  ' + error.code + '\r\nHTTP Error Message:  ' + error.message;
					title = this.settingsLanguage == 'cn' ?  '错误 - ?' : 'Error - ?';
				}
					
				if ( responseMessage != '' || responseType != '' ) {
					notif_cn = notif_cn + '\r\n\r\nOpenAI - API错误信息:\r\n' + responseMessage + '\r\nOpenAI - API错误类型:\r\n' + responseType ;
					notif_en = notif_en + '\r\n\r\nOpenAI - API Error Message:\r\n' + responseMessage + '\r\nOpenAI - API Error Type:\r\n' + responseType ;
				}
				notif =  this.settingsLanguage == 'cn' ?  notif_cn : notif_en;
					
				//tips：延迟唯一用途：针对'Type error'错误，本地验证报错速度快，底部通知“验证中...”刚弹出就报错，会导致底部通知的计时器来不及关闭，计时器会继续运行，60秒结束后会关闭通知（此时若有通知，会莫名其妙被关闭）。
				setTimeout(() => {
					this.showNotification(notif, 'center', title);
				}, 450);
				
			},	
			//聊天记录滚动至最下方。Scroll to the bottom of the chat.
			scrollToBottomView() {
				//Tips： body-Height 以下3个都可以能用
				//document.body.offsetHeight
				//document.body.clientHeight
				//document.body.scrollHeight

				//Tips： screen-Height
				//window.screen.height xxxxxx
				//window.screen.availHeight xxxxxx
				//window.outerheight  xxxxx 
				//window.innerHeight  xx 移动端：会跟随双指放大改变；软键盘弹出后会改变。
				//document.documentElement.clientHeight 与window.innerHeight一样，但是：不会跟随双指放大而改变；软键盘弹出后也不会改变。

				const positioningDiv = document.querySelector('.bottom-position');
				//加入<!DOCTYPE html>后  问题得到解决
				const bodyheight = document.body.offsetHeight + 8 + 8 ; //margin-top:8  margin-bottom:8
				const screenheight = document.documentElement.clientHeight;
				if (bodyheight > screenheight) { 
					this.$nextTick(() => {
				    	positioningDiv.scrollIntoView({behavior: 'smooth',block: 'start'});
	  				});
				}
			},
			//移动端 - 点击输入框 - 聊天记录滚动至最下方。 For Mobile - Click on chat input box -  Scroll to the bottom of the chat. 
			scrollToBottomViewClick() {
				//检测是否为移动端 且是否为首次点击
				if ( this.isfirstclickonchatinputbox && navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)) {
				     	
						this.isfirstclickonchatinputbox = false;
						this.scrollToBottomView();
				}
			},
			//关闭软键盘，移动端头几条内容较短的信息不会产生屏幕滚动，这里做关闭软键盘处理，可以看到消息，体验会更好。 close Software Keyboard For Mobile
			closeSoftwareKeyboard() {
			 	const bodyheight = document.body.offsetHeight - 95 + 8 ; //bottom-position:95   margin-top:8
				const screenheight = document.documentElement.clientHeight;
				let closeSoftwareKeyboard = false;
				if (navigator.userAgent.match(/(pad|iPad)/i)) {
					//(平板) 每次发送后关闭软键盘
					if (bodyheight < screenheight*3/7) { 
			 			closeSoftwareKeyboard = true;
					}
				}else if (navigator.userAgent.match(/(phone|pod|iPhone|iPod|ios|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i) ) {
					//(手机) 每次发送后关闭软键盘
					if (bodyheight < screenheight*5/7) { 
						closeSoftwareKeyboard = true;
					}
				}
				if(closeSoftwareKeyboard) {
					this.$nextTick(() => {
						if (document.activeElement && document.activeElement !== document.body) {
							document.activeElement.blur();
						}
	  				});
				}
				
			},	
			//对话框 电脑端支持组合键换行(Line break)  支持Ctrl+Enter 和 Commond+Enter 和 Win+Enter 换行，另有shift+enter（无需设置）
			newLine(e) {
				//解决safari每次都是换两行的bug，其他浏览器正常   e=ee？
				let ee = window.event || arguments[0];
				ee.returnValue = false;
				
				 // 1.获取光标位置
				const ele = e.target;
				const cursorIndex = ele.selectionStart;
				// 2.光标后加入换行符
				let temp_text = this.msg.split('');
				temp_text.splice(cursorIndex, 0, '\n');
				this.msg = temp_text.join('');
				// 3.移动光标 摘：“移动光标时要注意，因为Vue响应式，在修改了text的值后，如果立刻执行移动光标，则紧接着就会因为重新设置了text的值，光标会移动到最后，所以要等dom操作完毕后，再进行移动光标的操作。”
				Vue.nextTick(() => {
					ele.selectionStart = ele.selectionEnd = cursorIndex + 1;
					
					//自适应高度
					ele.style.height = '38px'; //about：自适应高度 max-height maxHeight 
					ele.style.height = ele.scrollHeight + 'px'; 
				}) 
			},
			//对话框 按回车键Enter发送之前需要判断是否为中文输入法  The current input method is in Chinese or not.
			textareaEnter(e) {
				let ee = window.event || arguments[0];
				 
     
	 			//电脑端中文输入法时ee.keyCode为229，即中文输入法/中英混输/拼音状态下输入英文时，避免按回车键后直接发送出去
				if (ee.key == "Enter" && ee.code == "Enter" && ee.keyCode == 13) {
					//阻止原始控件回车换行的动作
					ee.returnValue = false;
					
					//执行发送
					this.sendMsg();
				}
			},
			
			
			//按钮：发送  Send
            sendMsg() {
			
				//是否正在验证api-key
				if(this.isCheckingApiKeyNow) {
					return;
				}
				if (this.btnDisabledState_Sending){
					//一般不会遇到这种情况
					return;
				}
				if (this.api.trim() == ""){
					//一般不会遇到这种情况
					this.sentext = this.settingsLanguage == 'cn' ? '先验证API' : 'Check API First';
					return;
				}
				if (!this.btnDisabledState_CheckAPI){
					//一般不会遇到这种情况
					this.sentext = this.settingsLanguage == 'cn' ? '重新验证API' : 'Recheck API';
					this.apibtntext =  this.settingsLanguage == 'cn' ? '<< 验证' : '<< Check';
					return;
				}
				//以上代码有些重复、多余
				
				if ( window.marked == null ){
					alert("marked.js（Markdown插件）尚未加载成功，请数秒后再尝试...\r\nmarked.js (Markdown Plugin) has not been loaded successfully, please try again in a few seconds...");
					return;
				}
				
				let isRetry = false; //**是否重问，默认false - 正常发问
				let sendMessage = ''; //**需要发送的问题，初始值为空
				if(this.isRetry_RetryMessage != "")
				{
					isRetry = true; //当前是重问状态
					sendMessage = this.isRetry_RetryMessage; //数据转移 
				}
				this.isRetry_RetryMessage = ''; //**重置，不再使用isRetry_RetryMessage，减少出错风险。 Reset, stop using isRetry_RetryMessage to reduce the risk of errors.
				
												
				// **如果不是[重问]，是在[正常发问] - 那么需要判断this.msg是否为空 
				if ( !isRetry && this.msg.trim() == ""){
					const notif =  this.settingsLanguage == 'cn' ?  '不能发送空白消息' : 'Unable to send blank messages' ;
					this.showNotification(notif, 'bottom');
					return;
				}
				
				this.isSendingNow = true; //更新发送的状态，之后不能再出现"return"代码
				this.btnDisabledState_ApiURL = true;
				this.btnDisabledState_Language = true;
				this.btnDisabledState_ContextualMode = true;
				

				//[length - 1]["my"] = ture :说明最后一条是失败记录，属于my/user，且现在点击的是发送，而不可能是重问。（重问是先将list.pop，之后再模拟发送）
				if(this.msgList[this.msgList.length - 1]["my"]){
					if(this.msgContentForMsgList_SingleRound[this.msgContentForMsgList_SingleRound.length - 1]["content"] != this.msg ){
						this.userMsgTokensForRetry = 0; //重问失败后，提问内容发生改变时(即不再重问时)，userMsgTokensForRetry需要归0。
					}
				} 
				
				
				this.beginLoadingAnimation();
				document.querySelector('.inputapikey').readOnly = true; //发送中，apikey禁止改动
				
				//**正常发问- sendMessage需要替换为this.msg
				if ( !isRetry ){
					sendMessage = this.msg ;
				}
				
				// v5.16 BUG A
				// 发现意外bug： marked.parse(某些非空字符串)，意外输出为空("")，与初始化设置的参数无关，示例如下：
				// 1.err 输出为空的例子：marked.parse("[ 2]:this")  marked.parse("[ai]:is")   marked.parse("[ 2]:我")  marked.parse("[ 2]: 的")  marked.parse("[e1]: 3")
				// 2.ok  可正常输出的例子：marked.parse("[ 2]:this is")  marked.parse("[ai] :is")    marked.parse("[ 2]: 的this is a demo")  marked.parse("[e1]: ")
				// 原因未知，解决方案：判断userMsgMarkdown 是否异常为空，如果是，就使用sendMessage原文替换。
					
				// v5.16 BUG B
				// 另外，有些无意义无逻辑的问题，AI可能会回复空值，这时会出现个bug：AI回复为空导致气泡框显示为空，css样式上气泡框会变很小，而气泡框上的“箭头”无法被遮挡。
				// 解决方式，如果真的是空值，则替换为带有<p></p>标签的空格
					
				let userMsgMarkdown = marked.parse(sendMessage); // marked.js + highlight.js  Markdown+高亮处理
				if ( sendMessage.trim() == "" || sendMessage.replace(/^\n|\n$/g, "").trim() == ""){
					userMsgMarkdown = "<p> </p>"; //*目前“发送内容”sendMessage不允许为空，不会执行到这里
				}else if ( userMsgMarkdown.trim() == "" ){
					userMsgMarkdown = "<p>" + sendMessage + "</p>"; //v5.16 BUG A ： 问题不为空，但marked处理后变成空，则userMsgMarkdown重置为未经过marked处理的原文
				}
				
				const userMsgDatetimeNow = this.formatDateYYYYMMDDHHmmss(new Date(),':');
				
				// this.msgList.push this.msgContentForMsgList_SingleRound.push
                this.msgList.push({
                    "msg": '<p>' + userMsgMarkdown + '</p>',  //不会被渲染。加<p>作用不大，但还是加吧。之前是放在<p>x.msg</p>，临时用，渲染时会被删除覆盖。
                    "my": true,
					"datetime": userMsgDatetimeNow
                })
				
				
				//渲染 usermsg  6.01:发现vue有个“v-html” 绑定后可以实时渲染。算了，暂时不改。
				this.$nextTick(() => {
					const divs = document.querySelectorAll('div.usermsg'); 
					const lastDiv = divs[divs.length - 1];
					if(userMsgMarkdown.trim() == ""){
							userMsgMarkdown = "<p> </p>"; // v5.16 BUG B ： 问题不为空，则输出加了<p>标签的空格，撑起高度，保持正确的气泡框样式
						}
				    lastDiv.innerHTML = userMsgMarkdown;
					
					//判断是否需要关闭软键盘
					this.closeSoftwareKeyboard();
					
					//滚动到最底部
					this.scrollToBottomView();
					
					//一键复制按钮。搜索div内容，找到符合条件的代码块，添加按钮。 addCopyButton.  Copying code to the clipboard 						
					this.addCopyButtonToPreTags(lastDiv) ;
					
					//一键复制按钮。为聊天气泡框添加一键复制按钮。 addCopyButton.  Copying Chat Message to the clipboard 	
					this.addCopyButtonToChatMessage(lastDiv.parentElement) ;
					
					// 判断usermsg父元素<DIV>的前面是否有分割线。 *此条消息的datetime，不一定是本轮记忆的初始时间（因为消息可以撤销）。 *Tips：“previousElementSibling”:当前同一层级的前一个兄弟元素，不存在则为null
					if (lastDiv.closest('.userinfo').parentElement.previousElementSibling.tagName === "HR") {
						//添加微信样式的时间  时间格式会转换为MMDDHHmm
						this.add_span_WeChatStyleDatetime(lastDiv.closest('.userinfo').parentElement, userMsgDatetimeNow);
					}else{
						//无分割线时：判断聊天记录的时间跨度是否超过5分钟
						if( this.displayDatetime_WeChatStyle() != null ){
							//添加微信样式的时间  时间格式会转换为MMDDHHmm
							this.add_span_WeChatStyleDatetime(lastDiv.closest('.userinfo').parentElement, userMsgDatetimeNow);
						}
					}
				});
					
				
				//
				//如果想取消验证api功能，需要在这里补代码：首次写入默认的this.gptSystemPrompt.trim()到this.msgContent[0]中
				//
				
								
				//以下if语句的作用：一旦设置了gptSystemPrompt_hidden ，即 设置了[隐形指令/隐藏指令/隐形提示词/隐藏提示词]，那么每次发送问题时，都会重置指令为 gptSystemPrompt_hidden 的内容，即以代码里的[隐形指令]为准，自动忽略聊天界面上的指令（包括空白的指令）。不要改动这里的代码。
				//			    如果未设置隐形指令，那么当gptSystemPrompt(默认指令或聊天界面)
				if (this.gptSystemPrompt_hidden.trim() != "") {
                    this.msgContent[0] =  {"role": "system", "content": this.gptSystemPrompt_hidden.trim() };
                    this.msgContentForMsgList_SingleRound[0] =  {"role": "system", "content": this.gptSystemPrompt_hidden.trim() };
					this.gptSystemPromptReadOnly = "hidden system prompt";
                }				
							
				this.msgContent.push({"role": "user", "content": sendMessage });
				//completion_tokens(本次提问内容的token数)需要等下次对话结束才能计算得出（提问的token数会比实际的高，疑似官方会添加隐藏的提示词。意义大不，仅做参考）
				//截止本次提问的total_tokens(回复前，含提问内容)需要等AI回复后才能得到数据
				//系统提示词随时可改，这会使记录的user数据变得不准确。
				this.msgTokens.push({"role": "user", "completion_tokens": 0 , "total_tokens": 0 }); // 先写入0 int
				this.succQA_Count = this.msgContent.length - 1; //int. 更新
				
				// this.msgList.push this.msgContentForMsgList_SingleRound.push
				this.msgContentForMsgList_SingleRound.push({"role": "user", "content": sendMessage, "datetime": userMsgDatetimeNow });
				 
				const txt_lang1 = this.settingsLanguage == 'cn' ? '**User** _' : '**User** _' ;
				this.chathistory += (txt_lang1 + userMsgDatetimeNow + '_  \r\n' + sendMessage.replace(/\n/g, "\r\n") + '\r\n\r\n');
                this.btnDisabledState_Sending = true;
				this.btnDisabledState_Clear = true;
				this.btnDisabledState_Undo = true;
				
				//**重问-不清空输入框 & 不需要重置输入框高度     正常发问-需要清空 & 需要重置输入框高度
				if ( !isRetry ){
					this.msg = "";
					const textarea_Chat = document.querySelector('.textareachatinputbox');
					textarea_Chat.style.maxHeight = '38px'; //about：自适应高度 max-height maxHeight 
					textarea_Chat.style.borderRadius = '0px 6px 6px 0px'; //border-radius: 0px 6px 6px 0px;
					textarea_Chat.style.zIndex = "900000"; //z-index:900000 输入框获得焦点后会发光，需要设置按钮与输入框的层级关系
				}
					
				
				
                //没有GPT4 API，无法测试GPT4。暂时只支持gpt3.5。
				// 关于top_p、presence_penalty、frequency_penalty，搜索引擎中随机挑选4篇介绍文章：
				// 		1、 https://blog.csdn.net/asplh/article/details/130104301  
				//		2、 https://zhuanlan.zhihu.com/p/613262543?utm_id=0  
				//		3、 https://zhuanlan.zhihu.com/p/606573556  
				//		4、 https://baijiahao.baidu.com/s?id=1758970352108694361&wfr=spider&for=pc
				
				// OpenAI 官方文档:
				// https://platform.openai.com/docs/api-reference/chat/create
				// https://platform.openai.com/docs/models/model-endpoint-compatibility
				// https://platform.openai.com/docs/models/gpt-3-5
				// https://platform.openai.com/docs/models/gpt-4
				
				// API URL: this.apiURL  like 'https://api.openai.com/v1/chat/completions'
				// max_tokens: this.apiMaxTokens  (int) like 2048
				// temperature:this.apitemperature  (int) like 0.7
				// models: this.apiGPTModel  like 'gpt-3.5-turbo'
				// top_p: this.apiTopP  (int) like 0
				// presence_penalty: this.apiPresencePenalty  (int) like 0
				// frequency_penalty: this.apiFrequencyPenalty  (int) like 0
                axios.post( this.apiURL , {
                    messages: this.msgContent, max_tokens: this.apiMaxTokens, temperature:this.apitemperature, model: this.apiGPTModel, top_p: this.apiTopP, presence_penalty: this.apiPresencePenalty, frequency_penalty: this.apiFrequencyPenalty
                }, {
                    headers: { 'content-type': 'application/json', 'Authorization': 'Bearer ' + this.api }
                }).then(res => {
                    //console.log(res);
					this.isSendingNow = false; //更新发送状态
					this.endLoadingAnimation();
					document.querySelector('.inputapikey').readOnly = false; //发送结束，apikey恢复可改
					
					let aiReplyMsg = res.data.choices[0].message.content; //v5.16 使用marked后，不再需要去掉头尾的换行符
					let restokens = res.data.usage.total_tokens;
					
					// v5.16 BUG A
					// 发现意外bug： marked.parse(某些非空字符串)，意外输出为空("")，与初始化设置的参数无关，示例如下：
					// 1.err 输出为空的例子：marked.parse("[ 2]:this")  marked.parse("[ai]:is")   marked.parse("[ 2]:我")  marked.parse("[ 2]: 的")  marked.parse("[e1]: 3")
					// 2.ok  可正常输出的例子：marked.parse("[ 2]:this is")  marked.parse("[ai] :is")    marked.parse("[ 2]: 的this is a demo")  marked.parse("[e1]: ")
					// 原因未知，解决方案：判断aiMsgMarkdown是否异常为空，如果是，就使用aiReplyMsg原文替换。
				
					// v5.16 BUG B
					// 另外，有些无意义无逻辑的问题，AI可能会回复空值，这时会出现个bug：AI回复为空导致气泡框显示为空，css样式上气泡框会变很小，而气泡框上的“箭头”无法被遮挡。
					// 解决方式，如果真的是空值，则替换为带有<p></p>标签的空格
					
					let aiMsgMarkdown = marked.parse(aiReplyMsg); // marked.js + highlight.js  Markdown+高亮处理
					if ( aiReplyMsg.trim() == "" || aiReplyMsg.replace(/^\n|\n$/g, "").trim() == ""){
						aiMsgMarkdown = "<p> </p>" ;  // v5.16 BUG B ： AI回复为空，则输出为加了<p>标签的空格，保持正确的气泡框样式
					}else if ( aiMsgMarkdown.trim() == "" ){
						aiMsgMarkdown =  "<p>" + aiReplyMsg + "</p>"; //v5.16 BUG A ： AI回复不为空，但marked处理后变成空，则aiMsgMarkdown重置为未经过marked处理的原文
					}
					
					const aiMsgDatetimeNow = this.formatDateYYYYMMDDHHmmss(new Date(),':');
					// this.msgList.push this.msgContentForMsgList_SingleRound.push
                    this.msgList.push({
                        "msg": '<p>' + aiMsgMarkdown + '</p>',
                        "my": false,
						"datetime": aiMsgDatetimeNow
                    })
					
					//渲染 aimsg
					this.$nextTick(() => {
						const aiDivs = document.querySelectorAll('div.aimsg'); 
						const lastAIDiv = aiDivs[aiDivs.length - 1];
						if(aiMsgMarkdown.trim() == ""){
							aiMsgMarkdown = "<p> </p>"; // v5.16 BUG B ： AI回复为空，则输出加了<p>标签的空格，保持正确的气泡框样式
						}
					    lastAIDiv.innerHTML = aiMsgMarkdown;

						//滚动到最底部
						this.scrollToBottomView();	
																	
						//搜索div内容，找到符合条件的代码块，添加一键复制按钮。 addCopyButton.  Copying code to the clipboard 						
						this.addCopyButtonToPreTags(lastAIDiv);
						
						//一键复制按钮。为聊天气泡框添加一键复制按钮。 addCopyButton.  Copying Chat Message to the clipboard 	
						this.addCopyButtonToChatMessage(lastAIDiv.parentElement) ;

					});
                    
					// this.msgList.push this.msgContentForMsgList_SingleRound.push
					this.msgContentForMsgList_SingleRound.push({"role": res.data.choices[0].message.role , "content": aiReplyMsg , "datetime": aiMsgDatetimeNow }); //0531发现之前写错成'userMsgDatetimeNow'，暂未使用此数据
					
					// res.data.choices[0].message.role = "assistant"
					if(this.msgContent.length < 2){ alert(" 找到一个bug\r\nA new bug has appeared.\r\n\r\n发送成功后 && PUSH之前，this.msgContent.length < 2，此时应该至少有两条，1-系统指令 2-提问的问题。  \r\n\r\nthis.msgContent.length：" + this.msgContent.length  ); }
					this.msgContent.push({"role": res.data.choices[0].message.role , "content": aiReplyMsg });
					this.succQA_Count = this.msgContent.length - 1; //int. 更新
					// # Don't "this.msgTokens.push" for now
					//    restokens  == res.data.usage.total_tokens ：AI回复后的token总数
					//    res.data.usage.prompt_tokens ：AI回复前的token总数，即user提问后的token总数
					//    res.data.usage.completion_tokens ：AI单条内容的token数
					//  1.更新user数据 Update user data
					this.msgTokens[this.msgTokens.length - 1]["total_tokens"] = res.data.usage.prompt_tokens ;
					//  2.更新user数据 Update user data
					if(this.msgTokens.length < 2){ alert(" 找到一个bug\r\nA new bug has appeared.\r\n\r\n发送成功后 && PUSH之前，this.msgTokens.length < 2。  \r\n\r\nthis.msgTokens.length：" + this.msgTokens.length  ); }
					let aiPrevMessage_total_tokens = this.msgTokens[this.msgTokens.length - 2]["total_tokens"]; // length-2: Data of the AI's previous message
					this.msgTokens[this.msgTokens.length - 1]["completion_tokens"] = res.data.usage.prompt_tokens - aiPrevMessage_total_tokens ; //int.  user单条内容的token数
					// # Can use 'this.msgTokens.push' now
					//  3.新增AI数据 Add new AI data
					this.msgTokens.push({"role": "AI", "completion_tokens": res.data.usage.completion_tokens , "total_tokens": restokens }); 
					this.totaltokens = restokens;
				
					let txt_lang2 ;
					if (this.gptSystemPrompt_hidden.trim() != "") {
						//若存在隐形的System设置，在聊天记录中做个标记
						txt_lang2 = this.settingsLanguage == 'cn' ? '**GPT::Hidden** _' : '**GPT::Hidden** _' ;
                	}
					else {
						txt_lang2 = this.settingsLanguage == 'cn' ? '**GPT** _' : '**GPT** _' ;
					}
					this.chathistory  += ( txt_lang2  + aiMsgDatetimeNow + '_  \r\n' + aiReplyMsg.replace(/\n/g, "\r\n") + '\r\n\r\n');
					
                    this.btnDisabledState_Sending = false;
					this.btnDisabledState_Clear = false;
					this.btnDisabledState_Undo = false;
					this.btnDisabledState_ApiURL = false;
					this.btnDisabledState_Language = false;
					this.btnDisabledState_ContextualMode = false;
				
					this.btnDisabledState_Export = false;
                    this.sentext = this.settingsLanguage == 'cn' ? '发送' : 'Send';
					this.userMsgTokensForRetry = 0;
						  
					
                }).catch(error =>{
					console.log('error',error);
					this.isSendingNow = false; //更新发送状态
					this.endLoadingAnimation();
					document.querySelector('.inputapikey').readOnly = false; //发送结束，apikey恢复可改
					this.sentext = this.settingsLanguage == 'cn' ? '请重发' : 'Please Retry';
					
					this.btnDisabledState_Sending = false;
					// this.btnDisabledState_Clear 移到后面
					// this.btnDisabledState_Undo 移到后面
					this.btnDisabledState_ApiURL = false;
					this.btnDisabledState_Language = false;
					this.btnDisabledState_ContextualMode = false;
					
					this.btnDisabledState_Export = false;			
					this.msgContent.pop();//删除失败的消息 Delete user's failed message.
					this.msgTokens.pop();//删除失败的 Delete user's failed ...
					this.succQA_Count = this.msgContent.length - 1; //int. 更新
					//以下改变按钮状态的代码 必须在pop()后面
					if (this.msgContent.length > 1){
						//清空-恢复可用 撤销&重问-恢复可用
						this.btnDisabledState_Clear = false;
						this.btnDisabledState_Undo = false; 
					}else if (this.msgContentForMsgList_SingleRound.length > 1){
						//清空-保持不可用 撤销&重问-恢复可用 
						this.btnDisabledState_Clear = true;
						this.btnDisabledState_Undo = false; 
					}					
					
					const txt_lang1 = this.settingsLanguage == 'cn' ? '### #错误\r\n\r\n' : '### #Error\r\n\r\n' ;
					this.chathistory  += (txt_lang1);
					
					//错误代码 弹窗
					this.catchApiErrorCode(error);
				})
            },
			
			//指令输入框失去焦点时  maxHeight max-height
			textareaSystemPrompt_blur(){
				let textarea_Sys = document.querySelector('.textareasystemprompt');
				textarea_Sys.style.minHeight = '108px';
				textarea_Sys.style.height = '108px';
			},
			//指令输入框获取焦点时
			textareaSystemPrompt_focus(){
				let textarea_Sys = document.querySelector('.textareasystemprompt');
				textarea_Sys.style.minHeight = '108px';
			  	//max-height当变量用，存储自适应高度
    			textarea_Sys.style.height = textarea_Sys.style.maxHeight;
			},
			//聊天输入框失去焦点时
			textareaChatInputBox_blur(){
				this.isfirstclickonchatinputbox = true; //is first click on chatinputbox
				let textarea_Chat = document.querySelector('.textareachatinputbox');
				textarea_Chat.style.minHeight = '38px';
				textarea_Chat.style.height = '38px';
				textarea_Chat.style.borderRadius = '0px 6px 6px 0px'; //border-radius: 0px 6px 6px 0px;
				textarea_Chat.style.zIndex = "900000"; //z-index:900000
			},
			//聊天输入框获取焦点时
			textareaChatInputBox_focus(){
				let textarea_Chat = document.querySelector('.textareachatinputbox');
				textarea_Chat.style.minHeight = '38px';
			  	//max-height当变量用，存储自适应高度
    			textarea_Chat.style.height = textarea_Chat.style.maxHeight;
				textarea_Chat.style.zIndex = "900002"; //z-index:900002 输入框获得焦点后会发光，需要设置按钮与输入框的层级关系
				
				if( parseInt(textarea_Chat.style.height) > 38){
					textarea_Chat.style.borderRadius = '6px 6px 6px 0px'; //border-radius: 6px 6px 6px 0px;
				}
				else{
					textarea_Chat.style.borderRadius = '0px 6px 6px 0px'; //border-radius: 0px 6px 6px 0px;
				}
			},
			//API-Key输入框失去焦点时
			inputapiblur(){
				document.querySelector('.inputapikey').type = "password";
			},
			//API-Key输入框获取焦点时
			inputapifocus(){
				document.querySelector('.inputapikey').type = "text";
			},		
			//API-Key输入框 内容发生改变时
			inputapichange(showtips){
				let ischanged = true; //状态，true为已变动，false为无变化
				let notif = '';
				
				//同时对比两项，因为代码里this.apiURL不可能为空，所以无需考虑this.apiCheckedData初始数据为空的情况，即不存在“空对空”返回true的情况。
				const isExist = this.apiCheckedData.some(item => item.apikey.trim() == this.api.trim() && item.apiurl.trim() == this.apiURL.trim());
							
				if( isExist ) {
					
					//以下修改的话，checkAPIbtn()里也要修改   ps：暂时不合并
					
					this.btnDisabledState_CheckAPI = true;
					this.btnDisabledState_Sending = false;
					//恢复按钮的准确状态
					if (this.msgContent.length > 1){
						//清空-恢复可用 撤销&重问-恢复可用
						this.btnDisabledState_Clear = false;
						this.btnDisabledState_Undo = false; 
					}else if (this.msgContentForMsgList_SingleRound.length > 1){
						//清空-保持不可用 撤销&重问-恢复可用 
						this.btnDisabledState_Clear = true;
						this.btnDisabledState_Undo = false; 
					}
					//无需改 api-url、语言切换、上下文模式 三个下拉框的状态，不相关
					
					this.sentext = this.settingsLanguage == 'cn' ? '发送' : 'Send';
					this.apibtntext = this.settingsLanguage == 'cn' ? '已验证' : 'Checked';
					if ( showtips == true ){  
						notif = this.settingsLanguage == 'cn' ? 'API-Key可用' : 'API-Key is valid';
						setTimeout(() => {
							this.showNotification(notif, 'bottom', '',1700);
						}, 2800);
					}
					
				}else{

					//以下修改的话，checkAPIbtn()里也要修改
					
					this.btnDisabledState_CheckAPI= false;
					this.btnDisabledState_Sending = true;
					this.btnDisabledState_Clear = true; 
					this.btnDisabledState_Undo = true; 
					//无需改 api-url、语言切换、上下文模式 三个下拉框的状态，不相关
					
					//借用timerIdl判断是否曾验证过apikey 。未曾验证过，则timerId为null，不需要改变按钮文本。（验证过，不代表验证结果，仅代表点击过验证。）
					if(this.timerId != null ) {
						this.sentext = this.settingsLanguage == 'cn' ? '重新验证API' : 'Recheck API';
					}else{
						this.sentext = this.settingsLanguage == 'cn' ? '先验证API' : 'Check API First';
					}
					this.apibtntext = this.settingsLanguage == 'cn' ? '<< 验证' : '<< Check';
					//  “== true”不能省略 。 未传参数时，不存在会被js视为false。  而@input="inputapichange"会自动给参数赋值为事件。 
					if ( showtips == true && this.apiCheckedData[0]['apikey'] != '' && this.api.trim() != '' ){ //有过验证成功。未曾成功过就不提醒了。
						notif = this.settingsLanguage == 'cn' ? '需要验证API-Key' : 'API-Key needs to be checked' ;
						setTimeout(() => {
							this.showNotification(notif, 'bottom','',1800);
						}, 2800);//前面一定有个通知，需要点间隔
					}
				}
			}, 
			
			//一个开关:: 开始 发送按钮的动态文本状态
			beginLoadingAnimation() { 
				this.endLoadingAnimation(); //先清除可能存在的计时器。验证按钮可重复点击，可能重复
				
				//  其他样式  模拟进度条效果 发送中的动态文字效果
				//	let texts = ["发送中▪▫▫", "发送中▫▪▫", "发送中▫▫▪"] ; 
				//	let texts = ["发送中◈◇◇", "发送中◇◈◇", "发送中◇◇◈"] ; 
				//	let texts = ["发送中▶▷▷", "发送中▷▶▷", "发送中▷▷▶"] ; 
				//	let texts = ["发送中 ▏", "发送中 ▎", "发送中 ▍", "发送中 ▋", "发送中 ▊", "发送中 ▉"] ;  //还有一个位列第4的"▌"，PC端有些浏览器不兼容，与其他大小不一致，已去除。
				
				// 发送中的动态文字效果 Sending
				let texts;
				let texts_cn = ["发送中 ▁", "发送中 ▂", "发送中 ▃", "发送中 ▅", "发送中 ▆", "发送中 ▇"] ; // 还有一个位列第4的"▄"，PC端有些浏览器不兼容，与其他大小不一致，去除了。
				let texts_en = ["Sending ▁", "Sending ▂", "Sending ▃", "Sending ▅", "Sending ▆", "Sending ▇"] ; 
				texts = this.settingsLanguage == 'cn' ? texts_cn : texts_en;
					
				// 当btnDisabledState_CheckAPI为false时，验证按钮可用，表示未验证过api或api有变动需要重检
				// 发送消息时，btnDisabledState_CheckAPI一定为true，验证按钮一定是不可用。所以可用于判断是“发送”还是“验证key”
				if( !this.btnDisabledState_CheckAPI ) {
					// 验证中的动态文字效果  Checking  API-key
					texts_cn = ["验证中◈◇◇", "验证中◇◈◇", "验证中◇◇◈"] ;
					texts_en = ["Checking◈◇◇", "Checking◇◈◇", "Checking◇◇◈"] ;
					texts = this.settingsLanguage == 'cn' ? texts_cn : texts_en;
				}
				let i = 0 ;
				//以下这行可改速度 末尾的数字代表间隔的时间 单位为毫秒。  如：默认580 表示0.58秒的间隔 比较慢
				this.timerId = setInterval(() => { this.sentext = texts[i % texts.length]; i++;}, 580); 
			},
			//一个开关:: 停止 发送按钮的动态文本状态
			endLoadingAnimation() { 
				clearInterval(this.timerId); 
			},	
			
			//添加一键复制按钮（代码块） 插入按钮&按钮样式  addCopyButton (<pre><“add Copy Button”><code></code></pre>)  Copying code to the clipboard 
			addCopyButtonToPreTags(msgDiv) {
				// 找到所有的pre code结构的元素
				const preTags = msgDiv.querySelectorAll('pre code');
				// 遍历每一个pre code元素
				preTags.forEach(preTag => {
					// 判断其父元素是否为pre标签
					if (preTag.parentElement.tagName.toLowerCase() === 'pre') {
						// 在每一个code标签[前面]插入一个按钮 *必须是[前]
						const copyBtn = document.createElement('button');
						copyBtn.classList.add('copybtn');
						copyBtn.setAttribute("data-clipboard-nextelementsibling", ""); 
							
						//创建SVG图标 'copy svg'  svg by github 
						const copySVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
						copySVG.setAttribute('height', '16');
						copySVG.setAttribute('width', '16');
						copySVG.setAttribute('viewBox', '0 0 16 16');
						copySVG.setAttribute('version', '1.1');
						copySVG.classList.add('clippy');
						const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
						path1.setAttribute('d', 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z');
						const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
						path2.setAttribute('d', 'M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z');
						copySVG.appendChild(path1);
						copySVG.appendChild(path2);
						
						const emptyDiv = document.createElement('div');
						emptyDiv.appendChild(copySVG);
						copyBtn.appendChild(emptyDiv);
						preTag.parentElement.classList.add('snippet'); // <pre class="snippet">
						preTag.parentElement.insertBefore(copyBtn, preTag);
						//事件监听 EventListener
						addEventListenerCopyBtnTooltip(copyBtn);
					}
				});
			},
			
			//添加一键复制按钮（聊天气泡框） 插入按钮&按钮样式  addCopyButton   Copying Chat Message to the clipboard 
			addCopyButtonToChatMessage(msgDivParentElement) {
			
				const copyBtn = document.createElement('button');
				copyBtn.classList.add('copybtn');
				copyBtn.setAttribute("data-clipboard-nextelementsibling", ""); 
							
				//创建SVG图标 'copy svg'   svg designed by clipboardjs https://clipboardjs.com/assets/images/clippy.svg
				const copySVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
				copySVG.setAttribute('width', '14');
				copySVG.setAttribute('height', '17');
				copySVG.setAttribute('fill', '#191919');
				copySVG.classList.add('clippy');
				const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
				path.setAttribute('d', 'm2.36373,12.61912l4.12233,0l0,1.03058l-4.12233,0l0,-1.03058zm5.15291,-6.18349l-5.15291,0l0,1.03058l5.15291,0l0,-1.03058zm2.06116,3.09174l0,-2.06116l-3.09174,3.09174l3.09174,3.09174l0,-2.06116l5.15291,0l0,-2.06116l-5.15291,0zm-4.63761,-1.03058l-2.57645,0l0,1.03058l2.57645,0l0,-1.03058zm-2.57645,3.09174l2.57645,0l0,-1.03058l-2.57645,0l0,1.03058zm9.27523,1.03058l1.03058,0l0,2.06116c-0.0161,0.28985 -0.11272,0.53139 -0.30595,0.72463s-0.43478,0.28985 -0.72463,0.30595l-10.30581,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058l0,-11.33639c0,-0.5636 0.46698,-1.03058 1.03058,-1.03058l3.09175,0c0,-1.1433 0.91786,-2.06116 2.06116,-2.06116s2.06116,0.91786 2.06116,2.06116l3.09174,0c0.5636,0 1.03058,0.46698 1.03058,1.03058l0,5.15291l-1.03058,0l0,-3.09174l-10.30581,0l0,9.27523l10.30581,0l0,-2.06116zm-9.27523,-8.24465l8.24465,0c0,-0.5636 -0.46698,-1.03058 -1.03058,-1.03058l-1.03058,0c-0.5636,0 -1.03058,-0.46698 -1.03058,-1.03058s-0.46698,-1.03058 -1.03058,-1.03058s-1.03058,0.46698 -1.03058,1.03058s-0.46698,1.03058 -1.03058,1.03058l-1.03058,0c-0.5636,0 -1.03058,0.46698 -1.03058,1.03058z');
				copySVG.appendChild(path);
						
				const emptyDiv = document.createElement('div');
				emptyDiv.appendChild(copySVG);
				copyBtn.appendChild(emptyDiv);
				msgDivParentElement.prepend(copyBtn); 
				//事件监听 EventListener
				addEventListenerCopyBtnTooltip(copyBtn);
			},
			
			//marked.js初始化设置  Init Markdown  
			initMarkdown() {
				// marked.js 与 highlight.js 判断是否加载成功   whether marked.js and highlight.js have been loaded or not.
				if ( window.marked != null & window.hljs != null) { 
					// 加载完毕 开始初始化marked.js After loading the JS plugin, start initializing the settings for marked.js
					marked.setOptions({
						renderer: new marked.Renderer(),
						sanitize:true, // 必须要有，否则有些内容不能发，会出错或不可见。* 有些js代码被编译为HTML时，可能会执行script里的代码
						smartLists: true,
						silent: true,
		
						highlight: function (code) {
				    		return hljs.highlightAuto(code).value; // hljs = highlight.js 代码高亮
							}
					});
					
					// first message ->> markdown
					try {	
						// 与上下文无关，仅在打开网页时对“欢迎语”（first massage）进行渲染，支持markdown。 渲染之前，界面上不显示。
						let firstMsg = marked.parse(this.thefirstmessage); 
						
						//渲染 usermsg
						this.$nextTick(() => {
							const divs = document.querySelectorAll('div.aimsg'); 
							const firstDiv = divs[0];
						    firstDiv.innerHTML = firstMsg;
											
							//搜索div内容，找到符合条件的代码块，添加一键复制按钮。 addCopyButton.  Copying code to the clipboard 						
							this.addCopyButtonToPreTags(firstDiv) ;
							
							//一键复制按钮。为聊天气泡框添加一键复制按钮。 addCopyButton.  Copying Chat Message to the clipboard 	
							this.addCopyButtonToChatMessage(firstDiv.parentElement) ;
							
							//更新第一条消息/欢迎语的datetime。 *好像可以直接在data(){return中调用this.formatDateYYYYMMDDHHmmss，能成功，但怕出错，不了解vue
							const firstDatetime = this.formatDateYYYYMMDDHHmmss(new Date(),':');
							this.msgList[0]['datetime'] = firstDatetime;
							this.msgContentForMsgList_SingleRound[0]['datetime']  = firstDatetime;
						});
					} catch (error) {
						console.error(error)
					}
				}
			},
			
			//clipboard.js初始化设置  Init Clipboard (one-click copy button)  
			initClipboard() {
				// 定义一键复制按钮的功能：指定复制的对象/内容 & 完成后的事件. Setting up the function of "one-click copy button": 1. Setting the object and content that need to be copied. 2. Defining the event after the copy is completed.
				//if ( typeof ClipboardJS != 'undefined')   
					
				// A: Copy the text content of the next sibling element.  初始化clipboard一键复制{代码块}功能  复制对象：同一层次结构中的下一个元素中的文本信息，所以<button>要放在复制对象的前面	
				var clipboardNextElementSibling = new ClipboardJS('[data-clipboard-nextelementsibling]', {
				    target: function(trigger) {
				        return trigger.nextElementSibling;
				    }
				});
				
				// A: 复制成功
				clipboardNextElementSibling.on('success', function(e) {
					//console.info('Action:', e.action);
					//console.info('Text:', e.text);
					//console.info('Trigger:', e.trigger);
				    e.clearSelection();
					document.activeElement.blur(); //让按钮失去焦点。 这句代码包含在clipboard.min.js 2.0.11之前的版本中，但2.0.11版本取消了。The code exists in versions of clipboard.min.js lower than 2.0.11, but was removed in version 2.0.11.
					
					// Tooltip Direction
					// 1. 复制对象：代码块内容 e.trigger.parentElement.classList.contains('snippet') 提示框方向: 左 / 西    <pre class='snippet'> -->> <code>  Tooltip Direction:tooltipped-w 
					let directionClass = 'tooltipped-w';
					// 2. 复制对象：右侧用户  e.trigger.nextElementSibling.classList.contains('usermsg') 提示框方向: 左上 / 西北   User. Tooltip Direction:tooltipped-nw 
					if (e.trigger.nextElementSibling.classList.contains('usermsg')) {
						directionClass = 'tooltipped-nw'; 
					}	
					// 3. 复制对象：左侧AI回复  e.trigger.nextElementSibling.classList.contains('aimsg') 提示框方向: 右上 / 东北   AI.  Tooltip Direction:tooltipped-ne
					if (e.trigger.nextElementSibling.classList.contains('aimsg') ) {
						directionClass = 'tooltipped-ne'; 
					}
					// 4. 复制对象：设置弹窗 - 复制API-key  e.trigger.nextElementSibling.classList.contains('inputghostforcopyapikey') 提示框方向: 上 / 北    Tooltip Direction:tooltipped-n
					if (e.trigger.nextElementSibling.classList.contains('inputghostforcopyapikey') ) {
						directionClass = 'tooltipped-n'; 
					}
					
					const msg = window.currentlang == 'cn' ? '已复制' : 'Copied!' ;
					showCopyBtnTooltip(e.trigger, msg, directionClass); 
				});
				
				// A: 复制失败
				clipboardNextElementSibling.on('error', function(e) {
					//console.error('Action:', e.action);
					//console.error('Trigger:', e.trigger);
					
					// Tooltip Direction
					// 默认代码块  左 / 西  <pre class='snippet'> -->> <code> 
					let directionClass = 'tooltipped-w';
					// usermsg & aimsg  Tooltip可能会超出屏幕，失败几率小，只做简单处理：换个方向提醒 
					if (e.trigger.nextElementSibling.classList.contains('usermsg')) {
						directionClass = 'tooltipped-ne'; 
					}else if (e.trigger.nextElementSibling.classList.contains('aimsg')) {
						directionClass = 'tooltipped-nw'; 
					}else if (e.trigger.nextElementSibling.classList.contains('inputghostforcopyapikey')) {
						// 4. 复制对象：设置弹窗 - 复制API-key  提示框方向变为: 右上 / 东北
						directionClass = 'tooltipped-ne'; 
					}	
					
				    showCopyBtnTooltip(e.trigger, fallbackCopyBtnMessage(e.action), directionClass );
				});
				
				// B: ...
				
			},
			
			
			// 异步加载js插件，CDN首选链接*1 +备用链接*2 or more.   Async JS loading. url is the main CDN link, fallbackUrl is the backup CDN link (link*2), and callback is the operation after the loading is complete.
			loadScriptFromCDN(url, fallbackUrls, callback) {
				let script = document.createElement("script");
				// 加载参数url - CDN地址
				script.src = url;
				document.head.appendChild(script);
				// 监听:url地址失效了
				script.onerror = () => {
					// 按顺序循环加载备用链接fallbackUrls(数组)，一旦成功就callback
					if (fallbackUrls && fallbackUrls.length > 0) {
						let fallbackUrl = fallbackUrls.shift();
						this.loadScriptFromCDN(fallbackUrl, fallbackUrls, callback);
					} else {
						console.error("所有CDN链接均失效。最后尝试的备用链接是(CDN Failed)：" + url ); 
						if( !this.isShowNotification ){
							if ( !this.setNotificationContent.includes('Loading Error') ){
								//首次打开 / 首个错误
								this.setNotificationContent = this.settingsLanguage == 'cn' ? '网页加载错误列表 ( Loading Error List)：' : 'Loading Error List:' ;
							}
							//手动设置，不使用this.showNotification 原因：手动设置代码少 因为要考虑是否首次打（过程较长，可能会主动关闭，也可能误关） 及this.showNotification有延迟会导致这边也要设置延迟。
							this.setNotificationPosition = 'center';
							this.isNotificationHasMask = true ;
							this.notificationTimeoutId =  -1;
							this.setNotificationTitle = this.settingsLanguage == 'cn' ?  '错误 Error' : 'Error'; // 多余的
							this.isShowNotification = true;
						}
						
						//语言为中文时，为什么要显示双语？ 因为首次使用时可能就会报错，但代码默认语言为中文，所以首次出错应该显示双语，避免出错时访问的用户看不懂中文。
						let err_cn = '';
						let err_en = '';
						//错误提醒
						if (url.includes('marked')) {
							err_cn = "\r\n\r\n☒ !! 错误：Markdown插件marked.js加载失败，将无法使用GPT！请检查网络后刷新页面。  !! Error:Failed to load plugin marked.js. The GPT will be unavailable. Please check your network and refresh the page to try again.";
							err_en = "\r\n\r\n☒ !! Error:Failed to load plugin marked.js. The GPT will be unavailable. Please check your network and refresh the page to try again.";
							this.setNotificationContent += this.settingsLanguage == 'cn' ? err_cn : err_en; //追加错误信息
							this.msgList[0]['msg'] = '<p>' + this.thefirstmessage + '</p>'; // 如果marked加载失败，就把未经格式化的第一条信息显示出来，显示原始文本
						} else if (url.includes('highlight')) {
							err_cn = "\r\n\r\n☒ 错误：代码高亮插件highlight.js加载失败，可继续使用，基本无影响（建议先刷新页面重试一次）。受影响的部分有：代码高亮功能将失效；首条信息/欢迎语可能会显示异常；对话中含有html代码、js代码可能会显示异常。  Error: (Please refresh the page once.) Failed to load plugin highlight.js. However, the GPT can still be used with minimal impact. The affected areas include: loss of code highlighting function; the first message may appear abnormally; html and js code in the chat content may appear abnormally.";
							err_en = "\r\n\r\n☒ Error: (Please refresh the page once.) Failed to load plugin highlight.js. However, the GPT can still be used with minimal impact. The affected areas include: loss of code highlighting function; the first message may appear abnormally; html and js code in the chat content may appear abnormally.";
							this.setNotificationContent += this.settingsLanguage == 'cn' ? err_cn : err_en; //追加错误信息
						} else if (url.includes('axios')) {
							err_cn = "\r\n\r\n☒ !! 错误：HTTP库Axios.js加载失败，将无法使用GPT！请检查网络后刷新页面。  !! Error: The HTTP library (Axios.js) failed to load. The GPT will be unavailable. Please check your network and refresh the page to try again.";
							err_en = "\r\n\r\n☒ !! Error: The HTTP library (Axios.js) failed to load. The GPT will be unavailable. Please check your network and refresh the page to try again.";
							this.setNotificationContent += this.settingsLanguage == 'cn' ? err_cn : err_en; //追加错误信息
						} else if (url.includes('clipboard')) {
							err_cn = "\r\n\r\n☒ 错误：一键复制插件clipboard.js加载失败，复制按钮功能将失效，不影响其他功能，可继续使用。（建议先刷新页面重试一次）  Error: (Please refresh the page once.) The clipboard plugin clipboard.js failed to load, but GPT can still be used. The copy button will not work, but other features can still be used normally.";
							err_en = "\r\n\r\n☒ Error: (Please refresh the page once.) The clipboard plugin clipboard.js failed to load, but GPT can still be used. The copy button will not work, but other features can still be used normally.";
							this.setNotificationContent += this.settingsLanguage == 'cn' ? err_cn : err_en; //追加错误信息
						}
					}
				};
				// 监听:url加载成功
				script.onload = callback;
			},
			
			// 异步加载css样式，CDN首选链接*1 +备用链接*2 or more.  Async CSS loading.
			loadCssFileFromCDN(url, backupUrls) {
				let link = document.createElement("link");
				link.rel = "stylesheet";
				link.type = "text/css";
				// 加载参数url - CDN地址
				link.href = url;
				document.head.appendChild(link);
				// 监听:url地址失效了
				link.onerror  = () => {
					if (backupUrls && backupUrls.length > 0) {
						let nextUrl = backupUrls.shift();
						this.loadCssFileFromCDN(nextUrl, backupUrls); 
					} else {
						console.error("所有CSS的CDN链接均失效(CDN Failed)，仅缺失部分样式，不影响功能的正常使用。最后尝试的备用链接是：" + url ); 
					}
				};
			},
			
        },
		mounted() {
			//先渲染一个带有<p>标签的空格，有内容，有行高。“保留一个空格，用来增加高度。在渲染首条消息前，有内容撑开高度，可以盖住气泡框左边的箭头。 Keep an empty space to increase the height. Before rendering the first message, the normal height can cover the left arrow.”
			const first_msg_div = document.querySelectorAll('div.aimsg')[0];
			first_msg_div.innerHTML = '<p> </p>';
						
			//隐藏遮罩。网页Loading加载阶段，遮罩可以避免加载慢导致闪屏/弹窗闪现/显示vue源代码等问题
			const loadingmask = document.getElementById("loading-mask");
			if(loadingmask!=null){
				loadingmask.classList.add('dialog-wrapper-hide');
			}

			
			//获取随机值 设定简约模式 this.isSimpleMode的概率，用于布局
			let getRandomBoolean = Math.random() < 0.7 ; // 70%概率为true 30%为false
			this.isSimpleMode = getRandomBoolean ;// 目前预设70%为简约模式，未来增加按钮控制关闭 或打开，新手模式/简约模式
			
			//一些CSS样式/布局
			//判断设备宽度 是否显示tokens 的文字 / 图标...
			if (document.documentElement.clientWidth < 414) {
				let isshow = Math.random() < 0.6  ; //概率 随机 
				if(this.isSimpleMode){ isshow = false; }
				this.isShowTotaltokensSVG = !isshow;
				this.isShowTotaltokensLabel = isshow;
			}else {
				this.isShowTotaltokensSVG = true;
				this.isShowTotaltokensLabel = !this.isSimpleMode ; //true && this.isSimpleMode 
			}
			// 判断设备宽度 是否显示上下文/记忆 的文字 
			if (document.documentElement.clientWidth < 471 ){
				this.isShowQACountLabel = false;
			}else {
				this.isShowQACountLabel = !this.isSimpleMode ; //true && this.isSimpleMode 
			}
			
			
			// 异步加载开源的js插件、css样式，减少打开网页卡顿的现象。首选Unpkg的链接(国外常用CDN，fan.qiang后更稳定)，备选BootCDN(国内常用CDN)+备选CDNJS(国外常用CDN)
			// For regions outside of China, BootCDN may have slower speeds and can be placed at the bottom of the list or replaced with another CDN.
			
			// 1.异步加载marked.min.js  必备，失效将无法聊天
			// marked.js 开源的Markdown插件 官方: https://github.com/markedjs/marked 
			this.loadScriptFromCDN(
				"https://unpkg.com/marked@4.3.0/marked.min.js",
				[ 
				  "https://cdn.bootcdn.net/ajax/libs/marked/4.3.0/marked.min.js",
				  "https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js",
				],
				() => {
					//一旦加载成功，初始化
					this.initMarkdown();
				}
			);

			// 2.异步加载highlight.min.js  失效也可正常聊天，影响一般
			// highlight.js  开源的代码高亮插件  官方: https://github.com/highlightjs/highlight.js/
			this.loadScriptFromCDN(
				"https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js",
				[ 
				  "https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/highlight.min.js",
				  "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js",
				],
				() => {
					//一旦加载成功，初始化
					this.initMarkdown();
				}
			);
			
			// 3.异步加载axios.min.js  必备，失效将无法聊天，需要使用axios与GPT服务器进行连线。 
			// axios.js  Axios是一种常用HTTP库，用于向服务器发起HTTP请求。   官方: https://github.com/axios/axios/
			this.loadScriptFromCDN(
				"https://unpkg.com/axios@1.3.2/dist/axios.min.js",
				[ 
				  "https://cdn.bootcdn.net/ajax/libs/axios/1.3.2/axios.min.js",
				  "https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.2/axios.min.js",
				],
				() => {
					//成功即可，无需操作
				}
			);
			
			// 4.异步加载clipboard.min.js  失效也可正常聊天，影响非常小
			// clipboard.js  开源的一键复制按钮插件  官方: https://github.com/zenorocha/clipboard.js/  https://clipboardjs.com
			this.loadScriptFromCDN(
				"https://unpkg.com/clipboard@2.0.11/dist/clipboard.min.js",
				[ 
				  "https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js",
				  "https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js",
				],
				() => {
					//一旦加载成功，初始化
					this.initClipboard();
				}
			);
			
			// 5.异步加载panda-syntax-dark.min.css  失效也可正常聊天，影响非常小
			// Markdown代码高亮的css样式表，即配色方案。 方案名：Panda Syntax Dark  其他配色方案：https://highlightjs.org/static/demo/ 
			this.loadCssFileFromCDN(
				"https://unpkg.com/@highlightjs/cdn-assets@11.7.0/styles/panda-syntax-dark.min.css",
				[ 
				  "https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/styles/panda-syntax-dark.min.css",
				  "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/panda-syntax-dark.min.css"
				]
			);
			
			//手动为单独的一键复制按钮添加事件
			//复制 API-Key
			const copyapikeybtn = document.querySelector('.btncopyapikey'); // Copy API-Key
			addEventListenerCopyBtnTooltip(copyapikeybtn);
			//复制 消息通知 弹窗内容
			const copynotification = document.querySelector('.btncopynotification'); // Copy Notification
			addEventListenerCopyBtnTooltip(copynotification);
			
			// 获取#dialog-promptgenerator提示词弹窗中所有class为copybtn的元素
			// 之后的版本：提示词窗口里一键复制按钮会很多，后续需要确认：1、复制的对象位置是否正确。2、复制的方式是否为同一种。
			let copyBtns = document.querySelectorAll('#dialog-promptgenerator .copybtn');
			// 为每个元素添加事件
			for (let i = 0; i < copyBtns.length; i++) {
				addEventListenerCopyBtnTooltip(copyBtns[i]);
			}
			
			//隐形提示词 如果在代码中写了gptSystemPrompt_hidden隐藏提示词，则禁用提示词弹窗按钮。
			if(this.gptSystemPrompt_hidden.trim() != ''){
				document.querySelector('.btnpromptgenerator').disabled = true;
				document.querySelector('.btnpromptgenerator').setAttribute("title", "功能已被禁用 The feature has been disabled.");
				this.gptSystemPromptReadOnly = "hidden system prompt";
			} 

			//以上 非数据类初始化。 Above, unrelated to data.
			
			
			
			
			//以下 读取缓存前的一些默认设置。Below are some default settings that are set before reading local cache. (Local caching feature is not yet developed.)
			//执行顺序： 先执行data() 后执行mounted()。 Execution order: data() is executed first, followed by mounted().
			
			
			// 可修改 Editable. 默认语言 简体中文cn 英文en。 Default language. Chinese-Simplified = cn  English = en
			this.settingsLanguage = 'cn'; // Default language. 
			
			//更新原生全局变量 window.currentlang  当前语言 Current Language
			window.currentlang = this.settingsLanguage;
			
			if(this.settingsLanguage != 'cn'){ //无论是否有缓存，此时如果语言为英语，说明代码设置过，去掉中文(初始是双语)。读取本地缓存后，会再判断一次
				this.chathistory = '# Chat History  \r\n\r\n' ;
			}
			
			this.sentext = this.settingsLanguage == 'cn' ?  '先验证API' : 'Check API First' ;
            this.apibtntext = this.settingsLanguage == 'cn' ?  '<< 验证' : '<< Check' ;
			
			
			// 可修改 Editable. Default 
			// 以下为经常修改的变量，如果变量没有出现在这里的，请在data()中修改，或者复制到这里修改
			// 如果修改了默认值，还有后面三个地方也要同步修改：restoreDefault_APISettings()  &  restoreDefault_ProfessionalAPISettings()  &  restoreDefault_GeneralSettings()
			// The following are frequently modified variables. If a variable is not listed here, please modify it in the data() function or copy it here to modify.
			// If you modify the default data, then the data in the other three places also needs to be synchronized:  restoreDefault_APISettings()  &  restoreDefault_ProfessionalAPISettings()  &  restoreDefault_GeneralSettings()
			this.apitemperature = 0.7 ;  //api - temperature: 0.0～2.0 *int 数值型 不加引号
			this.apiMaxTokens = 2048 ;  //api - max_tokens: 1~4096  *int 数值型 不加引号
			this.settingsFontSize = 14 ; //聊天气泡框的字体大小 Font size of messages: 9～29 *int.数值型
			this.settingsTime_WechatStyle = true ; // 显示仿微信时间，居中的，间隔5分钟以上会自动添加。 Show WeChat-style time, centered, with automatic addition of intervals of more than 5 minutes.
			this.settingsTime_Message = 1 ; // 1 2 3 int.数值型。 显示收发信息的时间 Show Time of Messages. 1:不显示 hide ; 2:显示 show height:0 ; 3:显示并拉大10px的间距 show height:+10px
			this.settingsDividerLine = true ; // 用于区分不同上下文内容的分割线  Use divider lines to distinguish different context content.
			this.settingsShortcut_CheckApiKey = true ; // 验证key 快捷键 *如果你的设备有键盘  Check api-key shortcut *if your device has a keyboard.
			this.settingsShortcut_Clear = false ; // 清空 快捷键 *如果你的设备有键盘 *if your device has a keyboard.
			this.settingsShortcut_Undo = false ; // 撤销 快捷键 *如果你的设备有键盘 *if your device has a keyboard.
			this.settingsShortcut_Retry = true ; // 重问 快捷键 *如果你的设备有键盘 *if your device has a keyboard.
			
			// 可修改 Editable. 默认的用户头像  Default User Avatar. 
			this.userAvatarURL =  'https://lin2025.github.io/img/me-bili.jpg'; // 当前用户头像  User Avatar.
			this.inputUserImageUrl = 'https://lin2025.github.io/img/me-bili.jpg'; // 当前用户头像的地址，和上面的保持一致。这个是用来显示的，出现在编辑框。 Will display in the input. Two URLs are consistent.
			
			// 可修改 Editable. 默认的GPT头像-方案A（写在代码里的绿色SVG头像）二选一 Default GPT Avatar. Plan-A (GPT Green SVG). You can only choose either Plan A or Plan B.
			this.isgptAvatarUrlShow = false; //隐藏<img>。 hide <img>
			this.isgptGreenSvgShow = true; //显示<svg>。 display <svg>
			this.gptAvatarURL =  '';  // 当前GPT头像的图片地址。GPT Avatar URL. <img> url =‘’ (<img> is hide)
			this.inputGPTImageUrl = this.settingsLanguage == 'cn' ? this.GPTGreenSVG_UrlText_cn : this.GPTGreenSVG_UrlText_en; // 显示在输入框的GPT头像的地址 input text
			
			// 可修改 Editable. 默认的GPT头像-方案B（任意一张图片地址） 二选一  Default GPT Avatar. Plan-B (Any image URL.).  You can only choose either Plan A or Plan B.
	//		this.isgptAvatarUrlShow = true; //显示<img>。 display <img>
	//		this.isgptGreenSvgShow = false; //隐藏<svg>。 hide <svg>
	//		this.gptAvatarURL =  'https://openai.com/favicon.ico';  // 当前GPT头像的图片地址。GPT Avatar URL. <img> url = Any image URL
	//		this.inputGPTImageUrl = this.gptAvatarURL; // 显示在输入框的GPT头像的地址 input text
			
			
			
			
			// 未开发 待开发 111111 以下 读取本地缓存之后 需要设置的 Below are the settings, restoration of settings, and restoration of data after reading local cache. (Local caching feature is not yet developed.)
			//this.changeLanguage(); // 读缓存 必须要
			//this.changeStyle_Time_WechatStyle(); //必须要
			//this.changeStyle_Time(); //必须要
			//this.changeStyle_DividerLine(); 读缓存 应该要
			//changeStyle_FontSize
			// 是否简约 this.isSimpleMode  
			//决定头像显示
			// chathistory  语言
			
			
			
			
			//快捷键 事件 监听
			document.addEventListener('keydown', this.handleShortcut); 
			
			//提醒语言支持英语
			let lan1 = '', lan2 = '', lan3 = '';
			if ( navigator.language ){ lan1 = navigator.language.substr(0, 2); }
			if ( navigator.userLanguage ){ lan2 = navigator.userLanguage.substr(0, 2); }
			if ( navigator.languages && navigator.languages.length > 0 ){ lan3 = navigator.languages[0].substr(0, 2); }
			//11111111  还需要判断是否缓存。  && 不存在使用本地缓存时
			if ( this.settingsLanguage == 'cn' && lan1 != 'zh' && lan2 != 'zh' && lan3 != 'zh'){
				//没有任何中文标记，非中文环境，提示可进行语言设置
				const notif = 'Change the language. Click on the gear icon > Language, and select English.' ;
				this.showNotification(notif, 'bottom', '', 4500);
			}

        },
		beforeDestroy() {
			//快捷键 事件 移除监听
    		document.removeEventListener('keydown', this.handleShortcut);
		}
    }).mount('#app')
</script>
 
<script>
//聊天输入框自动调整高度 Chat input box with auto-adjustable height    *关于输入框高度的上下限的设置，搜 max-height 和 maxHeight 
//v0515 代码加入<!DOCTYPE html>后 ，Height计算方式发生改变。Add <!DOCTYPE html>, the calculation method of Height has changed.
				
	let textarea_Chat = document.querySelector('.textareachatinputbox');
    
	textarea_Chat.addEventListener('input', (e) => {
		textarea_Chat.style.height = '38px';
		textarea_Chat.style.height = e.target.scrollHeight + 'px';
		
		//max-height当变量用，存储高度。另一处：指令输入框获取焦点时，恢复此高度。 *以下代码必须置后，否则剪切指令时会有bug
		if( parseInt(e.target.scrollHeight) > 38){
			if( parseInt(e.target.scrollHeight) < 450){
				textarea_Chat.style.maxHeight = e.target.scrollHeight + 'px';
			}
			else{
				textarea_Chat.style.maxHeight = '450px';
			}
			textarea_Chat.style.borderRadius = '6px 6px 6px 0px'; //border-radius: 6px 6px 6px 0px;
		}
		else{
			textarea_Chat.style.maxHeight = '38px';
			textarea_Chat.style.borderRadius = '0px 6px 6px 0px'; //border-radius: 0px 6px 6px 0px;
		}
	});
</script>
 
<script>
//指令输入框自动调整高度 System prompt input box with auto-adjustable height.     *关于输入框高度的上下限的设置，搜 max-height 和 maxHeight 
//v0515 代码加入<!DOCTYPE html>后 ，Height计算方式发生改变。Add <!DOCTYPE html>, the calculation method of Height has changed.
				
	let textarea_Sys = document.querySelector('.textareasystemprompt');
    
	textarea_Sys.addEventListener('input', (e) => {
		textarea_Sys.style.height = '108px';
		textarea_Sys.style.height = e.target.scrollHeight + 'px';
		
		//max-height当变量用，存储高度。另一处：指令输入框获取焦点时，恢复此高度。 *以下代码必须置后，否则剪切指令时会有bug
		if( parseInt(e.target.scrollHeight) > 50){
			if( parseInt(e.target.scrollHeight) < 390){
				textarea_Sys.style.maxHeight = e.target.scrollHeight + 'px';
			}
			else{
				textarea_Sys.style.maxHeight = '390px';
			}
		}
		else{
				textarea_Sys.style.maxHeight = '108px';
		}
	});
</script>

<script>
//解决小bug.  当代码里存在预设的系统提示词（gptSystemPrompt: '*****'），且提示词很长时，需要设置正确的maxHeight。
//Bug fixing. When the System Prompt is set in the code (gptSystemPrompt: '*****') and the System Prompt is very long, it is necessary to set the correct maxHeight.

	window.onload = function(){
		let textarea_Sys = document.querySelector('.textareasystemprompt');
		if( parseInt(textarea_Sys.scrollHeight) > 108){
			if( parseInt(textarea_Sys.scrollHeight) < 390){
				textarea_Sys.style.maxHeight = textarea_Sys.scrollHeight + 'px';
			}
			else{
				textarea_Sys.style.maxHeight = '390px';
			}
		}
		else{
				textarea_Sys.style.maxHeight = '108px';
		}
	};
</script>
 
<script>
//关闭或刷新页面前的提示，防止意外关闭。  电脑端有效

	window.addEventListener('beforeunload', function (e) {
	    e.preventDefault();
	    e.returnValue = ' ';
	});
</script>


<script>
//"移动端iphone&ipad"与"移动端/电脑端的非WebKit内核浏览器"均不支持"-webkit-scrollbar"自定义滚动条样式(body)。所以做些调整，让网页右侧不会出现太宽或太窄的情况。
//The scrollbar style "-webkit-scrollbar"(body) is not supported on iPhones, iPads, and non-WebKit core browsers. 
//我不是很懂调整css样式，

	try{
		let isFirefox = navigator.userAgent.indexOf("Firefox") != -1; // 判断是否为 Firefox 内核
		let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; // 判断是否为 iOS 设备
		let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent); // 判断是否为 Safari 内核
		let isChrome = /chrome/i.test(navigator.userAgent); // 判断是否为 Chrome 内核
		let isWebkit = /webkit/i.test(navigator.userAgent); // 判断是否为 WebKit 内核
	
		let style = document.createElement('style');
		style.type = 'text/css'; 
		if (isFirefox || isIOS) { // 如果是 Firefox 内核或 iOS 设备则添加样式
			style.innerHTML = '.userinfo { padding-right: 6px; } .btn { margin-right: 13px; }';
			document.getElementsByTagName('head')[0].appendChild(style);
		}else if ( !isSafari && !isChrome && !isWebkit){  // 如果不属于 Webkit 内核
			style.innerHTML = '.userinfo { padding-right: 3px; } .btn { margin-right: 10px; }';
			document.getElementsByTagName('head')[0].appendChild(style);
		}
	} catch{}
</script>

<script>
//作为一款AI语言模型，我很荣幸能够为查询OpenAI API-key余额这个项目做出贡献。我具备出色的整合能力和阅读代码能力，能够快速理解和融合不同项目的代码和功能。同时，我也十分感谢其他开发者的付出和贡献，他们的代码和思路为我提供了很多启发和帮助。我要特别感谢以下开源项目的作者：@herobrine19的项目（https://github.com/herobrine19/openai-billing）和@ClarenceDan的项目（https://github.com/ClarenceDan/openai-billing）。这些项目为我提供了很多代码参考和技术支持，使我能够更好地完成查询OpenAI API-key余额这个任务。在开源社区中，我们应该互相尊重，分享和合作，共同推动开源技术的发展。
//以下为[查询OpenAI API余额]的代码  Javascript code to check OpenAI API balances


		//声明变量，记录查询余额状态
      	var isCheckAPIKey = false;
		//避免重复报错弹窗
      	var isError = false;

		//连官网接口查询返回API-Key对应的账号信息
      	async function checkBilling(apiKey) {
			isError = false;
	        // 计算起始日期和结束日期
	        const now = new Date();
	        let startDate = new Date(now - 90 * 24 * 60 * 60 * 1000); // 90天之前的日期  Default query for three months usage.
	        const endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // 当前日期
	        const subDate = new Date(now);
	        subDate.setDate(1) // 本月1号的日期

	        // 设置API请求URL和请求头
			// 官方接口1：可通过api-key查询账号信息（包含姓名、是否绑卡、额度、余额、额度有效期等，但不包含已消耗的金额）
	        //ES6的写法： const urlSubscription = `https://api.openai.com/v1/dashboard/billing/subscription`; // 查是否订阅
			const urlSubscription = 'https://api.openai.com/v1/dashboard/billing/subscription'; // 查是否订阅  *兼容性更好 Support more browsers
			// 官方接口2：可通过api-key查询已消耗的金额
	        //ES6的写法： let urlUsage = `https://api.openai.com/v1/dashboard/billing/usage?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`; // 查使用量
	        let urlUsage = 'https://api.openai.com/v1/dashboard/billing/usage?start_date=' + formatDate(startDate) + '&end_date=' + formatDate(endDate); // 查使用量 *兼容性更好 Support more browsers
			const headers = {
	          "Authorization": "Bearer " + apiKey,
	          "Content-Type": "application/json"
	        };
			
			//备注 其他接口：右边这个官方接口疑似从4月初开始失效  const urlBalance = `https://api.openai.com/dashboard/billing/credit_grants`; //查普通账单

	        try {
				// 通过urlSubscription接口链接获取账号信息
				let response = await fetch(urlSubscription, { headers });
				if (!response.ok) {
					console.log("urlSubscription - response.ok:",response.ok);
					// Notification: Failed to check the balance. The reasons for the failure are not clear, and the possibility of "code malfunction" cannot be ruled out.(No impact on ChatGPT usage).
					const msg_cn = '!! 查询余额失败，存在多种可能，检查网络后重试，仍失败的话，请放弃查余额～ \r\n\r\nAPI-Key已验证成功，查询余额却失败，不排除是查询余额代码失效的原因（不影响GPT的使用）。\r\n\r\n可查看代码是否有更新：\r\nhttps://gitee.com/lin2025/gpt3.5/ \r\nhttps://github.com/lin2025/gpt3.5/';
					const msg_en = "!! Failed to check the balance. The reasons for the failure are not clear, and the possibility of 'code malfunction' cannot be ruled out.(No impact on GPT usage) \r\n\r\nCheck for code updates:\r\nhttps://github.com/lin2025/gpt3.5/";
					const msg = window.currentlang == 'cn' ? msg_cn : msg_en ;
					alert(msg);
					return;
				}
				const subscriptionData = await response.json();

				// 判断是否过期
				const timestamp_now = Math.floor(Date.now() / 1000); //当前时间的时间戳
				const timestamp_expire = subscriptionData.access_until; //到期时间的时间戳
				if (timestamp_now > timestamp_expire) {
					const msg_cn = 'OpenAI API的账号余额似乎已到期, 但不排除仍然能用，请登录OpenAI进行查看。\r\n查询结果正在生成...';
					const msg_en = "It seems that the OpenAI API account balance has expired, but it is still possible that it can still be used. Please log in to OpenAI to check. \r\nQuery results are being generated...";
					const msg = window.currentlang == 'cn' ? msg_cn : msg_en ;
					alert(msg);
				}

				const totalAmount = subscriptionData.hard_limit_usd; //总额度 美元
				const is_subsrcibed = subscriptionData.has_payment_method; //是否绑卡用户
		  
				// 通过urlUsage接口链接获取使用量  本次统计范围为：90天前～今天  Default query for three months usage.( has_payment = false)
				response = await fetch(urlUsage, { headers }); 
				let usageData = await response.json(); // 用户过去90天的使用数据
				let totalUsage = usageData.total_usage / 100; // 用户的累计用量（90天），即消耗的总金额。除以100后 单位为美元
				
				let usageDataCurr; //未绑卡用户的本月使用数据
				let totalUsageCurr; //未绑卡用户的本月用量

				startDate = subDate ; // 开始时间改为本月第一天
				//ES6的写法 urlUsage = `https://api.openai.com/v1/dashboard/billing/usage?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`; // 新的时间 范围为本月
				urlUsage = 'https://api.openai.com/v1/dashboard/billing/usage?start_date=' + formatDate(startDate) + '&end_date=' + formatDate(endDate); // 新的时间 范围为本月 *兼容性更好 Support more browsers.
				
				//区别 1、如果用户绑了信用卡，额度每月会刷新，额度为本月额度。  2、如果用户未绑卡，则增加展示本月用量。
				if(is_subsrcibed) {
				    // 如果用户绑卡，累计用量数据变更为本月用量数据   通过urlUsage接口链接重获使用量  本次统计范围为：本月1日～今天
				    response = await fetch(urlUsage, {headers}); 
				    usageData = await response.json(); //绑卡用户本月使用数据
				    totalUsage = usageData.total_usage / 100; //绑卡用户本月用量
				}else{
					// 如果用户未绑卡，额外获取本月数据 ，比绑卡用户多展示一行数据  通过urlUsage接口链接获取本月使用量  本次统计范围为：本月1日～今天
					response = await fetch(urlUsage, {headers});
				    usageDataCurr = await response.json(); //本月使用数据
				    totalUsageCurr = usageDataCurr.total_usage / 100; //本月用量
				}
	
				// 计算剩余额度
				const remaining = totalAmount - totalUsage;

				// 数据说明：共9个参数，均为官方接口返回的信息，不必担心安全问题，无任何泄漏风险，不会以任何方式存储数据
				//  	来源官方接口1： https://api.openai.com/v1/dashboard/billing/subscription
				//  	来源官方接口2： https://api.openai.com/v1/dashboard/billing/usage?start_date=查询消耗金额的起始时间&end_date=查询消耗金额的结束时间
				// 数组序列如下：
				// 0 subscriptionData.account_name [账号归属/Account_Name]  
				// 1 is_subsrcibed  即subscriptionData.has_payment_method [是否绑卡/has_payment_method]  ？绑卡和购买Plus应该是两回事，绑卡使用API 不一定有订阅Plus 
				// 2 totalAmount  即subscriptionData.hard_limit_usd  [账号总额度/Total Amount] 
				// 3 totalUsage  即usageData.total_usage(需要除以100)  [已消耗金额/Total Usage] //绑卡用户为本月用量  非绑卡用户为历史累计用量
				// 4 remaining (通过计算得出) [可用额度/Remaining]
				// 5 timestamp_expire  即subscriptionData.access_until  [截止时间/Expiration Date] *时间戳格式
				// 6 subscriptionData.plan["title"]  plan-title 可能是账号分类/用途
				// 7 subscriptionData.plan["id"]   Plan-id [订阅情况/Subscription]
				// 8 totalUsageCurr 未绑卡用户的本月用量
				// 以上 数据说明
				
				//返回通过官网接口获取到的9个数据
          		return [subscriptionData.account_name, is_subsrcibed, totalAmount, totalUsage, remaining, timestamp_expire, subscriptionData.plan["title"], subscriptionData.plan["id"], totalUsageCurr ];
		  
			} catch (error) {
				isError = true;
				isCheckAPIKey = false;
				console.log(error);
				// Notification: Failed to check the balance. The reasons for the failure are not clear, and the possibility of "code malfunction" cannot be ruled out.(No impact on ChatGPT usage).
				const msg_cn = '!! 查询余额失败，存在多种可能，检查网络后重试，仍失败的话，请放弃查余额～ \r\n\r\nAPI-Key已验证成功，查询余额却失败，不排除是查询余额代码失效的原因（不影响GPT的使用）。\r\n\r\n可查看代码是否有更新：\r\nhttps://gitee.com/lin2025/gpt3.5/ \r\nhttps://github.com/lin2025/gpt3.5/';
				const msg_en = "!! Failed to check the balance. The reasons for the failure are not clear, and the possibility of 'code malfunction' cannot be ruled out.(No impact on GPT usage) \r\n\r\nCheck for code updates:\r\nhttps://github.com/lin2025/gpt3.5/";
				const msg = window.currentlang == 'cn' ? msg_cn : msg_en ;
				alert(msg);
				return [null, null, null, null, null, null, null, null, null]; //出错则返回9个空值
			}
		}
      

		//格式化日期
		function formatDate(date) {
			const year = date.getFullYear();
			const month = (date.getMonth() + 1).toString().padStart(2, '0');
			const day = date.getDate().toString().padStart(2, '0');
			//ES6写法： return `${year}-${month}-${day}`;
			return year + '-' + month + '-' + day;  // 兼容性更好。 Support more browsers.
		}


		//查询API-Key余额
		function sendRequest() {
		
			let msg_cn, msg_en, msg;
			//如果后台正在查询，那么提醒后返回，防止重复查询
			if(isCheckAPIKey){
				msg_cn = '已在为您查询OpenAI API的余额，请关闭弹窗后耐心等待。\r\n等待期间可进行其他操作，正常情况下数秒内完成，如等待时间过长，请检查下网络状态。';
				msg_en = "Your request is currently being processed. Please close the pop-up window and wait patiently.";
				msg = window.currentlang == 'cn' ? msg_cn : msg_en ;
				alert(msg);
				return;
			}
		  
			isCheckAPIKey = true;
			
			msg_cn = '将为您查询OpenAI API的账号余额，请先关闭本弹窗，待查询结果出来后会自动弹出。';
			msg_en = "After closing this pop-up window, the account balance of the API will be checked. The query result will automatically pop up when it is available.";
			msg = window.currentlang == 'cn' ? msg_cn : msg_en ;
			alert(msg);
		 
			//因为是在api-key验证成功后才能查询余额，所以此处无需判断api-key的有效性、格式是否正确等情况


		  	//连官网接口查询账号信息  传入网页上API-Key后开始查询
			checkBilling(document.querySelector('.inputapikey').value.trim()).then((data) => {
      
	  			//如果checkBilling已出错，就返回，避免重复报错。
				if ( isError && data[0] == null && data[1] == null){
					isCheckAPIKey = false; 
					return;
				}
				// 数据说明：共9个参数，均为官方接口返回的信息，不必担心安全问题，无任何泄漏风险，不会以任何方式存储数据
				//  	来源官方接口1： https://api.openai.com/v1/dashboard/billing/subscription
				//  	来源官方接口2： https://api.openai.com/v1/dashboard/billing/usage?start_date=查询消耗金额的起始时间&end_date=查询消耗金额的结束时间
				// 数组序列如下：
				// 0 subscriptionData.account_name [账号归属/Account_Name]  
				// 1 is_subsrcibed  即subscriptionData.has_payment_method [是否绑卡/has_payment_method]  
				// 2 totalAmount  即subscriptionData.hard_limit_usd  [账号总额度/Total Amount] 
				// 3 totalUsage  即usageData.total_usage(需要除以100)  [已消耗金额/Total Usage] //绑卡用户为本月用量  非绑卡用户为历史累计用量
				// 4 remaining (通过计算得出) [可用额度/Remaining]
				// 5 timestamp_expire  即subscriptionData.access_until  [截止时间/Expiration Date] *时间戳格式
				// 6 subscriptionData.plan["title"]  plan-title 可能是账号分类/用途
				// 7 subscriptionData.plan["id"]   Plan-id [订阅情况/Subscription]
				// 8 totalUsageCurr 未绑卡用户的本月用量
				// 以上 数据说明


				// 5-日期格式需要转换  5-到期时间/有效期/Expiration Date
				let date = new Date(data[5]* 1000);// data[5]为秒级时间戳，需要*1000转换为毫秒数
				let Y = date.getFullYear() + '-'; // 获取年份
				let M = String(date.getMonth() + 1).replace(/^(\d)$/, '0$1') + '-'; // 获取月份，注意月份是从 0 开始计数的，所以需要加 1
				let D = String(date.getDate()).replace(/^(\d)$/, '0$1') + ' '; // 获取日期
				let h = String(date.getHours()).replace(/^(\d)$/, '0$1') + ':'; // 获取小时
				let m = String(date.getMinutes()).replace(/^(\d)$/, '0$1') + ':'; // 获取分钟
				let s = String(date.getSeconds()).replace(/^(\d)$/, '0$1');  // 获取秒数
				data[5] = Y+M+D+h+m+s ;  // Y+M+D+h+m+s 样式：2023-04-26 10:58:30

				// 定义金额向右对齐后的字符串长度  chatgpt推荐使用padStart函数，为了兼容更多浏览器，让gpt换了方法
				let alignLength = 10;

				//声明变量
				let msgTop, msg0, msg1, msg2, msg3, msg4, msg5, msg6, msg7, msg8, msgBottom;

				//绑卡用户与非绑卡用户的不同  绑卡和购买Plus应该是两回事，绑卡使用API 不一定有订阅Plus 
				// * I don't have a payment account, so I can't verify the time range of data for payment users. However, hope the label is not wrong.
				if(data[1]) {
					//绑卡用户：后台绑定信用卡按量扣费的用户，不是每月固定扣费的Plus会员
					//  *根据网友的说法，绑卡后按月统计，根据API使用量扣费，理解如有误，请自行更改文本内容
					msg2 = window.currentlang == 'cn' ? '\r\n本月上限：  $' : '\r\nTotal Amount (M): $';  //TotalAmount per month
					msg3 = window.currentlang == 'cn' ? '\r\n实际消费：  $' : '\r\nTotal Usage (M): $'; //TotalUsage per month
					msg4 = window.currentlang == 'cn' ? '\r\n剩余限额：  $' : '\r\nRemaining (M): $'; //Remaining per month
					msg5 = window.currentlang == 'cn' ? '\r\n到期时间(?)：' : '\r\nExpiration Date(?): '; //ExpirationDate  绑卡用户是否有截止日期？ 月底？ per month??
					msg8 = window.currentlang == 'cn' ? '\r\n无' : '\r\nNone';  //null
				}else{
					//非绑卡用户：使用免费体验金的用户，历史统计数据
					msg2 = window.currentlang == 'cn' ? '\r\n账号总额：  $' : '\r\nTotal Amount: $';  //TotalAmount
					msg3 = window.currentlang == 'cn' ? '\r\n累计消耗：  $' : '\r\nTotal Usage: $'; //TotalUsage
					msg4 = window.currentlang == 'cn' ? '\r\n剩余额度：  $' : '\r\nRemaining: $'; //Remaining
					msg5 = window.currentlang == 'cn' ? '\r\n到期时间：  ' : '\r\nExpiration Date: ';  //ExpirationDate
					msg8 = (window.currentlang == 'cn' ? '\r\n本月消耗：  $' : '\r\nMonthly Usage: $')  + " ".repeat(alignLength - data[8].toFixed(4).length) + data[8].toFixed(4); //MonthlyUsage 仅未绑卡用户 取4位小数点，并向右对齐
				}

				//组合需要展示的数据
				msgTop = window.currentlang == 'cn' ? 'OpenAI API 账号余额查询结果\r\n\r\n' : 'OpenAI API Balance Query Result\r\n\r\n' ;  // OpenAI API account balance query result
				msg0 = (window.currentlang == 'cn' ? '账号归属：  ' : 'Account Name: ') + data[0]; // 注册OpenAI账号时填写的姓名  //AccountName
				msg1 = (window.currentlang == 'cn' ? '\r\n是否绑卡：  ' : '\r\nHas Payment: ') + (data[1] ? 'Yes' : 'No') ; //has_payment  绑卡和购买Plus应该是两回事，绑卡使用API 不一定有订阅Plus 
				msg2 = msg2 + " ".repeat(alignLength - data[2].toFixed(4).length) + data[2].toFixed(4); //取4位小数点，并向右对齐（计算需要补充的空格数量，在字符串前面添加空格）
				msg3 = msg3 + " ".repeat(alignLength - data[3].toFixed(4).length) + data[3].toFixed(4); //取4位小数点，并向右对齐 
				msg4 = msg4 + " ".repeat(alignLength - data[4].toFixed(4).length) + data[4].toFixed(4); //取4位小数点，并向右对齐
				msg5 = msg5 + data[5];
				msg6 = (window.currentlang == 'cn' ? '\r\n账号用途：  ' : '\r\nAbout Plan(?): ') + data[6]; // Plan-title 应该是注册时选择的注册目的、用途
				const freetext = window.currentlang == 'cn' ? '免费' : 'Free' ;
				msg7 = (window.currentlang == 'cn' ? '\r\n订阅情况：  ' : '\r\nSubscribe: ') + ( data[7] == 'free' ? freetext : data[7] );  //Plan-id  id等于free，则显示免费。 其他情况未知，显示原始值
				msg8 = msg8; 
				
				const str1 = window.currentlang == 'cn' ? '\r\n*非绑卡用户默认统计范围为90天。' : '\r\n*Default query for 90 days usage.(For Non-Payment users)' ;
				const str2 = window.currentlang == 'cn' ? "\r\n*绑卡用户返回的数据应该都只是当月的，但我没绑过卡无法验证统计范围。" : "\r\n*I don't have a payment account, so I can't verify the time range of data for payment users. However, hope the label is not wrong." ;
				const msg9 =  data[1] ? str2 : str1;
				
				
				const msgBottom_cn = '\r\n\r\n余额查询代码版本v4.27  \r\n以上信息均由官方接口返回，无泄漏风险，对当前已验证的API-Key实时查询，不会存储数据，API-Key随时可改。原理见代码，注释详尽。';
	  			const msgBottom_en = '\r\n\r\nBalance Inquiry Code Version v4.27  \r\nUse OpenAI API, real-time query, your data will not be saved, API-Key can be changed at any time. ';
				msgBottom = window.currentlang == 'cn' ? msgBottom_cn : msgBottom_en;
				
				isCheckAPIKey = false;

				//查询结果 弹窗
				if(data[1]){
					//绑卡用户的查询结果  后台绑定信用卡按量扣费的用户
					alert( msgTop + msg0 + msg1 + msg2 + msg3 + msg4 + msg5 + msg6 + msg7 + msgBottom + msg9 );
				}else{
					//非绑卡用户的查询结果  比绑卡用户多一行数据：msg8
					alert( msgTop + msg0 + msg1 + msg2  + msg8 + msg3 + msg4 + msg5 + msg6 + msg7 + msgBottom + msg9 );
				}			  

			}).catch((error) => {
				isCheckAPIKey = false;
				console.log(error);
				// Notification: Failed to check the balance. The reasons for the failure are not clear, and the possibility of "code malfunction" cannot be ruled out.(No impact on ChatGPT usage).
				const msg_cn = '!! 查询余额失败，存在多种可能，检查网络后重试，仍失败的话，请放弃查余额～ \r\n\r\nAPI-Key已验证成功，查询余额却失败，不排除是查询余额代码失效的原因（不影响GPT的使用）。\r\n\r\n可查看代码是否有更新：\r\nhttps://gitee.com/lin2025/gpt3.5/ \r\nhttps://github.com/lin2025/gpt3.5/';
				const msg_en = "!! Failed to check the balance. The reasons for the failure are not clear, and the possibility of 'code malfunction' cannot be ruled out.(No impact on GPT usage) \r\n\r\nCheck for code updates:\r\nhttps://github.com/lin2025/gpt3.5/";
				const msg = window.currentlang == 'cn' ? msg_cn : msg_en ;
				alert(msg);
			});
		}

//以上为[查询OpenAI API余额]的代码  Javascript code to check OpenAI API balances
</script>

<!-- 可修改 - 以下这两行是流量统计代码。请删除掉。 [Delete] Website traffic analysis. Please delete the following code  -->
<script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?45a1ecbb10a44dd4e1c1c1907eff38c0";var s=document.getElementsByTagName("script")[0];s.parentNode.appendChild(hm)})();</script>
<script>!function(p){"use strict";!function(t){var s=window,e=document,i=p,c="".concat("https:"===e.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),n=e.createElement("script"),r=e.getElementsByTagName("script")[0];n.type="text/javascript",n.setAttribute("charset","UTF-8"),n.async=!0,n.src=c,n.id="LA_COLLECT",i.d=n;var o=function(){s.LA.ids.push(i)};s.LA?s.LA.ids&&o():(s.LA=p,s.LA.ids=[],o()),r.parentNode.appendChild(n)}()}({id:"K1dyobSMgn13W0ov",ck:"K1dyobSMgn13W0ov"});</script>
<!-- 可修改 - 以上这两行是流量统计代码。请删除掉。 [Delete] Website traffic analysis. Please delete the above code  -->

</body>
</html>
